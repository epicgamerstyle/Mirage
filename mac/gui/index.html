<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luke's Mirage</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #141719;
            color: #c0c4c9;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            align-items: stretch;
            justify-content: center;
            zoom: 1.1;
        }

        /* (particle canvas removed) */

        .window {
            width: 100%;
            height: 100%;
            background: #191c1f;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        .window::-webkit-scrollbar { width: 4px; }
        .window::-webkit-scrollbar-track { background: transparent; }
        .window::-webkit-scrollbar-thumb { background: #23272c; border-radius: 2px; }

        /* ── Top progress bar ── */
        .top-progress {
            position: fixed;
            top: 0; left: 0;
            height: 2px;
            background: #10B685;
            z-index: 1000;
            transition: width 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        .top-progress.active {
            opacity: 1;
        }

        /* ── Combined Header + Tabs (single bar) ── */
        .header {
            display: flex;
            align-items: center;
            padding: 0 24px;
            height: 44px;
            background: #131619;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            flex-shrink: 0;
            gap: 0;
        }
        .header-left {
            display: flex; align-items: center; gap: 14px;
            flex-shrink: 0;
        }
        .header-brand {
            display: flex; align-items: center; gap: 8px;
        }
        .header-appname {
            font-size: 0.76rem; font-weight: 400;
            color: #60656a; letter-spacing: 0.005em;
        }
        .header-appname b { font-weight: 500; color: #80858a; }
        .header-version {
            font-size: 0.5rem; font-weight: 400;
            color: #2e3237; letter-spacing: 0.01em;
        }
        .header-sep {
            width: 1px; height: 16px;
            background: rgba(255,255,255,0.06);
            margin: 0 6px 0 10px;
            flex-shrink: 0;
        }
        .header-right {
            display: flex; align-items: center; gap: 10px;
            margin-left: auto;
        }

        .header-circle {
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: none; border: none; cursor: pointer; color: #505560;
            transition: all 0.15s;
        }
        .header-circle:hover { background: rgba(255,255,255,0.05); color: #70757a; }
        .header-circle svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }

        /* ── Tabs (inline within header) ── */
        .tabs {
            display: flex; gap: 0;
            position: relative;
            align-self: stretch;
            flex-shrink: 0;
            margin-left: 0;
        }
        .tab-btn {
            font-family: 'Raleway', 'Open Sans', sans-serif;
            font-size: 0.68rem; font-weight: 400;
            color: #4a4f54; background: none; border: none;
            padding: 0 16px; cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: color 0.2s;
            position: relative;
            display: flex; align-items: center;
            height: 100%;
        }
        .tab-btn:hover { color: #70757a; }
        .tab-btn.active { color: #b0b5ba; }
        /* Animated underline */
        .tab-indicator {
            position: absolute; bottom: -1px;
            height: 2px; background: #10B685;
            border-radius: 1px;
            transition: left 0.25s cubic-bezier(0.4, 0, 0.2, 1), width 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ── Page title strip ── */
        .page-title-strip {
            padding: 12px 32px 14px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .page-title-left {
            display: flex;
            align-items: baseline;
            gap: 10px;
            min-width: 0;
        }
        .page-title-heading {
            font-size: 0.82rem; font-weight: 500;
            color: #c0c4c9; letter-spacing: 0.005em;
            white-space: nowrap;
        }
        .page-title-sep {
            width: 1px; height: 12px;
            background: rgba(255,255,255,0.08);
            flex-shrink: 0;
            align-self: center;
        }
        .page-title-sub {
            font-size: 0.6rem; font-weight: 300;
            color: #505560; line-height: 1.4;
            white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
        }
        /* (page-title-step removed) */
        .page-title-right {
            display: flex; align-items: center; gap: 10px;
            flex-shrink: 0;
        }
        .page-title-right .stat-sep {
            width: 1px; height: 10px;
            background: rgba(255,255,255,0.06);
        }
        .hero-chip {
            display: flex; align-items: center; gap: 4px;
            font-size: 0.54rem; font-weight: 400;
            color: #50555a;
            padding: 0 2px;
        }
        .hero-chip .chip-val { color: #80858a; font-weight: 500; }

        /* ── Setup wizard mode ── */
        .setup-mode .header,
        .setup-mode .tabs,
        .setup-mode .page-title-strip,
        .setup-mode .content,
        .setup-mode .divider,
        .setup-mode .footer,
        .setup-mode .log { display: none !important; }

        /* Hide progress cards + setup hint after setup is complete */
        body.setup-done .steps-wrapper,
        body.setup-done .steps-label,
        body.setup-done .setup-hint { display: none !important; }

        /* Setup hero (only visible in setup mode) */
        .setup-hero { display: none; }
        .setup-mode .setup-hero {
            display: block;
            text-align: center;
            padding: 0 32px;
            margin-bottom: 56px;
        }
        .setup-hero-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #d0d4d9;
            margin-bottom: 6px;
        }
        .setup-hero-sub {
            font-size: 0.62rem;
            color: #505560;
            line-height: 1.5;
        }

        .setup-mode .steps-label {
            display: none;
        }

        /* During setup: connector track is hidden by default via JS.
           When JS shows it, make the gray rail invisible — only the green fill shows. */
        .setup-mode .steps-connector {
            background: transparent !important;
        }

        /* Center the setup content vertically */
        .setup-mode .window {
            justify-content: center;
        }

        .setup-mode .steps-wrapper {
            padding: 0 32px 32px;
        }
        .setup-mode .step-card {
            padding: 14px 10px 84px;
        }
        .setup-mode .step-card .step-action {
            position: absolute;
            bottom: 6px;
            left: 0;
            right: 0;
            margin-top: 0;
        }
        .setup-mode .step-visual {
            width: 36px; height: 36px;
            margin-bottom: 6px;
        }
        .setup-mode .step-card.waiting {
            opacity: 0.3;
            pointer-events: none;
        }
        .setup-mode .step-card.current {
            transform: translateY(-6px);
            box-shadow: 0 12px 48px rgba(0,0,0,0.3), 0 0 0 1px rgba(16,182,133,0.08);
        }
        .setup-mode .step-badge,
        .setup-mode .step-current-label { display: none !important; }
        .setup-mode .step-time { display: none; }

        /* Setup hint under progress cards */
        .setup-hint {
            display: none;
            text-align: center;
            font-family: 'Raleway', 'Open Sans', sans-serif;
            font-size: 0.54rem;
            color: #494e53;
            padding: 14px 24px 0;
            line-height: 1.5;
            letter-spacing: 0.01em;
        }
        .setup-mode .setup-hint { display: block; }

        /* Step action area (setup wizard only) */
        .step-action {
            margin-top: 8px;
            display: none;
        }
        .setup-mode .step-card.current .step-action,
        .setup-mode .step-card.completed .step-action {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 100%;
        }

        .step-status {
            font-size: 0.58rem;
            color: #606569;
            text-align: center;
            line-height: 1.5;
            min-height: 20px;
            word-break: break-word;
            padding: 0 4px;
            margin-top: 6px;
        }
        .step-status.is-checklist {
            text-align: left;
            padding: 0;
        }
        .step-status .status-ok { color: #10B685; }
        .step-status .status-fail { color: #e05545; }

        .step-check-summary {
            font-size: 0.56rem;
            margin-bottom: 4px;
            text-align: center;
            color: #606569;
        }
        .step-check-summary.ok { color: #10B685; }
        .step-check-summary.fail { color: #e05545; }
        .step-checks {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .step-check {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 3px 6px;
            border-radius: 4px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.04);
        }
        .step-check.ok {
            border-color: rgba(16,182,133,0.18);
            background: rgba(16,182,133,0.05);
        }
        .step-check.fail {
            border-color: rgba(224,85,69,0.18);
            background: rgba(224,85,69,0.05);
        }
        .step-check-icon {
            font-size: 0.55rem;
            font-weight: 700;
            line-height: 1;
            flex-shrink: 0;
        }
        .step-check.ok .step-check-icon { color: #10B685; }
        .step-check.fail .step-check-icon { color: #e05545; }
        .step-check-label {
            font-size: 0.52rem;
            color: #9aa0a6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .step-check-meta {
            display: none;
        }

.step-status .spinner {
            display: inline-block;
            width: 10px; height: 10px;
            border: 1.5px solid #10B685;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .step-browse-btn {
            font-family: 'Raleway', 'Open Sans', sans-serif;
            font-size: 0.6rem; font-weight: 500;
            padding: 7px 16px; border-radius: 6px;
            background: rgba(16,182,133,0.06);
            color: #10B685;
            border: 1px solid rgba(16,182,133,0.2);
            cursor: pointer;
            transition: all 0.15s;
            margin-top: 8px;
        }
        .step-browse-btn:hover {
            background: rgba(16,182,133,0.1);
            border-color: rgba(16,182,133,0.25);
        }
        /* ── Download / Own Source split option cards ── */
        .step-action-split {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 0;
            margin-top: 6px;
            width: 100%;
        }
        .step-split-divider {
            width: 1px;
            align-self: stretch;
            margin: 6px 0;
            background: linear-gradient(
                to bottom,
                transparent,
                rgba(16,182,133,0.25) 30%,
                rgba(16,182,133,0.25) 70%,
                transparent
            );
        }
        .step-action-single {
            grid-template-columns: 1fr;
            justify-items: center;
        }
        .step-split-btn {
            font-family: 'Raleway', 'Open Sans', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 14px 6px 12px;
            border-radius: 6px;
            background: transparent;
            color: #6b7076;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .step-split-btn:hover {
            color: #b0b5ba;
        }
        .step-split-btn:active {
            transform: translateY(0);
        }
        .step-split-btn:disabled {
            opacity: 0.35;
            cursor: default;
            transform: none;
        }
        .step-split-icon {
            width: 20px; height: 20px;
            opacity: 0.5;
        }
        .step-split-icon svg {
            width: 100%; height: 100%;
            fill: none; stroke: currentColor;
            stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round;
        }
        .step-split-btn:hover .step-split-icon { opacity: 0.8; }
        .step-split-label {
            font-size: 0.5rem;
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        /* Download button progress bar overlay */
        .dl-btn-progress {
            position: absolute;
            bottom: 0; left: 0;
            height: 2px;
            width: 0%;
            background: #10B685;
            transition: none;
        }

        /* Clone modal */
        /* ── Modal — Linear Issue Tracker ── */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.2s ease-out;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-box {
            background: #161a1d;
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 5px;
            width: 660px;
            max-width: 94vw;
            box-shadow:
                0 0 0 1px rgba(0,0,0,0.4),
                0 24px 64px rgba(0,0,0,0.5),
                0 48px 100px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.22s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(14px) scale(0.97); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* ── Top bar: breadcrumb + close ── */
        .modal-topbar {
            display: none;
        }
        .modal-breadcrumb {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.65rem;
            color: #4b5060;
        }
        .modal-breadcrumb-icon { display: none; }
        .modal-breadcrumb-label { display: none; }
        .modal-breadcrumb-sep { display: none; }
        .modal-breadcrumb-page { display: none; }
        .modal-topbar-actions {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .modal-topbar-btn {
            width: 30px; height: 30px;
            border-radius: 5px;
            border: none;
            background: transparent;
            color: #454b58;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.12s;
        }
        .modal-topbar-btn:hover {
            background: rgba(255,255,255,0.05);
            color: #7a808a;
        }
        .modal-topbar-btn svg { width: 15px; height: 15px; }

        /* ── Header (title area) ── */
        .modal-header { display: none; }
        .modal-header-left { display: none; }
        .modal-icon { display: none; }
        .modal-close { display: none; }
        .modal-divider { display: none; }
        .modal-title-area {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 18px 20px 14px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.035);
        }
        .modal-title {
            font-size: 1.35rem;
            font-weight: 600;
            color: #d0d4d9;
            letter-spacing: -0.025em;
            line-height: 1.3;
        }
        .modal-subtitle {
            font-size: 0.7rem;
            color: #4b5060;
            margin-top: 0;
            line-height: 1.5;
            font-weight: 400;
        }

        /* ── Source file card (like attachment) ── */
        .modal-source-card {
            margin: 14px 24px 0;
            padding: 12px 16px;
            border-radius: 5px;
            background: rgba(255,255,255,0.025);
            border: 1px solid rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .modal-source-icon {
            width: 36px; height: 36px;
            border-radius: 5px;
            background: rgba(255,255,255,0.04);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .modal-source-icon svg { width: 18px; height: 18px; }
        .modal-source-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .modal-source-name {
            font-size: 0.78rem;
            font-weight: 600;
            color: #d0d4da;
            font-family: 'Open Sans', sans-serif;
        }
        .modal-source-meta {
            font-size: 0.6rem;
            color: #454b58;
        }

        /* ── Description text (hidden) ── */
        .modal-desc {
            display: none;
        }

        /* ── Tags / pills row (hidden) ── */
        .modal-tags {
            display: none;
            gap: 8px;
            padding: 14px 24px 0;
            flex-wrap: wrap;
        }
        .modal-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.6rem;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.07);
            background: rgba(255,255,255,0.03);
            color: #8a90a0;
        }
        .modal-tag-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* ── Section header (like "Sub-issues") ── */
        .modal-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            margin-top: 16px;
            margin-bottom: 0;
        }
        .modal-section-label {
            font-size: 0.68rem;
            font-weight: 500;
            color: #4b5060;
        }
        .modal-section-action {
            font-size: 0.72rem;
            color: #333843;
            cursor: pointer;
            width: 24px; height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: none;
            background: none;
            transition: all 0.12s;
        }
        .modal-section-action:hover {
            background: rgba(255,255,255,0.05);
            color: #6b7280;
        }
        .modal-section-divider {
            height: 1px;
            background: rgba(255,255,255,0.05);
            margin: 10px 24px 0;
        }

        /* ── Body (hidden in Linear layout — content is placed directly) ── */
        .modal-body {
            padding: 0;
        }
        .modal-form-row { margin-bottom: 16px; }
        .modal-label {
            display: block;
            font-size: 0.68rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 14px;
            padding: 0 24px;
        }
        .modal-input { width: 100%; box-sizing: border-box; }
        .modal-hint {
            display: none;
        }

        /* ── Info chips (hidden in Linear layout — replaced by source card + tags) ── */
        .modal-info-row { display: none; }
        .modal-info-chip { display: none; }
        .modal-info-label { display: none; }
        .modal-info-value { display: none; }
        .modal-info-value.accent { color: #10B685; }

        /* ── Clone checklist (borderless, full-width rows) ── */
        .modal-clone-list {
            max-height: 220px;
            overflow-y: auto;
            border: none;
            border-radius: 0;
            background: transparent;
            margin-top: 2px;
        }
        .modal-clone-list::-webkit-scrollbar { width: 4px; }
        .modal-clone-list::-webkit-scrollbar-track { background: transparent; }
        .modal-clone-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 2px; }
        /* Custom checkbox — thin green checkmark */
        .modal-check {
            position: relative;
            width: 18px; height: 18px;
            flex-shrink: 0;
            cursor: pointer;
        }
        .modal-check input {
            position: absolute;
            opacity: 0;
            width: 100%; height: 100%;
            margin: 0;
            cursor: pointer;
            z-index: 2;
        }
        .modal-check-mark {
            position: absolute;
            inset: 0;
            border-radius: 5px;
            border: 1.5px solid rgba(255,255,255,0.12);
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-check-mark svg {
            width: 11px; height: 11px;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.15s ease;
        }
        .modal-check input:checked + .modal-check-mark {
            border-color: transparent;
            background: none;
        }
        .modal-check input:checked + .modal-check-mark svg {
            opacity: 1;
            transform: scale(1);
        }
        .modal-check:hover .modal-check-mark {
            border-color: rgba(255,255,255,0.2);
        }
        .modal-check input:checked:hover + .modal-check-mark {
            border-color: transparent;
        }

        .modal-select-all {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 11px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            background: transparent;
        }
        .modal-select-all label {
            font-size: 0.65rem;
            font-weight: 500;
            color: #5a6070;
            cursor: pointer;
            user-select: none;
        }
        .modal-clone-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 11px 24px 11px 44px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            cursor: pointer;
            transition: background 0.1s;
        }
        .modal-clone-item:last-child { border-bottom: none; }
        .modal-clone-item:hover { background: rgba(255,255,255,0.02); }
        .modal-clone-name {
            font-size: 0.72rem;
            font-family: 'Raleway', 'Open Sans', sans-serif;
            font-weight: 400;
            color: #b8bdc5;
            flex: 1;
        }
        .modal-clone-tag { display: none; }

        /* ── Status area ── */
        .modal-status {
            padding: 14px 24px;
            background: rgba(16,182,133,0.03);
            border-top: 1px solid rgba(16,182,133,0.06);
            margin-top: 0;
            border-radius: 0;
            border-left: none;
            border-right: none;
            border-bottom: none;
        }
        .modal-status-text {
            font-size: 0.65rem;
            color: #9da3ae;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ── Footer ── */
        .modal-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            padding: 14px 24px;
            background: rgba(255,255,255,0.018);
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        .modal-footer-left { display: none; }
        .modal-footer-icon { display: none; }
        .modal-btn-secondary {
            background: transparent;
            border: none;
            color: #5a6070;
            font-size: 0.68rem;
            font-weight: 500;
            padding: 8px 18px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.12s;
        }
        .modal-btn-secondary:hover {
            background: rgba(255,255,255,0.04);
            color: #8a8f98;
        }
        .modal-btn-primary {
            font-size: 0.68rem !important;
            font-weight: 500 !important;
            padding: 9px 22px !important;
            border-radius: 3px !important;
            background: transparent !important;
            color: #8a8f94 !important;
            border: 1.5px solid rgba(255,255,255,0.1) !important;
            transition: color 0.2s, border-color 0.2s, background 0.2s !important;
        }
        .modal-btn-primary:hover:not(:disabled) {
            color: #b0b5ba !important;
            border-color: rgba(255,255,255,0.16) !important;
            background: rgba(255,255,255,0.02) !important;
            box-shadow: none !important;
        }
        .modal-btn-primary:active:not(:disabled) {
            background: rgba(255,255,255,0.04) !important;
        }
        .modal-btn-primary:disabled {
            display: none !important;
        }
        .modal-btn-working {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 9px 22px;
        }

        /* ── Download modal — version selection cards ── */
        /* ── Download modal — split panel ── */
        .dl-split {
            display: flex;
            width: 100%;
        }
        .dl-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 28px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .dl-panel:hover {
            background: rgba(255,255,255,0.02);
        }
        .dl-panel:only-child {
            border-right: none;
        }
        .dl-panel-logos {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dl-logo-bs,
        .dl-logo-android {
            height: 34px;
            width: auto;
            filter: grayscale(1) brightness(0.8);
            transition: filter 0.3s ease;
        }
        .dl-panel:hover .dl-logo-bs,
        .dl-panel:hover .dl-logo-android {
            filter: grayscale(0.45) brightness(0.9);
        }
        .dl-logo-x {
            font-size: 0.7rem;
            font-weight: 400;
            color: #606468;
            user-select: none;
            letter-spacing: 0.5px;
            transition: color 0.3s ease;
        }
        .dl-panel:hover .dl-logo-x {
            color: #8a8f94;
        }
        .dl-panel-label {
            font-size: 0.72rem;
            font-weight: 500;
            color: #c0c4c9;
            margin-top: 12px;
            letter-spacing: 0.2px;
        }
        .dl-panel-meta {
            font-size: 0.58rem;
            color: #505560;
            margin-top: 2px;
        }
        .dl-panel.dl-done {
            opacity: 0.5;
            pointer-events: none;
        }
        .dl-panel.dl-done .dl-panel-label::after {
            content: ' ✓';
            color: #10B685;
        }

        /* ── Clone modal — flat enterprise SaaS ── */
        .clone-subtitle {
            font-size: 0.64rem;
            color: #4a4f58;
            font-weight: 400;
            margin-top: 3px;
            line-height: 1.45;
        }

        /* Section containers */
        .adv-clone-section {
            padding: 16px 24px;
        }
        .adv-clone-section + .adv-clone-section {
            border-top: 1px solid rgba(255,255,255,0.035);
        }
        .adv-clone-section-label {
            font-size: 0.52rem;
            font-weight: 600;
            color: #4a4f58;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }

        /* Source select */
        .adv-clone-source-bar {
            padding: 14px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.035);
        }
        .adv-clone-source-label {
            font-size: 0.52rem;
            font-weight: 600;
            color: #4a4f58;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 6px;
            display: block;
        }
        .adv-clone-source-bar select {
            width: 100%;
            background: #1c1f23;
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 4px;
            color: #c0c4c9;
            font-size: 0.72rem;
            padding: 8px 10px;
            outline: none;
            font-family: inherit;
            cursor: pointer;
            transition: border-color 0.15s;
            -webkit-appearance: none;
            appearance: none;
        }
        .adv-clone-source-bar select:hover {
            border-color: rgba(255,255,255,0.1);
        }
        .adv-clone-source-bar select:focus {
            border-color: rgba(16,182,133,0.35);
        }
        .adv-clone-source-bar select option {
            background: #1c1f23;
            color: #c0c4c9;
        }

        /* Mode toggle — segmented control */
        .adv-clone-mode-bar {
            display: flex;
            padding: 0 24px 0;
            border-bottom: 1px solid rgba(255,255,255,0.035);
        }
        .adv-clone-mode-btn {
            flex: 1;
            border: none;
            background: transparent;
            color: #4a4f58;
            font-family: inherit;
            font-size: 0.62rem;
            font-weight: 500;
            letter-spacing: 0.02em;
            padding: 10px 0;
            cursor: pointer;
            transition: color 0.15s;
            position: relative;
            text-align: center;
        }
        .adv-clone-mode-btn::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0; right: 0;
            height: 2px;
            background: transparent;
            transition: background 0.2s;
        }
        .adv-clone-mode-btn:hover {
            color: #80858c;
        }
        .adv-clone-mode-btn.active {
            color: #c0c4c9;
        }
        .adv-clone-mode-btn.active::after {
            background: #10B685;
        }
        /* Panels */
        .adv-clone-panel {
            max-height: 280px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.06) transparent;
        }
        .adv-clone-panel[hidden] { display: none !important; }
        .adv-clone-panel::-webkit-scrollbar { width: 3px; }
        .adv-clone-panel::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.06);
            border-radius: 2px;
        }

        /* Replace targets list */
        .adv-clone-targets {
            min-height: 100px;
        }
        .adv-clone-target-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.025);
            cursor: pointer;
            transition: background 0.1s;
        }
        .adv-clone-target-item:last-child { border-bottom: none; }
        .adv-clone-target-item:hover {
            background: rgba(255,255,255,0.015);
        }
        .adv-clone-target-item.is-source {
            opacity: 0.3;
            pointer-events: none;
        }
        .adv-clone-target-name {
            font-size: 0.7rem;
            font-weight: 400;
            color: #b0b5ba;
        }
        .adv-clone-target-meta {
            font-size: 0.56rem;
            color: #3a3f48;
            margin-left: auto;
        }
        .adv-clone-target-hint {
            padding: 12px 24px;
            font-size: 0.58rem;
            color: #33383d;
            text-align: center;
        }

        /* Create new panel */
        .adv-clone-new-wrap {
            padding: 14px 24px 16px;
        }
        .adv-clone-new-grid {
            display: grid;
            grid-template-columns: 1fr 80px auto;
            gap: 8px;
            align-items: end;
            margin-bottom: 10px;
        }
        .adv-clone-new-field label {
            display: block;
            font-size: 0.52rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #4a4f58;
            margin-bottom: 5px;
        }
        .adv-clone-new-field input {
            width: 100%;
            box-sizing: border-box;
            background: #1c1f23;
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 4px;
            color: #c0c4c9;
            font-size: 0.7rem;
            padding: 8px 10px;
            outline: none;
            font-family: inherit;
            transition: border-color 0.15s;
        }
        .adv-clone-new-field input::placeholder {
            color: #33383d;
        }
        .adv-clone-new-field input:focus {
            border-color: rgba(16,182,133,0.35);
        }
        .adv-clone-new-btn {
            align-self: end;
            height: 32px;
            padding: 0 12px;
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 4px;
            background: #1c1f23;
            color: #70757c;
            font-family: inherit;
            font-size: 0.58rem;
            font-weight: 500;
            letter-spacing: 0.03em;
            cursor: pointer;
            transition: all 0.12s;
        }
        .adv-clone-new-btn:hover {
            border-color: rgba(255,255,255,0.1);
            color: #a0a5ac;
        }
        .adv-clone-entries {
            max-height: 240px;
            overflow-y: auto;
            margin-top: 2px;
        }
        .adv-clone-entries::-webkit-scrollbar { width: 3px; }
        .adv-clone-entries::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.06); border-radius: 3px;
        }
        .adv-clone-entry-header {
            display: grid;
            grid-template-columns: 1fr 1fr 28px;
            gap: 8px;
            padding: 0 0 6px;
            align-items: end;
        }
        .adv-clone-entry-header span {
            font-size: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #4a4f58;
        }
        .adv-clone-entry-row {
            display: grid;
            grid-template-columns: 1fr 1fr 28px;
            gap: 8px;
            align-items: center;
            padding: 4px 0;
        }
        .adv-clone-entry-row + .adv-clone-entry-row {
            border-top: 1px solid rgba(255,255,255,0.025);
        }
        .adv-clone-entry-row input {
            width: 100%;
            box-sizing: border-box;
            background: #1c1f23;
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 4px;
            color: #c0c4c9;
            font-size: 0.64rem;
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            padding: 7px 9px;
            outline: none;
            transition: border-color 0.15s;
        }
        .adv-clone-entry-row input:focus {
            border-color: rgba(16,182,133,0.35);
        }
        .adv-clone-entry-row input::placeholder {
            color: #33383d;
        }
        .adv-clone-entry-row input.entry-engine {
            color: #5a5f66;
            background: #181b1e;
            cursor: default;
        }
        .adv-clone-entry-row input.entry-engine:focus {
            border-color: rgba(255,255,255,0.06);
        }
        .adv-clone-entry-remove {
            width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            background: none; border: none; cursor: pointer;
            color: #3a3f48; border-radius: 4px;
            transition: color 0.12s, background 0.12s;
            padding: 0;
        }
        .adv-clone-entry-remove:hover {
            color: #e05252; background: rgba(224,82,82,0.08);
        }
        .adv-clone-entry-remove svg {
            width: 13px; height: 13px;
        }
        .adv-clone-no-entries {
            text-align: center;
            padding: 28px 0;
            color: #33383d;
            font-size: 0.6rem;
        }
        .adv-clone-new-hint {
            margin-top: 6px;
            font-size: 0.54rem;
            color: #3a3f48;
            line-height: 1.5;
        }
        .adv-clone-new-hint code {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-size: 0.52rem;
            color: #505860;
            background: rgba(255,255,255,0.03);
            padding: 1px 4px;
            border-radius: 3px;
        }
        @media (max-width: 560px) {
            .adv-clone-new-grid {
                grid-template-columns: 1fr;
            }
            .adv-clone-new-btn { width: 100%; }
        }
        /* (old clone-opts, stepper, hint styles removed — adv clone modal redesigned) */

        /* Setup → workspace transition */
        .wizard-fade-out {
            animation: fadeOutUp 0.45s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        @keyframes fadeOutUp {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-24px); }
        }
        .workspace-reveal {
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ── Tooltip system ── */
        .tooltip-trigger {
            position: relative;
            display: inline-flex;
            align-items: center; justify-content: center;
            width: 14px; height: 14px;
            border-radius: 50%;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            font-size: 0.5rem; font-weight: 600;
            color: #505560;
            cursor: help;
            margin-left: 6px;
            transition: all 0.15s;
            flex-shrink: 0;
        }
        .tooltip-trigger:hover {
            background: rgba(16,182,133,0.08);
            border-color: rgba(16,182,133,0.2);
            color: #10B685;
        }
        .tooltip-text {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #23272c;
            color: #b0b5ba;
            font-size: 0.58rem; font-weight: 400;
            line-height: 1.5;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.08);
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s, transform 0.15s;
            z-index: 1000;
            box-shadow: 0 6px 20px rgba(0,0,0,0.35);
        }
        .tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%; left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #23272c;
        }
        .tooltip-trigger:hover .tooltip-text {
            opacity: 1;
            transform: translateX(-50%) translateY(-3px);
        }

        /* ── Helper hints ── */
        .helper-hint {
            font-size: 0.54rem;
            color: #4a4f54;
            font-weight: 300;
            margin-left: 6px;
            transition: opacity 0.3s;
        }
        .helper-hint.fade {
            opacity: 0;
            pointer-events: none;
        }

        /* ── Steps ── */
        .steps-label {
            font-size: 0.54rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.03em;
            color: #40454a; padding: 0 32px;
            margin-bottom: 10px; flex-shrink: 0;
        }
        .steps-wrapper {
            position: relative;
            padding: 0 32px 16px;
            flex-shrink: 0;
        }
        /* Connector line behind cards */
        .steps-connector {
            position: absolute;
            top: 48px;
            /* Start/end at center of first/last card in a 4-col centered grid */
            left: 50%;
            transform: translateX(-50%);
            width: calc(960px * 0.75 - 14px);
            max-width: calc(100% - 64px - 12.5% * 2);
            height: 2px;
            background: rgba(255,255,255,0.03);
            z-index: 0;
            border-radius: 1px;
        }
        .steps-connector-fill {
            height: 100%;
            background: #10B685;
            border-radius: 1px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .steps-connector-fill::after {
            content: '';
            position: absolute;
            right: 0; top: -3px;
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #10B685;
        }
        .steps-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            align-items: stretch;
            gap: 8px;
            position: relative;
            z-index: 1;
            max-width: 1100px;
            margin: 0 auto;
        }
        .step-card {
            background: #23272c;
            border-radius: 5px;
            padding: 16px 10px 14px;
            text-align: center;
            position: relative;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s, background 0.3s, border-color 0.3s;
            border: 1px solid transparent;
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
        }
        .step-card:hover:not(.locked) {
            transform: translateY(-3px);
            box-shadow: 0 6px 24px rgba(0,0,0,0.2);
        }
        .step-card.completed {
            background: #22262b;
            border-color: rgba(13,138,96,0.1);
        }
        .step-card.completed:hover {
            border-color: rgba(13,138,96,0.2);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        .step-card.current {
            background: #2a2e32;
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            border-color: rgba(16,182,133,0.1);
        }
        .step-card.current:hover {
            transform: translateY(-5px);
        }
        .step-card.locked {
            background: #1d2024;
            opacity: 0.4;
        }

        .step-current-label {
            position: absolute; top: -18px;
            left: 0; right: 0; text-align: center;
            font-size: 0.48rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.03em;
            color: #505560; display: none;
        }
        .step-card.current .step-current-label { display: block; }

        .step-badge {
            position: absolute; top: -8px; left: 50%;
            transform: translateX(-50%);
            font-size: 0.5rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.03em;
            padding: 3px 10px; border-radius: 5px;
            display: none;
        }
        .step-card.current .step-badge {
            display: block;
            background: rgba(16,182,133,0.12); color: #10B685;
        }

        .step-time {
            font-size: 0.5rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.04em;
            color: #4a4f54; margin-bottom: 12px;
        }
        .step-card.completed .step-time { color: #c0c4c9; }
        .step-card.current .step-time { color: #10B685; }

        /* Icon area — NO background box, just the icon */
        .step-visual {
            width: 44px; height: 44px;
            margin: 0 auto 8px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            position: relative;
            overflow: hidden;
            background: transparent;
        }
        .step-visual svg {
            width: 22px; height: 22px; fill: none;
            stroke: #505560;
            stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round;
        }
        .step-card.completed .step-visual svg { stroke: #10B685; }
        .step-card.current .step-visual svg { stroke: #8a9098; }
        .step-card.locked .step-visual svg { stroke: #2e3237; }

        /* Lottie container inside step-visual */
        .lottie-icon {
            position: absolute; inset: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .lottie-icon svg { width: 26px !important; height: 26px !important; }

        .step-title {
            font-size: 0.68rem; font-weight: 500;
            color: #8a8f94; margin-bottom: 2px;
            line-height: 1.3; letter-spacing: 0.01em;
        }
        .step-card.current .step-title { color: #b0b5ba; }
        .step-card.locked .step-title { color: #4a4f54; }
        .step-desc {
            font-size: 0.54rem; color: #4a4f54;
            line-height: 1.4; letter-spacing: 0.01em;
            margin-bottom: 24px;
        }
        .step-card.current .step-desc { color: #555a60; }
        .step-card.locked .step-desc { color: #2e3237; }

        /* ── Download & Clone tab ── */
        .dl-card {
            display: flex;
            align-items: center;
            gap: 16px;
            background: #22262b;
            border: 1px solid rgba(255,255,255,0.04);
            border-radius: 5px;
            padding: 18px 20px;
            margin-bottom: 16px;
            transition: border-color 0.2s;
        }
        .dl-card:hover { border-color: rgba(16,182,133,0.15); }
        .dl-card-icon {
            flex-shrink: 0;
            width: 48px; height: 48px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(16,182,133,0.08);
            border-radius: 5px;
        }
        .dl-card-text { flex: 1; min-width: 0; }
        .dl-card-title {
            font-size: 0.78rem; font-weight: 500;
            color: #c0c4c9; margin-bottom: 3px;
        }
        .dl-card-desc {
            font-size: 0.6rem; font-weight: 300;
            color: #505560; line-height: 1.45;
        }
        .dl-progress-wrap {
            margin-bottom: 16px;
            display: flex; align-items: center; gap: 12px;
        }
        .dl-progress-bar {
            flex: 1; height: 4px;
            background: #23272c;
            border-radius: 2px;
            overflow: hidden;
        }
        .dl-progress-fill {
            height: 100%;
            background: #10B685;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .dl-progress-text {
            font-size: 0.56rem; font-weight: 400;
            color: #505560;
            white-space: nowrap;
        }

        /* ── Divider ── */
        .divider {
            height: 1px;
            background: rgba(255,255,255,0.04);
            margin: 0 32px; flex-shrink: 0;
        }

        /* ── Content ── */
        .content {
            padding: 14px 32px 22px;
            flex: 1 1 auto;
            overflow-y: auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        .content::-webkit-scrollbar { width: 4px; }
        .content::-webkit-scrollbar-track { background: transparent; }
        .content::-webkit-scrollbar-thumb { background: #23272c; border-radius: 2px; }

        /* ── Tab panes ── */
        .tab-pane {
            display: none;
            animation: paneIn 0.25s ease-out;
        }
        .tab-pane.active {
            display: flex;
            flex-direction: column;
            flex: 1;
            justify-content: flex-start;
        }
        #pane-advanced.tab-pane.active {
            justify-content: center;
        }
        @keyframes paneIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ── Paths ── */
        .paths {
            display: flex; gap: 10px; margin-bottom: 22px;
        }
        .path-field {
            flex: 1; display: flex; align-items: center;
            background: #22262b; border-radius: 5px;
            padding: 0 12px; height: 34px;
            border: 1px solid transparent;
            transition: border-color 0.15s;
        }
        .path-field:hover { border-color: rgba(255,255,255,0.04); }
        .path-label {
            font-size: 0.56rem; font-weight: 500; color: #4a4f54;
            text-transform: uppercase; letter-spacing: 0.04em;
            margin-right: 10px; flex-shrink: 0;
        }
        .path-value {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.64rem; color: #606569;
            flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .path-browse {
            font-family: 'Raleway', 'Open Sans', sans-serif;
            font-size: 0.56rem; font-weight: 500; color: #606569;
            background: transparent; border: none; cursor: pointer;
            padding: 3px 8px; border-radius: 4px; transition: all 0.12s;
        }
        .path-browse:hover { background: rgba(255,255,255,0.04); color: #80858a; }

        /* ── Section label ── */
        .section-label {
            font-size: 0.62rem; font-weight: 400; color: #4a4f54;
            margin-bottom: 10px; letter-spacing: 0.01em;
        }
        .section-label .count { color: #606569; }

        /* ── Table ── */
        .table { margin-bottom: 14px; }
        .table-head {
            display: grid; padding: 0 16px 7px;
        }
        .table-head span {
            font-size: 0.5rem; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.03em; color: #2e3237;
        }
        .table-body {
            background: #23272c;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.02);
        }
        .row {
            display: grid;
            padding: 10px 16px; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.025);
            cursor: pointer; transition: all 0.12s;
            position: relative;
        }
        .row:last-child { border-bottom: none; }
        .row:hover { background: rgba(255,255,255,0.02); }
        .row.selected { background: rgba(16,182,133,0.04); }
        /* Left accent bar on selected rows */
        .row::before {
            content: '';
            position: absolute; left: 0; top: 0; bottom: 0;
            width: 2px; background: #10B685;
            transform: scaleY(0);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0 1px 1px 0;
        }
        .row.selected::before { transform: scaleY(1); }

        /* Grid layouts for different tabs */
        .randomize-grid .table-head,
        .randomize-grid .row {
            grid-template-columns: 30px 1.4fr 0.7fr 1fr 0.7fr;
        }
        .clone-grid .table-head,
        .clone-grid .row {
            grid-template-columns: 30px 1.4fr 0.7fr 1fr;
        }

        .checkbox {
            width: 15px; height: 15px; border-radius: 3px;
            border: 1.5px solid rgba(255,255,255,0.08);
            position: relative; transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .row.selected .checkbox {
            background: #10B685; border-color: #10B685;
        }
        .row.selected .checkbox::after {
            content: ''; position: absolute;
            top: 2px; left: 4.5px; width: 4px; height: 7px;
            border: solid #191c1f; border-width: 0 1.5px 1.5px 0;
            transform: rotate(45deg);
        }

        .radio {
            width: 15px; height: 15px; border-radius: 50%;
            border: 1.5px solid rgba(255,255,255,0.08);
            position: relative; transition: all 0.1s;
            display: flex; align-items: center; justify-content: center;
        }
        .row.selected .radio { border-color: #10B685; }
        .row.selected .radio::after {
            content: ''; position: absolute;
            width: 7px; height: 7px; border-radius: 50%;
            background: #10B685;
        }

        .cell-name {
            font-size: 0.74rem; font-weight: 400; color: #8a8f94;
            display: flex; align-items: center; gap: 7px;
        }
        .badge {
            font-size: 0.46rem; font-weight: 500; color: #505560;
            background: rgba(255,255,255,0.03); padding: 2px 6px;
            border-radius: 3px; text-transform: uppercase; letter-spacing: 0.03em;
        }
        .cell-port {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.64rem; color: #4a4f54;
        }
        .cell-display { font-size: 0.7rem; color: #505560; }
        .cell-status { display: flex; align-items: center; gap: 6px; }
        .dot { width: 6px; height: 6px; border-radius: 50%; }
        .dot.running {
            background: #10B685;
        }
        .dot.offline { background: #2e3237; }
        .status-text { font-size: 0.64rem; font-weight: 400; color: #4a4f54; }

        /* ── Actions ── */
        .actions {
            display: flex; align-items: center; gap: 8px; margin-bottom: 18px;
            flex-wrap: wrap;
        }
        .btn {
            font-family: 'Raleway', 'Open Sans', sans-serif;
            font-size: 0.66rem; font-weight: 400;
            padding: 7px 16px; border-radius: 6px;
            border: none; cursor: pointer;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; gap: 6px;
            position: relative; overflow: hidden;
        }
        .btn:active:not(:disabled) { transform: scale(0.97); }
        .btn:disabled { opacity: 0.35; cursor: default; }
        .btn-primary {
            background: transparent;
            color: #8a8f94;
            font-weight: 500;
            border: 1.5px solid rgba(255,255,255,0.1);
        }
        .btn-primary:hover:not(:disabled) {
            color: #b0b5ba;
            border-color: rgba(255,255,255,0.16);
            background: rgba(255,255,255,0.02);
            box-shadow: none;
        }
        .btn-primary svg {
            width: 12px; height: 12px; fill: none;
            stroke: currentColor; stroke-width: 2;
            stroke-linecap: round; stroke-linejoin: round;
        }
        .btn-ghost {
            background: rgba(255,255,255,0.035); color: #505560;
        }
        .btn-ghost:hover:not(:disabled) { background: rgba(255,255,255,0.055); color: #70757a; }
        .btn-delete-instances { color: #88444a !important; }
        .btn-delete-instances:hover:not(:disabled) { background: rgba(220,53,69,0.12) !important; color: #dc3545 !important; }
        .btn-delete-instances svg { width: 13px; height: 13px; }

        .btn-manage {
            display: inline-flex; align-items: center; gap: 7px;
            padding: 7px 14px 7px 11px;
            font-size: 0.62rem; font-weight: 600; letter-spacing: 0.02em;
            color: #6b7280; background: rgba(255,255,255,0.025);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 4px; cursor: pointer;
            transition: all 0.15s ease;
        }
        .btn-manage svg {
            width: 14px; height: 14px; opacity: 0.55;
            transition: opacity 0.15s ease;
        }
        .btn-manage:hover:not(:disabled) {
            color: #b0b5ba; background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.10);
        }
        .btn-manage:hover:not(:disabled) svg { opacity: 0.85; }
        .btn-manage:disabled { opacity: 0.3; cursor: default; }

        /* ── Instance Manager Modal ── */
        .im-modal {
            background: #161a1d;
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 3px;
            width: 700px;
            max-width: 94vw;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.4), 0 24px 64px rgba(0,0,0,0.5);
            animation: modalSlideIn 0.22s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .im-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            flex-shrink: 0;
        }
        .im-topbar-title {
            font-size: 0.72rem;
            font-weight: 600;
            color: #c0c4c9;
        }
        .im-topbar-close {
            background: none; border: none; color: #4a4f54; cursor: pointer;
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            border-radius: 4px; transition: all 0.12s; padding: 0;
        }
        .im-topbar-close:hover { background: rgba(255,255,255,0.05); color: #b0b5ba; }
        .im-topbar-close svg { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; }
        .im-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            flex-shrink: 0;
        }
        .im-actions-left {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        .im-actions-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .im-sel-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .im-sel-label {
            font-size: 0.5rem;
            font-weight: 500;
            color: #10B685;
            white-space: nowrap;
        }
        .im-summary-count {
            font-size: 0.68rem;
            font-weight: 600;
            color: #10B685;
        }
        .im-summary-count-dim { color: #4a4f54; }
        .im-summary-label {
            font-size: 0.56rem;
            font-weight: 400;
            color: #4a4f54;
        }
        .im-summary-sep {
            color: #2e3237;
            font-size: 0.56rem;
            margin: 0 2px;
        }
        .im-summary-divider {
            width: 1px;
            height: 14px;
            background: rgba(255,255,255,0.06);
            margin: 0 4px;
        }

        /* Bulk action buttons */
        .im-bulk-btn {
            font-family: 'Raleway', 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.56rem;
            font-weight: 500;
            padding: 5px 12px;
            border-radius: 3px;
            background: transparent;
            color: #5a6070;
            border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
            transition: color 0.15s, border-color 0.15s, background 0.15s;
        }
        .im-bulk-btn:hover:not(:disabled) {
            color: #b0b5ba;
            border-color: rgba(255,255,255,0.14);
            background: rgba(255,255,255,0.02);
        }
        .im-bulk-btn:disabled {
            opacity: 0.3;
            cursor: default;
        }
        .im-bulk-btn-danger { color: #88444a; border-color: rgba(220,53,69,0.15); }
        .im-bulk-btn-danger:hover:not(:disabled) {
            color: #dc3545;
            border-color: rgba(220,53,69,0.3);
            background: rgba(220,53,69,0.06);
        }

        /* Card grid */
        .im-grid {
            flex: 1 1 auto;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            padding: 0 20px 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: min-content;
            align-content: start;
            gap: 6px;
            min-height: 80px;
            max-height: 55vh;
        }
        .im-grid::-webkit-scrollbar { width: 3px; }
        .im-grid::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 2px; }
        .im-grid .empty-state {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 40px 20px;
            color: #4a4f54;
            font-size: 0.62rem;
        }

        /* Instance card */
        .im-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.045);
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            overflow: hidden;
        }
        .im-card:hover {
            background: rgba(255,255,255,0.04);
            border-color: rgba(255,255,255,0.08);
        }
        .im-card.selected {
            background: rgba(16,182,133,0.05);
            border-color: rgba(16,182,133,0.25);
        }
        .im-card.stopped { opacity: 0.5; }
        .im-card.stopped:hover { opacity: 0.7; }

        /* Card logo */
        .im-card-logo {
            width: 30px;
            height: 30px;
            object-fit: contain;
            opacity: 0.12;
            flex-shrink: 0;
        }

        /* Card text */
        .im-card-text {
            flex: 1;
            min-width: 0;
        }
        .im-card-name {
            font-size: 0.64rem;
            font-weight: 600;
            color: #c0c4c9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .im-card.selected .im-card-name { color: #10B685; }
        .im-card-meta {
            font-size: 0.5rem;
            color: #3a3f48;
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 1px;
        }

        /* Status dot (inside card) */
        .im-card-dot {
            width: 5px; height: 5px;
            border-radius: 50%;
            flex-shrink: 0;
            display: inline-block;
        }
        .im-card-dot.running { background: #10B685; }
        .im-card-dot.stopped { background: #2e3237; }

        /* Action button (right side of card) */
        .im-card-action {
            flex-shrink: 0;
        }
        .im-action-btn {
            width: 26px; height: 26px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: #3a3f48;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.12s;
            padding: 0;
        }
        .im-action-btn:hover {
            background: rgba(255,255,255,0.04);
            color: #80858a;
        }
        .im-action-btn svg {
            width: 13px; height: 13px;
            fill: none;
            stroke: currentColor;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .im-btn-start:hover { color: #10B685; background: rgba(16,182,133,0.06); }
        .im-btn-stop:hover { color: #e05545; background: rgba(224,85,69,0.06); }
        .im-btn-stop svg { fill: currentColor; stroke: none; }
        .im-action-btn.loading { pointer-events: none; }
        .im-action-btn.loading svg { animation: spin 0.8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* ── Delete Modal ── */
        .del-modal {
            background: #161a1d;
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 3px;
            width: 480px;
            max-width: 94vw;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow:
                0 0 0 1px rgba(0,0,0,0.4),
                0 24px 64px rgba(0,0,0,0.5),
                0 48px 100px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.22s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        .del-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px 14px 24px;
        }
        .del-topbar-title {
            font-size: 0.92rem;
            font-weight: 600;
            color: #d0d4d9;
            letter-spacing: -0.01em;
        }
        .del-topbar-close {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.04);
            color: #505560;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .del-topbar-close:hover {
            background: rgba(255,255,255,0.08);
            color: #90959e;
        }
        .del-topbar-close svg { width: 14px; height: 14px; }

        /* Card grid */
        .del-grid {
            flex: 1 1 auto;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            padding: 0 24px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-auto-rows: min-content;
            align-content: start;
            gap: 6px;
            min-height: 80px;
            max-height: 55vh;
        }
        .del-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 12px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.045);
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            overflow: hidden;
        }
        .del-card:hover {
            background: rgba(255,255,255,0.04);
            border-color: rgba(255,255,255,0.08);
        }
        .del-card.selected {
            background: rgba(220,53,69,0.06);
            border-color: rgba(220,53,69,0.25);
        }
        .del-card.protected {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }
        .del-card-logo {
            width: 30px;
            height: 30px;
            object-fit: contain;
            opacity: 0.12;
            flex-shrink: 0;
        }
        .del-card-text {
            flex: 1;
            min-width: 0;
        }
        .del-card-name {
            font-size: 0.64rem;
            font-weight: 600;
            color: #c0c4c9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .del-card.selected .del-card-name { color: #dc3545; }
        .del-card-desc {
            font-size: 0.54rem;
            color: #4a4f58;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .del-card-check {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1.5px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .del-card.selected .del-card-check {
            border-color: #dc3545;
            background: #dc3545;
        }
        .del-card-check svg {
            width: 10px;
            height: 10px;
            opacity: 0;
            transition: opacity 0.15s;
        }
        .del-card.selected .del-card-check svg { opacity: 1; }

        /* Subtitle */
        .del-subtitle {
            padding: 12px 24px 0;
            font-size: 0.56rem;
            color: #4a4f58;
            letter-spacing: 0.01em;
        }

        /* Footer */
        .del-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            padding: 14px 24px;
            margin-top: 8px;
            background: rgba(255,255,255,0.018);
            border-top: 1px solid rgba(255,255,255,0.04);
        }
        .del-btn-delete {
            font-family: inherit;
            font-size: 0.64rem;
            font-weight: 500;
            padding: 8px 20px;
            border-radius: 2px;
            border: 1px solid rgba(255,255,255,0.08);
            background: transparent;
            color: #4a4f58;
            cursor: pointer;
            transition: color 0.15s, border-color 0.15s;
            outline: none !important;
            box-shadow: none !important;
            -webkit-appearance: none;
        }
        .del-btn-delete:focus,
        .del-btn-delete:focus-visible {
            outline: none !important;
            box-shadow: none !important;
        }
        .del-btn-delete:not(:disabled) {
            border-color: rgba(220,53,69,0.35);
            color: #88444a;
        }
        .del-btn-delete:hover:not(:disabled) {
            border-color: #dc3545;
            color: #dc3545;
        }
        .del-btn-delete:active:not(:disabled) {
            border-color: #dc3545;
            color: #dc3545;
        }
        .del-btn-delete:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: rgba(255,255,255,0.06) !important;
            color: #3a3f48 !important;
            background: transparent !important;
        }

        /* ── Randomize Results Modal ── */
        .rr-modal {
            background: #161a1d;
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 3px;
            width: 540px;
            max-width: 94vw;
            max-height: 82vh;
            display: flex;
            flex-direction: column;
            box-shadow:
                0 0 0 1px rgba(0,0,0,0.4),
                0 24px 64px rgba(0,0,0,0.5),
                0 48px 100px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.22s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        .rr-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px 12px 24px;
        }
        .rr-topbar-title {
            font-size: 0.92rem;
            font-weight: 600;
            color: #d0d4d9;
            letter-spacing: -0.01em;
        }
        .rr-tabs {
            display: flex;
            gap: 3px;
            padding: 0 24px 12px;
            overflow-x: auto;
        }
        .rr-tab {
            padding: 6px 14px;
            border: none;
            border-radius: 2px;
            background: rgba(255,255,255,0.03);
            color: #4a4f58;
            font-family: inherit;
            font-size: 0.58rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .rr-tab:hover { background: rgba(255,255,255,0.05); color: #6a6f78; }
        .rr-tab.active {
            background: rgba(16,182,133,0.1);
            color: #10B685;
        }
        .rr-body {
            flex: 1;
            overflow-y: auto;
            padding: 0 24px 12px;
            min-height: 0;
            max-height: 420px;
        }
        .rr-table {
            width: 100%;
            border-collapse: collapse;
        }
        .rr-table th {
            text-align: left;
            font-size: 0.52rem;
            font-weight: 600;
            color: #505560;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .rr-table td {
            font-size: 0.58rem;
            padding: 7px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.025);
            font-family: 'SF Mono', 'Menlo', 'Consolas', monospace;
            word-break: break-all;
        }
        .rr-table tr:last-child td { border-bottom: none; }
        .rr-label {
            color: #80858c;
            font-family: inherit;
            font-weight: 500;
            white-space: nowrap;
        }
        .rr-old {
            color: #5a3a3a;
        }
        .rr-new {
            color: #10B685;
        }
        .rr-unchanged {
            color: #3a3f48;
        }
        .rr-arrow {
            color: #3a3f48;
            text-align: center;
            font-size: 0.5rem;
            padding: 7px 4px;
        }

        .actions-spacer { flex: 1; }

        /* Button ripple effect */
        .btn-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.06);
            transform: scale(0);
            animation: ripple 0.5s ease-out;
            pointer-events: none;
        }
        @keyframes ripple {
            to { transform: scale(2.5); opacity: 0; }
        }

        /* ── Clone form extras ── */
        .clone-form-row {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 14px;
        }
        .form-label {
            font-size: 0.6rem; font-weight: 500; color: #4a4f54;
            text-transform: uppercase; letter-spacing: 0.04em;
            min-width: 80px; flex-shrink: 0;
        }
        .form-input {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.66rem; color: #8a8f94;
            background: #22262b; border: 1px solid rgba(255,255,255,0.04);
            border-radius: 6px; padding: 7px 12px;
            flex: 1; outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            border-color: rgba(16,182,133,0.3);
            box-shadow: 0 0 0 3px rgba(16,182,133,0.06);
        }
        .form-input::placeholder { color: #33383d; }

        .form-select {
            font-family: 'Raleway', 'Open Sans', sans-serif;
            font-size: 0.66rem; color: #8a8f94;
            background: #22262b; border: 1px solid rgba(255,255,255,0.04);
            border-radius: 6px; padding: 7px 12px;
            outline: none; cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' fill='none' stroke='%234a4f54' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 28px;
        }
        .form-select:focus {
            border-color: rgba(16,182,133,0.3);
            box-shadow: 0 0 0 3px rgba(16,182,133,0.06);
        }

        .form-check {
            display: flex; align-items: center; gap: 8px;
            cursor: pointer; user-select: none;
        }
        .form-check input[type="checkbox"] { display: none; }
        .form-check-box {
            width: 14px; height: 14px; border-radius: 3px;
            border: 1.5px solid rgba(255,255,255,0.08);
            position: relative; transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }
        .form-check input:checked + .form-check-box {
            background: none; border-color: transparent;
        }
        .form-check input:checked + .form-check-box::after {
            content: ''; position: absolute;
            top: 0px; left: 3.5px; width: 5px; height: 9px;
            border: solid #10B685; border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        .form-check-label { font-size: 0.64rem; color: #606569; }
        .clone-names-hint { font-size: 0.54rem; color: #33383d; margin-top: 4px; }

        /* ── Log ── */
        /* Paths toggle */
        .paths.hidden { display: none; }

        /* Log — inline (default) and pop-out mode */
        .log {
            background: #1c1f22;
            border-radius: 0;
            overflow: hidden;
            border-top: 1px solid rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.03);
            flex-shrink: 0;
            margin: 0;
            transition: opacity 0.25s, transform 0.25s;
        }
        .log.popout {
            position: fixed;
            bottom: 42px;
            right: 16px;
            width: 320px;
            max-height: 220px;
            background: #171a1d;
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            z-index: 900;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .log.popout .log-bar {
            padding: 8px 14px;
            cursor: grab;
        }
        .log.popout .log-body {
            padding: 4px 14px 10px;
            max-height: 150px;
        }
        .log.hidden-inline {
            display: none;
        }
        /* Active toggle indicator */
        .header-circle.active {
            color: #b0b5ba;
            background: rgba(255,255,255,0.06);
        }
        .log-bar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 6px 32px;
            border-bottom: 1px solid rgba(255,255,255,0.035);
        }
        .log-bar-left { display: flex; align-items: center; gap: 8px; }
        .log-dot {
            width: 5px; height: 5px; border-radius: 50%; background: #2c3139;
            transition: background 0.3s;
        }
        .log-dot.active {
            background: #10B685;
        }
        .log-label {
            font-size: 0.62rem; font-weight: 500; color: #80858a;
            letter-spacing: 0.01em;
        }
        .log-clear {
            font-family: 'Raleway', 'Open Sans', sans-serif;
            font-size: 0.52rem; color: #4a4f54;
            background: none; border: none; cursor: pointer;
            transition: color 0.15s;
            padding: 3px 8px;
            border-radius: 3px;
        }
        .log-clear:hover { color: #80858a; background: rgba(255,255,255,0.03); }
        .log-body {
            padding: 6px 32px 8px;
            max-height: 90px; overflow-y: auto;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.56rem; line-height: 1.9; color: #60656a;
        }
        .log-body::-webkit-scrollbar { width: 2px; }
        .log-body::-webkit-scrollbar-track { background: transparent; }
        .log-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 1px; }
        .l {
            display: flex; align-items: baseline; gap: 10px;
            animation: logLineIn 0.15s ease-out both;
        }
        .l-dot {
            width: 4px; height: 4px; border-radius: 50%;
            flex-shrink: 0;
            position: relative;
            top: -1px;
        }
        .l-dot.ok { background: #80858a; }
        .l-dot.do { background: #33383d; }
        .l-dot.fail { background: #e05545; }
        .l-dot.skip { background: #4a4f54; }
        .l-msg { color: #60656a; }
        .l-msg .hl { color: #8a8f96; }
        .l-msg .ac { color: #10B685; }
        .l-msg .gn { color: #9a9fa4; }
        @keyframes logLineIn {
            from { opacity: 0; transform: translateY(2px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ── Footer ── */
        .footer {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 32px;
            border-top: 1px solid rgba(255,255,255,0.035);
            flex-shrink: 0;
            margin-top: auto;
        }
        .footer-left, .footer-right {
            flex: 1; min-width: 0;
        }
        .footer-left {
            display: flex; align-items: center;
        }
        .footer-right {
            display: flex; align-items: center; justify-content: flex-end;
            font-size: 0.52rem; color: #50555a;
        }
        .footer-center {
            font-size: 0.54rem; color: #50555a;
            font-weight: 400; letter-spacing: 0.02em;
            text-align: center;
        }
        .footer-clock {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.52rem; color: #50555a;
            letter-spacing: 0.02em;
        }

        /* ── Loading spinner ── */
        .spinner {
            display: inline-block; width: 12px; height: 12px;
            border: 1.5px solid rgba(255,255,255,0.1);
            border-top-color: #10B685; border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── Empty state ── */
        .empty-state {
            text-align: center; padding: 40px 16px;
            font-size: 0.72rem; color: #50555a;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; gap: 10px;
            min-height: 120px;
            grid-column: 1 / -1;
        }
        .empty-state-icon {
            width: 40px; height: 40px;
            border-radius: 5px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.03);
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 4px;
        }
        .empty-state-icon svg {
            width: 18px; height: 18px;
            stroke: #272b30; fill: none;
            stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round;
        }

        /* ── Command Palette ── */
        .cmd-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
            z-index: 9999;
            display: none; align-items: flex-start; justify-content: center;
            padding-top: 18vh;
            animation: overlayIn 0.15s ease-out;
        }
        .cmd-overlay.open { display: flex; }
        @keyframes overlayIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .cmd-palette {
            width: 480px;
            background: #1e2128;
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 24px 80px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.03);
            animation: cmdIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes cmdIn {
            from { opacity: 0; transform: translateY(-10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .cmd-input-wrap {
            display: flex; align-items: center; gap: 10px;
            padding: 14px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .cmd-input-wrap svg {
            width: 16px; height: 16px; stroke: #505560; fill: none;
            stroke-width: 2; stroke-linecap: round; flex-shrink: 0;
        }
        .cmd-input {
            flex: 1; background: none; border: none; outline: none;
            font-family: 'Raleway', 'Open Sans', sans-serif;
            font-size: 0.85rem; color: #c0c4c9;
        }
        .cmd-input::placeholder { color: #33383d; }
        .cmd-results {
            max-height: 280px; overflow-y: auto;
            padding: 6px;
        }
        .cmd-results::-webkit-scrollbar { width: 3px; }
        .cmd-results::-webkit-scrollbar-thumb { background: #23272c; border-radius: 2px; }
        .cmd-item {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 14px; border-radius: 5px;
            cursor: pointer; transition: background 0.1s;
        }
        .cmd-item:hover, .cmd-item.active { background: rgba(255,255,255,0.04); }
        .cmd-item-icon {
            width: 28px; height: 28px; border-radius: 5px;
            background: rgba(255,255,255,0.03);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .cmd-item-icon svg {
            width: 14px; height: 14px; stroke: #606569; fill: none;
            stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round;
        }
        .cmd-item-text { flex: 1; }
        .cmd-item-title { font-size: 0.76rem; color: #b0b5ba; font-weight: 400; }
        .cmd-item-desc { font-size: 0.58rem; color: #4a4f54; margin-top: 1px; }
        .cmd-item-kbd {
            font-family: 'Open Sans', sans-serif;
            font-size: 0.52rem; color: #33383d;
            background: rgba(255,255,255,0.03);
            padding: 2px 6px; border-radius: 4px;
        }
        .cmd-empty {
            text-align: center; padding: 24px 16px;
            font-size: 0.72rem; color: #33383d;
        }
        .cmd-footer {
            display: flex; align-items: center; gap: 12px;
            padding: 8px 18px;
            border-top: 1px solid rgba(255,255,255,0.03);
            font-size: 0.52rem; color: #2e3237;
        }
        .cmd-footer kbd {
            font-family: 'Open Sans', sans-serif;
            background: rgba(255,255,255,0.04);
            padding: 1px 4px; border-radius: 3px;
            font-size: 0.5rem;
        }

        /* ── Toast notifications ── */
        .toast-container {
            position: fixed;
            bottom: 50px; right: 24px;
            z-index: 9998;
            display: flex; flex-direction: column-reverse;
            gap: 8px; pointer-events: none;
        }
        .toast {
            display: flex; align-items: center; gap: 10px;
            background: rgba(30, 33, 40, 0.92);
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 5px;
            padding: 10px 16px;
            min-width: 260px; max-width: 380px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: toastIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: auto;
        }
        .toast.exiting {
            animation: toastOut 0.25s ease-in forwards;
        }
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(20px) scale(0.95); }
            to { opacity: 1; transform: translateX(0) scale(1); }
        }
        @keyframes toastOut {
            to { opacity: 0; transform: translateX(20px) scale(0.95); }
        }
        .toast-accent {
            width: 3px; height: 24px; border-radius: 2px; flex-shrink: 0;
        }
        .toast-accent.success { background: #10B685; }
        .toast-accent.error { background: #c0392b; }
        .toast-accent.info { background: #505560; }
        .toast-text {
            font-size: 0.68rem; color: #b0b5ba; line-height: 1.4;
        }

        /* ── Randomize tab — streamlined ── */
        /* Info bar (shared style for notice + scan result) */
        .rand-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 16px;
            background: #1f2327;
            border-top: 2px solid #2f3439;
            margin-bottom: 14px;
            font-size: 0.62rem;
            color: #9a9fa4;
            line-height: 1.5;
        }
        .rand-bar-icon {
            flex-shrink: 0;
            width: 30px; height: 30px;
            border-radius: 50%;
            background: #272b30;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .rand-bar-icon svg {
            width: 15px; height: 15px;
            fill: none; stroke: #70757a;
            stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round;
        }
        .rand-bar-body {
            flex: 1;
            min-width: 0;
        }
        .rand-bar-title {
            font-size: 0.64rem;
            font-weight: 500;
            color: #c8ccd0;
            margin-bottom: 1px;
        }
        .rand-bar-text {
            font-size: 0.58rem;
            color: #70757a;
            line-height: 1.45;
        }
        .rand-bar-text a {
            color: #10B685;
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }
        .rand-bar-text a:hover { text-decoration: underline; }
        .rand-bar-dismiss {
            flex-shrink: 0;
            width: 24px; height: 24px;
            border-radius: 4px;
            background: none; border: none;
            color: #4a4f54; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.15s, color 0.15s;
            font-size: 0.8rem;
        }
        .rand-bar-dismiss:hover { background: rgba(255,255,255,0.04); color: #80858a; }

        /* Scan result bar (success / warn variants) */
        .rand-scan-result {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 11px 16px;
            background: #1f2327;
            margin-bottom: 14px;
            font-size: 0.62rem;
            line-height: 1.5;
        }
        .rand-scan-result.show { display: flex; }
        .rand-scan-result.success { border-top: 2px solid #10B685; }
        .rand-scan-result.warn { border-top: 2px solid #c4973a; }
        .rand-scan-result .scan-icon {
            flex-shrink: 0;
            width: 30px; height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .rand-scan-result.success .scan-icon { background: rgba(16,182,133,0.1); }
        .rand-scan-result.warn .scan-icon { background: rgba(196,151,58,0.1); }
        .rand-scan-result .scan-icon svg {
            width: 15px; height: 15px;
            fill: none; stroke: currentColor;
            stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round;
        }
        .rand-scan-result.success .scan-icon { color: #10B685; }
        .rand-scan-result.warn .scan-icon { color: #c4973a; }
        .rand-scan-result .scan-body { flex: 1; min-width: 0; }
        .rand-scan-result .scan-title {
            font-size: 0.64rem;
            font-weight: 500;
            margin-bottom: 1px;
        }
        .rand-scan-result.success .scan-title { color: #10B685; }
        .rand-scan-result.warn .scan-title { color: #c4973a; }
        .rand-scan-result .scan-text {
            font-size: 0.58rem;
            color: #70757a;
        }
        .scan-actions {
            display: flex;
            align-items: center;
            gap: 0;
            flex-shrink: 0;
            margin-left: auto;
        }
        .scan-actions-sep {
            width: 1px;
            height: 18px;
            background: rgba(255,255,255,0.06);
        }
        .scan-action-btn {
            font-family: 'Raleway', 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.58rem;
            font-weight: 500;
            padding: 6px 14px;
            border: none;
            background: transparent;
            color: #5a6070;
            cursor: pointer;
            transition: color 0.12s, background 0.12s;
            border-radius: 3px;
        }
        .scan-action-btn:hover {
            color: #b0b5ba;
            background: rgba(255,255,255,0.04);
        }
        .scan-action-btn:disabled { opacity: 0.3; cursor: default; }
        .scan-action-primary { color: #b0b5ba; font-weight: 600; }
        .scan-action-primary:hover { color: #d0d4d8; background: rgba(255,255,255,0.04); }
        .scan-action-primary:disabled { color: #b0b5ba; opacity: 0.3; }

        .rand-summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }
        .rand-summary-left {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        .rand-summary-count {
            font-size: 0.68rem;
            font-weight: 600;
            color: #c0c4c9;
            font-family: 'Open Sans', sans-serif;
        }
        .rand-summary-label {
            font-size: 0.62rem;
            color: #505560;
            font-weight: 400;
        }
        .rand-summary-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .rand-summary-sel {
            color: #60656a;
        }
        .btn-sm {
            font-size: 0.58rem !important;
            padding: 5px 10px !important;
        }
        .btn-sm svg {
            width: 11px; height: 11px;
            fill: none; stroke: currentColor;
            stroke-width: 2; stroke-linecap: round;
        }

        /* Instance cards grid */
        .rand-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            margin-bottom: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
        .rand-cards::-webkit-scrollbar { width: 3px; }
        .rand-cards::-webkit-scrollbar-thumb { background: #23272c; border-radius: 2px; }

        .rand-card {
            background: #22262b;
            border: 1px solid rgba(255,255,255,0.03);
            border-radius: 5px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            animation: paneIn 0.25s ease-out both;
        }
        .rand-card:hover {
            border-color: rgba(255,255,255,0.06);
            background: #262a2f;
        }
        .rand-card.selected {
            border-color: rgba(16,182,133,0.2);
            background: rgba(16,182,133,0.04);
        }
        .rand-card.selected::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 2px;
            background: #10B685;
            border-radius: 0 1px 1px 0;
        }
        .rand-card.offline {
            opacity: 0.35;
            pointer-events: none;
            cursor: default;
        }
        .rand-card-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .rand-card-dot.running {
            background: #10B685;
        }
        .rand-card-dot.offline {
            background: #2e3237;
        }
        .rand-card-info {
            flex: 1;
            min-width: 0;
        }
        .rand-card-name {
            font-size: 0.68rem;
            font-weight: 500;
            color: #b0b5ba;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .rand-card-meta {
            font-size: 0.52rem;
            color: #4a4f54;
            margin-top: 1px;
        }
        .rand-card-check {
            width: 14px; height: 14px;
            border-radius: 3px;
            border: 1.5px solid rgba(255,255,255,0.08);
            flex-shrink: 0;
            position: relative;
            transition: all 0.15s;
        }
        .rand-card.selected .rand-card-check {
            background: none;
            border-color: transparent;
        }
        .rand-card.selected .rand-card-check::after {
            content: '';
            position: absolute;
            top: 0px; left: 3.5px;
            width: 5px; height: 9px;
            border: solid #10B685;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        /* ── Inline Instance List ── */
        .il-section {
            margin-top: 20px;
            background: #1c1f22;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.03);
            overflow: hidden;
        }
        .il-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.035);
        }
        .il-header-left {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        .il-header-title {
            font-size: 0.62rem;
            font-weight: 500;
            color: #80858a;
            letter-spacing: 0.01em;
        }
        .il-header-sep {
            color: #2e3237;
            font-size: 0.56rem;
            margin: 0 2px;
        }
        .il-header-count {
            font-size: 0.62rem;
            font-weight: 600;
            color: #b0b5ba;
            font-family: 'Open Sans', sans-serif;
        }
        .il-header-count-dim { color: #4a4f54; }
        .il-header-label {
            font-size: 0.52rem;
            font-weight: 400;
            color: #4a4f54;
        }
        .il-header-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .il-header-divider {
            width: 1px;
            height: 14px;
            background: rgba(255,255,255,0.06);
            margin: 0 4px;
        }
        .il-bulk-btn {
            font-family: 'Raleway', 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.52rem;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 3px;
            background: transparent;
            color: #5a6070;
            border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
            transition: color 0.15s, border-color 0.15s, background 0.15s;
        }
        .il-bulk-btn:hover:not(:disabled) {
            color: #b0b5ba;
            border-color: rgba(255,255,255,0.14);
            background: rgba(255,255,255,0.02);
        }
        .il-bulk-btn:disabled { opacity: 0.3; cursor: default; }
        .il-list {
            max-height: 240px;
            overflow-y: auto;
        }
        .il-list::-webkit-scrollbar { width: 3px; }
        .il-list::-webkit-scrollbar-track { background: transparent; }
        .il-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 2px; }
        .il-empty {
            padding: 30px 16px;
            text-align: center;
            font-size: 0.6rem;
            color: #4a4f54;
        }
        .il-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 9px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.025);
            transition: background 0.12s;
        }
        .il-row:last-child { border-bottom: none; }
        .il-row:hover { background: rgba(255,255,255,0.015); }
        .il-row.stopped { opacity: 0.5; }
        .il-row.stopped:hover { opacity: 0.7; }
        .il-row-dot {
            width: 5px; height: 5px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .il-row-dot.running { background: #10B685; }
        .il-row-dot.stopped { background: #2e3237; }
        .il-row-name {
            font-size: 0.64rem;
            font-weight: 500;
            color: #b0b5ba;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .il-row-port {
            font-size: 0.5rem;
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            color: #3a3f48;
            flex-shrink: 0;
        }
        .il-row-status {
            font-size: 0.52rem;
            color: #4a4f54;
            flex-shrink: 0;
            width: 46px;
            text-align: right;
        }
        .il-row.stopped .il-row-status { color: #3a3f48; }
        .il-row-action { flex-shrink: 0; }
        .il-action-btn {
            width: 24px; height: 24px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: #3a3f48;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.12s;
            padding: 0;
        }
        .il-action-btn:hover { background: rgba(255,255,255,0.04); color: #80858a; }
        .il-action-btn svg {
            width: 12px; height: 12px;
            fill: none; stroke: currentColor;
            stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round;
        }
        .il-btn-start:hover { color: #10B685; background: rgba(16,182,133,0.06); }
        .il-btn-stop:hover { color: #e05545; background: rgba(224,85,69,0.06); }
        .il-btn-stop svg { fill: currentColor; stroke: none; }
        .il-action-btn.loading { pointer-events: none; }
        .il-action-btn.loading svg { animation: spin 0.8s linear infinite; }

        /* ── Unified Table ── */
        .ut-wrap {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }
        .ut-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0 12px;
        }
        .ut-topbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ut-logo {
            width: 26px;
            height: 26px;
            object-fit: contain;
            opacity: 0.15;
            flex-shrink: 0;
        }
        .ut-counts {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        .ut-count-val {
            font-size: 0.68rem;
            font-weight: 600;
            color: #b0b5ba;
            font-family: 'Open Sans', sans-serif;
        }
        .ut-count-val-dim { color: #4a4f54; }
        .ut-count-label {
            font-size: 0.52rem;
            font-weight: 400;
            color: #4a4f54;
        }
        .ut-count-sep {
            color: #2e3237;
            font-size: 0.52rem;
            margin: 0 1px;
        }
        .ut-topbar-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ut-topbar-divider {
            width: 1px; height: 14px;
            background: rgba(255,255,255,0.06);
            margin: 0 4px;
        }
        .ut-btn {
            font-family: 'Raleway', 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.52rem;
            font-weight: 500;
            padding: 5px 11px;
            border-radius: 3px;
            background: transparent;
            color: #5a6070;
            border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
            transition: color 0.15s, border-color 0.15s, background 0.15s;
        }
        .ut-btn:hover:not(:disabled) {
            color: #b0b5ba;
            border-color: rgba(255,255,255,0.14);
            background: rgba(255,255,255,0.02);
        }
        .ut-btn:disabled { opacity: 0.3; cursor: default; }

        /* Grid: two columns */
        .ut-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            align-content: start;
        }
        .ut-grid::-webkit-scrollbar { width: 3px; }
        .ut-grid::-webkit-scrollbar-track { background: transparent; }
        .ut-grid::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 2px; }
        .ut-grid .ut-empty {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 40px 20px;
            color: #4a4f54;
            font-size: 0.6rem;
        }

        /* Instance card */
        .ut-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(255,255,255,0.018);
            border: 1px solid rgba(255,255,255,0.04);
            border-radius: 3px;
            transition: background 0.12s, border-color 0.12s, opacity 0.12s;
            position: relative;
        }
        .ut-card:hover {
            background: rgba(255,255,255,0.035);
            border-color: rgba(255,255,255,0.07);
        }
        .ut-card.offline {
            opacity: 0.45;
        }
        .ut-card.offline:hover {
            opacity: 0.65;
        }

        /* Status dot */
        .ut-dot {
            width: 5px; height: 5px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .ut-dot.on { background: #10B685; }
        .ut-dot.off { background: #2e3237; }

        /* Card text */
        .ut-card-info {
            flex: 1;
            min-width: 0;
        }
        .ut-card-name {
            font-size: 0.62rem;
            font-weight: 500;
            color: #b0b5ba;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .ut-card-meta {
            font-size: 0.48rem;
            color: #3a3f48;
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            margin-top: 1px;
        }

        /* CDP browser fingerprint badge */
        .ut-cdp {
            display: inline-block;
            font-size: 0.42rem;
            font-weight: 700;
            padding: 0px 4px;
            border-radius: 3px;
            margin-left: 5px;
            cursor: pointer;
            letter-spacing: 0.03em;
            vertical-align: middle;
            transition: all 0.15s;
        }
        .ut-cdp.cdp-on {
            background: rgba(16, 182, 133, 0.15);
            color: #10B685;
        }
        .ut-cdp.cdp-wait {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            animation: cdpPulse 1.5s ease-in-out infinite;
        }
        .ut-cdp.cdp-err {
            background: rgba(224, 85, 69, 0.12);
            color: #e05545;
        }
        .ut-cdp.cdp-off {
            background: rgba(255, 255, 255, 0.03);
            color: #2d3136;
        }
        .ut-cdp:hover {
            filter: brightness(1.3);
        }
        @keyframes cdpPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ═══ VPN Tab — Two-Column ═══ */
        .v { display:flex;flex-direction:column;height:100%;box-sizing:border-box; }

        /* ── Top bar: auth ── */
        .v-topbar {
            display:flex;align-items:center;gap:10px;
            padding:8px 16px;flex-shrink:0;
        }
        .v-topbar-spacer { flex:1; }
        .v-topbar-stat {
            font-size:10px;color:rgba(255,255,255,0.18);
            font-family:'SF Mono','Roboto Mono',monospace;white-space:nowrap;
        }
        .v-topbar-stat b { color:rgba(255,255,255,0.35);font-weight:600; }
        .v-input {
            padding:4px 8px;border-radius:3px;border:1px solid rgba(255,255,255,0.06);
            background:rgba(0,0,0,0.22);color:rgba(255,255,255,0.55);
            font-size:11px;font-family:'SF Mono','Roboto Mono',monospace;
            outline:none;transition:border-color 0.15s;
        }
        .v-input:focus { border-color:rgba(16,182,133,0.35); }
        .v-input::placeholder { color:rgba(255,255,255,0.1); }
        .v-btn {
            font-family:'Raleway','Open Sans',sans-serif;
            font-size:10px;font-weight:500;letter-spacing:0.02em;
            padding:5px 12px;border-radius:3px;
            background:transparent;color:#50555c;
            border:1px solid rgba(255,255,255,0.04);
            cursor:pointer;display:inline-flex;align-items:center;gap:3px;
            transition:background 0.12s, border-color 0.12s, color 0.12s;
            white-space:nowrap;line-height:1;
        }
        .v-btn:hover { color:#90959c;background:rgba(255,255,255,0.025);border-color:rgba(255,255,255,0.07); }
        .v-btn:active { background:rgba(255,255,255,0.04); }
        .v-btn.primary { color:#70757c; }
        .v-btn.primary:hover { color:#b0b5ba;border-color:rgba(255,255,255,0.08); }
        .v-btn.danger { color:#503838; }
        .v-btn.danger:hover { color:#b05050;border-color:rgba(176,80,80,0.15);background:rgba(176,80,80,0.03); }
        .v-btn:disabled { opacity:0.2;cursor:default;pointer-events:none; }

        /* ── Two-column body ── */
        .v-body {
            flex:1;display:flex;min-height:0;
            margin:0 14px 14px;
            border-radius:6px;
            background:rgba(255,255,255,0.015);
            border:1px solid rgba(255,255,255,0.035);
        }
        .v-col {
            flex:1;display:flex;flex-direction:column;min-height:0;
            overflow-y:auto;
        }
        .v-col + .v-col { border-left:1px solid rgba(255,255,255,0.04); }
        .v-col::-webkit-scrollbar { width:3px; }
        .v-col::-webkit-scrollbar-track { background:transparent; }
        .v-col::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.06);border-radius:2px; }

        /* Column header */
        .v-col-head {
            display:flex;align-items:center;justify-content:space-between;
            padding:8px 14px;flex-shrink:0;
            border-bottom:1px solid rgba(255,255,255,0.03);
            position:sticky;top:0;background:rgba(26,29,33,0.97);z-index:2;
            backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
        }
        .v-col-title {
            font-size:10px;font-weight:600;color:rgba(255,255,255,0.2);
            text-transform:uppercase;letter-spacing:0.06em;
        }

        /* ── Row (shared by both columns) ── */
        .v-row {
            display:flex;align-items:center;gap:10px;
            padding:7px 14px;
            border-bottom:1px solid rgba(255,255,255,0.02);
            transition:background 0.1s;
        }
        .v-row:hover { background:rgba(255,255,255,0.015); }
        .v-dot {
            width:6px;height:6px;border-radius:50%;flex-shrink:0;
        }
        .v-dot.on { background:#10B685; }
        .v-dot.warn { background:#d4a017;animation:cdpPulse 1.5s ease-in-out infinite; }
        .v-dot.err { background:#c0392b; }
        .v-dot.off { background:rgba(255,255,255,0.06); }
        .v-name {
            font-size:12px;font-weight:500;color:rgba(255,255,255,0.55);
            overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;
        }
        .v-inst-proxy {
            font-size:9px;color:rgba(255,255,255,0.15);
            font-family:'SF Mono','Roboto Mono',monospace;
            white-space:nowrap;flex-shrink:0;max-width:120px;
            overflow:hidden;text-overflow:ellipsis;
        }

        /* ── Proxy row specifics ── */
        .v-proxy-ip {
            font-size:11px;color:rgba(255,255,255,0.3);
            font-family:'SF Mono','Roboto Mono',monospace;
            overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
            flex:1;
        }
        .v-proxy-loc {
            font-size:11px;color:rgba(255,255,255,0.22);
            white-space:nowrap;flex-shrink:0;
        }
        .v-proxy-ping {
            font-size:10px;color:rgba(255,255,255,0.15);
            font-family:'SF Mono','Roboto Mono',monospace;
            width:42px;text-align:right;flex-shrink:0;
        }
        .v-proxy-x {
            width:18px;height:18px;border-radius:3px;border:none;
            background:transparent;color:rgba(255,255,255,0.06);cursor:pointer;
            display:flex;align-items:center;justify-content:center;font-size:12px;
            transition:all 0.12s;flex-shrink:0;
        }
        .v-proxy-x:hover { color:rgba(255,255,255,0.25);background:rgba(255,255,255,0.04); }

        /* Empty state */
        .v-empty {
            padding:32px 14px;text-align:center;
            font-size:11px;color:rgba(255,255,255,0.08);
        }

        /* ── Selectable rows ── */
        .v-row.selectable { cursor:pointer;user-select:none; }
        .v-row.selected {
            background:rgba(255,255,255,0.035);
            border-left:2px solid rgba(255,255,255,0.2);
            padding-left:12px;
        }
        .v-row.selected .v-name { color:rgba(255,255,255,0.75); }
        .v-row.selected .v-proxy-ip { color:rgba(255,255,255,0.45); }

        /* Link button (appears in column header when selection is ready) */
        .v-link-btn {
            font-family:'Raleway','Open Sans',sans-serif;
            font-size:10px;font-weight:600;letter-spacing:0.03em;
            padding:5px 16px;border-radius:3px;
            background:transparent;color:#80858c;
            border:1px solid rgba(255,255,255,0.06);
            cursor:pointer;transition:background 0.12s, border-color 0.12s, color 0.12s;
            display:none;white-space:nowrap;
        }
        .v-link-btn.show {
            display:inline-flex;
            animation:vBtnFadeIn 0.2s ease;
        }
        @keyframes vBtnFadeIn { from { opacity:0;transform:translateX(6px); } to { opacity:1;transform:translateX(0); } }
        .v-link-btn:hover { color:#b0b5ba;border-color:rgba(255,255,255,0.1);background:rgba(255,255,255,0.025); }
        .v-link-btn:active { background:rgba(255,255,255,0.04); }

        /* ── Modal overlay ── */
        .v-modal-overlay {
            position:fixed;top:0;left:0;right:0;bottom:0;
            background:rgba(0,0,0,0.55);
            display:none;align-items:center;justify-content:center;
            z-index:9999;
            animation:vFadeIn 0.15s ease;
        }
        .v-modal-overlay.open { display:flex; }
        @keyframes vFadeIn { from { opacity:0; } to { opacity:1; } }

        .v-modal {
            background:#1c1f24;border:1px solid rgba(255,255,255,0.06);
            border-radius:8px;padding:22px 26px;
            min-width:340px;max-width:420px;
            box-shadow:0 16px 50px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.03);
            animation:vSlideUp 0.2s ease;
        }
        @keyframes vSlideUp { from { transform:translateY(10px);opacity:0; } to { transform:translateY(0);opacity:1; } }

        .v-modal-title {
            font-size:12px;font-weight:500;color:rgba(255,255,255,0.45);
            margin-bottom:14px;line-height:1.4;
        }
        .v-modal-proxy {
            font-size:11px;color:rgba(255,255,255,0.5);
            font-family:'SF Mono','Roboto Mono',monospace;
            background:rgba(255,255,255,0.03);
            border-radius:5px;padding:7px 11px;margin-bottom:12px;
        }
        .v-modal-list {
            list-style:none;padding:0;margin:0 0 16px 0;
        }
        .v-modal-list li {
            font-size:12px;color:rgba(255,255,255,0.45);
            padding:3px 0;
        }
        .v-modal-list li::before {
            content:'•';color:rgba(255,255,255,0.12);margin-right:8px;
        }
        .v-modal-footer {
            display:flex;justify-content:flex-end;gap:8px;
            padding-top:4px;border-top:1px solid rgba(255,255,255,0.03);
        }
        .v-modal-footer .v-btn { padding:6px 16px;font-size:11px; }
        .v-modal-footer .v-btn.primary { color:#90959c; }
        .v-modal-footer .v-btn.primary:hover { color:#c0c5ca;border-color:rgba(255,255,255,0.1); }

        /* Add proxy form (inline, bottom of proxy column) */
        .v-addform {
            padding:6px 14px;border-top:1px solid rgba(255,255,255,0.035);
            background:rgba(255,255,255,0.01);display:none;
            gap:5px;align-items:center;flex-shrink:0;
        }
        .v-addform.open { display:flex; }
        .v-addform input {
            padding:4px 7px;border-radius:3px;
            border:1px solid rgba(255,255,255,0.06);
            background:rgba(0,0,0,0.22);color:rgba(255,255,255,0.55);
            font-size:11px;font-family:'SF Mono','Roboto Mono',monospace;
            outline:none;transition:border-color 0.15s;
        }
        .v-addform input:focus { border-color:rgba(16,182,133,0.35); }
        .v-addform input::placeholder { color:rgba(255,255,255,0.08); }

        /* Bulk add textarea */
        .v-bulkform {
            padding:8px 14px;border-top:1px solid rgba(255,255,255,0.035);
            background:rgba(255,255,255,0.01);display:none;
            flex-direction:column;gap:6px;flex-shrink:0;
        }
        .v-bulkform.open { display:flex; }
        .v-bulkform textarea {
            width:100%;min-height:80px;max-height:160px;resize:vertical;
            padding:6px 8px;border-radius:3px;
            border:1px solid rgba(255,255,255,0.06);
            background:rgba(0,0,0,0.22);color:rgba(255,255,255,0.55);
            font-size:11px;font-family:'SF Mono','Roboto Mono',monospace;
            outline:none;transition:border-color 0.15s;
            line-height:1.5;
        }
        .v-bulkform textarea:focus { border-color:rgba(16,182,133,0.35); }
        .v-bulkform textarea::placeholder { color:rgba(255,255,255,0.08); }
        .v-bulkform-hint {
            font-size:9px;color:rgba(255,255,255,0.12);
        }
        .v-bulkform-actions { display:flex;justify-content:flex-end;gap:6px; }

        /* ── VPN Instance cards (matches Randomize tab style, compact) ── */
        .v-inst-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            padding: 2px;
        }
        .v-inst-grid::-webkit-scrollbar { width: 3px; }
        .v-inst-grid::-webkit-scrollbar-thumb { background: #23272c; border-radius: 2px; }
        .v-inst-card {
            background: #22262b;
            border: 1px solid rgba(255,255,255,0.03);
            border-radius: 5px;
            padding: 7px 10px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }
        .v-inst-card:hover {
            border-color: rgba(255,255,255,0.06);
            background: #262a2f;
        }
        .v-inst-card.selected {
            border-color: rgba(16,182,133,0.2);
            background: rgba(16,182,133,0.04);
        }
        .v-inst-card.selected::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 2px;
            background: #10B685;
            border-radius: 0 1px 1px 0;
        }
        .v-inst-card.offline {
            opacity: 0.35;
        }
        .v-inst-card-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .v-inst-card-dot.on { background: #10B685; }
        .v-inst-card-dot.warn { background: #e6a23c; }
        .v-inst-card-dot.err { background: #e65c5c; }
        .v-inst-card-dot.off { background: #2e3237; }
        .v-inst-card-info {
            flex: 1;
            min-width: 0;
        }
        .v-inst-card-name {
            font-size: 0.62rem;
            font-weight: 500;
            color: #b0b5ba;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .v-inst-card.selected .v-inst-card-name { color: #10B685; }
        .v-inst-card-meta {
            font-size: 0.48rem;
            color: #4a4f54;
            margin-top: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .v-inst-card-check {
            width: 12px; height: 12px;
            border-radius: 3px;
            border: 1.5px solid rgba(255,255,255,0.08);
            flex-shrink: 0;
            transition: all 0.15s;
        }
        .v-inst-card.selected .v-inst-card-check {
            background: none;
            border-color: transparent;
        }
        .v-inst-card.selected .v-inst-card-check::after {
            content: '✓';
            font-size: 9px;
            color: #10B685;
            position: relative;
            top: -2px;
            left: 0px;
        }
        .v-inst-card-disc {
            position: absolute;
            top: 3px; right: 3px;
            width: 14px; height: 14px;
            border: none; background: none;
            color: rgba(255,255,255,0.15);
            font-size: 10px;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .v-inst-card-disc:hover {
            color: #e65c5c;
            background: rgba(230,92,92,0.1);
        }

        /* ── Proxy card layout ── */
        .v-proxy-card {
            border-bottom: 1px solid rgba(255,255,255,0.025);
        }
        .v-proxy-card:hover {
            background: rgba(255,255,255,0.012);
        }
        .v-proxy-main {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 14px;
            cursor: pointer;
        }
        .v-proxy-sub {
            padding: 0 14px 6px 30px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .v-proxy-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }
        .v-proxy-tag {
            font-size: 8px;
            padding: 1px 6px;
            border-radius: 3px;
            background: rgba(16, 182, 133, 0.06);
            color: rgba(16, 182, 133, 0.5);
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            white-space: nowrap;
        }
        .v-proxy-toggles {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .v-toggle-wrap {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .v-toggle-label {
            font-size: 8px;
            color: rgba(255,255,255,0.12);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            user-select: none;
        }
        .v-toggle {
            width: 24px;
            height: 12px;
            border-radius: 6px;
            background: rgba(255,255,255,0.06);
            position: relative;
            cursor: pointer;
            transition: background 0.15s;
            flex-shrink: 0;
        }
        .v-toggle.active {
            background: rgba(16, 182, 133, 0.35);
        }
        .v-toggle::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.25);
            top: 2px;
            left: 2px;
            transition: transform 0.15s;
        }
        .v-toggle.active::after {
            transform: translateX(12px);
            background: rgba(255,255,255,0.7);
        }
        .v-proxy-edit {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.06);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.12s;
            flex-shrink: 0;
        }
        .v-proxy-edit:hover {
            color: rgba(255,255,255,0.25);
            background: rgba(255,255,255,0.04);
        }
        /* Selected proxy card */
        .v-proxy-card.selected {
            background: rgba(255,255,255,0.035);
            border-left: 2px solid rgba(255,255,255,0.2);
        }
        .v-proxy-card.selected .v-proxy-ip { color: rgba(255,255,255,0.45); }

        /* Action buttons row */
        .ut-actions {
            display: flex;
            align-items: center;
            gap: 2px;
            flex-shrink: 0;
        }
        .ut-act {
            width: 24px; height: 24px;
            border-radius: 3px;
            border: none;
            background: transparent;
            color: #3a3f48;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.12s;
            padding: 0;
        }
        .ut-act:hover {
            background: rgba(255,255,255,0.04);
            color: #80858a;
        }
        .ut-act svg {
            width: 12px; height: 12px;
            fill: none; stroke: currentColor;
            stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round;
        }
        .ut-act.loading { pointer-events: none; }
        .ut-act.loading svg { animation: spin 0.8s linear infinite; }

        /* Per-action hover colors */
        .ut-act-start:hover { color: #10B685; background: rgba(16,182,133,0.06); }
        .ut-act-stop:hover { color: #e05545; background: rgba(224,85,69,0.06); }
        .ut-act-stop svg { fill: currentColor; stroke: none; }
        .ut-act-delete:hover { color: #dc3545; background: rgba(220,53,69,0.06); }
        .ut-act-rand:hover { color: #b0b5ba; background: rgba(255,255,255,0.04); }

        /* Disabled actions */
        .ut-act.disabled {
            opacity: 0.15;
            pointer-events: none;
            cursor: default;
        }

        /* Randomize action strip */
        .rand-action-strip {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            margin: 14px 0 0;
            height: 62px;
            background: #1f2327;
            border-radius: 4px;
            opacity: 0;
            transform: translateY(4px);
            pointer-events: none;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .rand-action-strip.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        .rand-strip-text {
            font-size: 0.74rem;
            font-weight: 500;
            color: #6a6f76;
            letter-spacing: 0.005em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .btn-randomize-all {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 7px;
            padding: 10px 20px;
            background: transparent;
            color: #8a8f94;
            border: 1px solid #8a8f94;
            border-radius: 4px;
            font-family: 'Raleway', 'Open Sans', sans-serif;
            font-size: 0.68rem;
            font-weight: 500;
            letter-spacing: 0.01em;
            cursor: default;
            transition: color 0.3s, background 0.3s, border-color 0.3s, opacity 0.3s;
            flex-shrink: 0;
            opacity: 0.35;
        }
        .btn-randomize-all .btn-icon {
            width: 14px; height: 14px;
            fill: none; stroke: currentColor;
            stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
        }
        /* Activated state — instances selected */
        .btn-randomize-all.active {
            opacity: 1;
            cursor: pointer;
        }
        .btn-randomize-all.active:hover {
            background: rgba(16,182,133,0.06);
            border-color: #a0a5aa;
            color: #a0a5aa;
        }
        .btn-randomize-all.active:active {
            background: rgba(16,182,133,0.10);
        }
        /* Running state */
        .btn-randomize-all.running {
            opacity: 0.6;
            cursor: default;
        }
        /* Shuffle icon loading — whole icon spins */
        .btn-icon.loading {
            animation: icoSpin 1.2s linear infinite;
        }
        @keyframes icoSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* ═══════ ADVANCED TAB ═══════ */
        .adv-cards-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            max-width: 860px;
            margin: 0 auto;
        }
        .adv-card {
            width: 240px;
            height: 200px;
            background: #22262b;
            border: 1px solid rgba(255,255,255,0.04);
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 14px;
            padding: 24px;
            cursor: pointer;
            box-sizing: border-box;
            transition: border-color 0.35s ease;
        }
        .adv-card.selected {
            border-color: #8a8f94;
        }
        .adv-card-watermark { display: none; }
        .adv-wm-discord { display: none; }
        .adv-card-icon {
            width: 86px;
            height: 86px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .adv-card-icon svg {
            width: 78px;
            height: 78px;
            fill: none;
            stroke: #6a6f76;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .adv-card.selected .adv-card-icon svg {
            stroke: #b0b5ba;
        }
        .adv-card-label {
            font-size: 0.78rem;
            font-weight: 500;
            color: #6a6f76;
            letter-spacing: 0.01em;
        }
        .adv-card.selected .adv-card-label {
            color: #b0b5ba;
        }
        .adv-card-hint {
            font-size: 0.52rem;
            color: #50555a;
            letter-spacing: 0.02em;
            margin-top: -8px;
        }
        .adv-label-arrow { display: none; }

        /* ── Shield progress animation (Fix Permissions step) ── */
        .perm-anim-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        .perm-anim-icon {
            width: 20px;
            height: 20px;
            max-width: 20px;
            max-height: 20px;
            position: relative;
            overflow: hidden;
        }
        /* Gray rail shield (always visible behind the trace) */
        .perm-shield-rail {
            fill: none;
            stroke: rgba(255,255,255,0.06);
            stroke-width: 1.4;
            stroke-linejoin: round;
        }
        /* Green trace that draws around the shield — loops back and forth */
        .perm-shield-trace {
            fill: none;
            stroke: #10B685;
            stroke-width: 1.4;
            stroke-linejoin: round;
        }
        .perm-shield-trace.animating {
            animation: shieldDraw 3s ease-in-out infinite alternate;
        }
        @keyframes shieldDraw {
            0%   { stroke-dashoffset: var(--path-len); }
            100% { stroke-dashoffset: 0; }
        }
        /* Shield fade-out — NO scale, just opacity */
        .perm-shield-svg {
            width: 20px; height: 20px;
            max-width: 20px; max-height: 20px;
            display: block;
            transition: opacity 0.5s ease;
        }
        .perm-shield-svg.hiding {
            opacity: 0;
        }
        /* Checkmark that replaces shield */
        .perm-check-svg {
            position: absolute;
            top: 0; left: 0;
            width: 20px; height: 20px;
            max-width: 20px; max-height: 20px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .perm-check-svg.visible {
            opacity: 1;
        }
        .perm-check-line {
            fill: none;
            stroke: #10B685;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .perm-check-line.drawing {
            animation: checkStroke 0.5s ease-out forwards;
        }
        @keyframes checkStroke {
            0%   { stroke-dashoffset: var(--check-len); }
            100% { stroke-dashoffset: 0; }
        }
        /* Label */
        .perm-anim-label {
            font-size: 0.56rem;
            color: #606569;
            text-align: center;
            line-height: 1.5;
            letter-spacing: 0.01em;
            transition: opacity 0.35s ease;
            max-width: 100%;
            overflow: hidden;
            word-break: break-word;
        }
        .perm-anim-label.success {
            color: #10B685;
        }

        /* ── Card icon animations ── */

        /* Setup wand — sparkles twinkle */
        .adv-wand-sparkle > path:nth-child(1) {
            animation: wandTwinkle1 2.4s ease-in-out infinite;
        }
        .adv-wand-sparkle > path:nth-child(2) {
            animation: wandTwinkle2 2.4s ease-in-out 0.6s infinite;
        }
        .adv-wand-sparkle > path:nth-child(3) {
            animation: wandTwinkle3 2.4s ease-in-out 1.2s infinite;
        }
        @keyframes wandTwinkle1 {
            0%, 100% { opacity: 0.9; transform: scale(1); }
            50% { opacity: 0.2; transform: scale(0.7); }
        }
        @keyframes wandTwinkle2 {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.1; transform: scale(0.6); }
        }
        @keyframes wandTwinkle3 {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 0.05; transform: scale(0.5); }
        }

        /* Download — arrow bobs, cloud fills up and drains */
        .adv-dl-arrow {
            animation: dlArrowBob 2s ease-in-out infinite;
        }
        @keyframes dlArrowBob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(3px); }
        }
        /* Cloud fill uses SMIL <animate> in the SVG */

        /* Clone — phones drift apart and back together */
        .adv-clone-back {
            animation: cloneDrift 3s ease-in-out infinite;
        }
        .adv-clone-arrow {
            animation: cloneArrowNudge 3s ease-in-out infinite;
        }
        @keyframes cloneDrift {
            0%, 100% { transform: translate(0, 0); opacity: 0.35; }
            50% { transform: translate(6px, -4px); opacity: 0.6; }
        }
        @keyframes cloneArrowNudge {
            0%, 100% { transform: translateX(0); opacity: 0.5; }
            50% { transform: translateX(3px); opacity: 0.9; }
        }

        /* Help — typing dots bounce in sequence */
        .adv-type-1 { animation: typeDot 1.4s ease-in-out infinite; }
        .adv-type-2 { animation: typeDot 1.4s ease-in-out 0.2s infinite; }
        .adv-type-3 { animation: typeDot 1.4s ease-in-out 0.4s infinite; }
        @keyframes typeDot {
            0%, 100% { opacity: 0.15; transform: translateY(0); }
            50% { opacity: 0.9; transform: translateY(-3px); }
        }


        /* Per-instance progress panel */
        .rand-progress-panel {
            background: #1c1f22;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.03);
            overflow: hidden;
            margin-top: 20px;
            animation: paneIn 0.25s ease-out;
        }
        .rand-progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.035);
        }
        .rand-progress-title {
            font-size: 0.62rem;
            font-weight: 500;
            color: #80858a;
            letter-spacing: 0.01em;
        }
        .rand-progress-counter {
            font-size: 0.54rem;
            font-weight: 500;
            color: #9a9fa4;
            font-family: 'Open Sans', sans-serif;
            background: rgba(255,255,255,0.04);
            padding: 2px 8px;
            border-radius: 3px;
            letter-spacing: 0.02em;
        }
        .rand-progress-counter .counter-done { color: #c8ccd0; }
        .rand-progress-list {
            padding: 2px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .rand-progress-list::-webkit-scrollbar { width: 3px; }
        .rand-progress-list::-webkit-scrollbar-track { background: transparent; }
        .rand-progress-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 2px; }

        .rand-prog-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.025);
            transition: background 0.15s;
        }
        .rand-prog-item:last-child { border-bottom: none; }
        .rand-prog-item.done { background: rgba(255,255,255,0.01); }
        .rand-prog-item.fail { background: rgba(224,85,69,0.02); }

        .rand-prog-indicator {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: rgba(255,255,255,0.03);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: background 0.3s, border-color 0.3s;
            border: 1.5px solid rgba(255,255,255,0.05);
        }
        .rand-prog-indicator svg {
            width: 11px;
            height: 11px;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        .rand-prog-indicator.waiting { border-color: rgba(255,255,255,0.05); }
        .rand-prog-indicator.waiting svg { stroke: #4a4f54; }
        .rand-prog-indicator.active {
            border-color: rgba(16,182,133,0.2);
            background: rgba(16,182,133,0.06);
        }
        .rand-prog-indicator.active svg { stroke: #10B685; }
        .rand-prog-indicator.ok {
            border-color: rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.04);
        }
        .rand-prog-indicator.ok svg { stroke: #8a8f94; }
        .rand-prog-indicator.fail {
            border-color: rgba(224,85,69,0.2);
            background: rgba(224,85,69,0.06);
        }
        .rand-prog-indicator.fail svg { stroke: #e05545; }

        .rand-prog-body { flex: 1; min-width: 0; }
        .rand-prog-name {
            font-size: 0.64rem;
            font-weight: 500;
            color: #b0b5ba;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 5px;
        }
        .rand-prog-track {
            width: 100%;
            height: 2px;
            background: rgba(255,255,255,0.04);
            border-radius: 1px;
            overflow: hidden;
        }
        .rand-prog-fill {
            height: 100%;
            width: 0%;
            background: rgba(255,255,255,0.12);
            border-radius: 1px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .rand-prog-fill.fail { background: #e05545; }

        .rand-prog-status {
            font-size: 0.54rem;
            color: #4a4f54;
            min-width: 56px;
            text-align: right;
            font-weight: 400;
            flex-shrink: 0;
            transition: color 0.2s;
        }
        .rand-prog-status.ok { color: #80858a; }
        .rand-prog-status.fail { color: #e05545; }
        .rand-prog-status.active { color: #80858a; }

    </style>
</head>
<body>

<!-- (particle canvas removed) -->

<!-- Top progress bar -->
<div class="top-progress" id="topProgress"></div>

<div class="window">

    <!-- Header (brand + tabs + controls in one bar) -->
    <div class="header">
        <div class="header-left">
            <div class="header-brand">
                <span class="header-appname"><b>Luke's Mirage</b> | Instance Manager</span>
                <span class="header-version">v2.1</span>
            </div>
        </div>
        <div class="header-sep"></div>
        <div class="tabs" id="tabBar">
            <button class="tab-btn active" data-tab="advanced" onclick="switchTab('advanced')">Cloning</button>
            <button class="tab-btn" data-tab="randomize" onclick="switchTab('randomize')">Randomize Instances</button>
            <button class="tab-btn" data-tab="vpn" onclick="switchTab('vpn')">VPN</button>
            <div class="tab-indicator" id="tabIndicator"></div>
        </div>
        <div class="header-right">
            <button class="header-circle" id="togglePathsBtn" title="Toggle Paths" onclick="togglePaths()">
                <svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
            </button>
            <button class="header-circle" id="toggleLogBtn" title="Toggle Activity" onclick="toggleLog()">
                <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            </button>
            <button class="header-circle" title="Reset Setup" onclick="resetSetup()">
                <svg viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
            </button>
        </div>
    </div>

    <!-- Page title strip -->
    <div class="page-title-strip">
        <div class="page-title-left">
            <span class="page-title-heading" id="heroHeading">Set up your instances</span>
            <div class="page-title-sep"></div>
            <span class="page-title-sub" id="heroSub">Configure engine paths</span>
        </div>
        <div class="page-title-right" id="heroStats">
            <div class="hero-chip"><span class="chip-val" id="chipInstances">0</span> instances</div>
            <div class="stat-sep"></div>
            <div class="hero-chip"><span class="chip-val" id="chipRunning">0</span> active</div>
        </div>
    </div>

    <!-- Steps -->
    <div class="steps-label">Setup progress</div>
    <div class="setup-hero" id="setupHero">
        <div class="setup-hero-title">Initial Setup</div>
        <div class="setup-hero-sub">We'll detect your BlueStacks installation and set up your clones</div>
    </div>
    <div class="steps-wrapper">
        <div class="steps-connector">
            <div class="steps-connector-fill" id="connectorFill" style="width:0%"></div>
        </div>
        <div class="steps-row" id="stepsRow">
            <div class="step-card" id="step0">
                <div class="step-current-label">Current step</div>
                <div class="step-badge">In Progress</div>
                <div class="step-time"></div>
                <div class="step-visual" id="stepVis0">
                    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </div>
                <div class="step-title">BlueStacks<br>Setup</div>
                <div class="step-desc">v5.21.755.7538</div>
                <div class="step-action">
                    <div class="step-status" id="step0Status"></div>
                    <div class="step-action-split step-action-single" id="step0Actions" style="display:none">
                        <button class="step-split-btn" id="step0InstallBtn" onclick="doWizardInstall()">
                            <span class="step-split-icon"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></span>
                            <span class="step-split-label">Install</span>
                            <div class="dl-btn-progress"></div>
                        </button>
                    </div>
                </div>
            </div>
            <div class="step-card" id="step1">
                <div class="step-current-label">Current step</div>
                <div class="step-badge">In Progress</div>
                <div class="step-time"></div>
                <div class="step-visual" id="stepVis1">
                    <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                </div>
                <div class="step-title">Verify<br>Paths</div>
                <div class="step-desc">Config &amp; ADB verified</div>
                <div class="step-action">
                    <div class="step-status" id="step1Status"></div>
                    <div class="step-action-split step-action-single" id="step1Actions" style="display:none">
                        <button class="step-split-btn" id="step1RetryBtn" onclick="doWizardRetryPaths()">
                            <svg class="step-split-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            <span class="step-split-label">Retry</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="step-card" id="step2">
                <div class="step-current-label">Current step</div>
                <div class="step-badge">In Progress</div>
                <div class="step-time"></div>
                <div class="step-visual" id="stepVis2">
                    <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 6c1.4 0 2.8 1.1 2.8 2.5V11c.6 0 1.2.6 1.2 1.2v3.5c0 .7-.6 1.3-1.2 1.3H9.2c-.7 0-1.2-.6-1.2-1.2v-3.5c0-.7.6-1.3 1.2-1.3V9.5C9.2 8.1 10.6 7 12 7zm0 1.2c-.8 0-1.5.7-1.5 1.3V11h3V9.5c0-.6-.7-1.3-1.5-1.3z"/></svg>
                </div>
                <div class="step-title">Root<br>BlueStacks</div>
                <div class="step-desc">Magisk &amp; Kitsune</div>
                <div class="step-action">
                    <div class="step-status" id="step2Status"></div>
                    <div class="step-action-split step-action-single" id="step2Actions" style="display:none">
                        <button class="step-split-btn" id="step2RootBtn" onclick="doWizardRoot()">
                            <span class="step-split-icon"><svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg></span>
                            <span class="step-split-label">Root Now</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="step-card" id="step3">
                <div class="step-current-label">Current step</div>
                <div class="step-badge">In Progress</div>
                <div class="step-time"></div>
                <div class="step-visual" id="stepVis3">
                    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </div>
                <div class="step-title">Download<br>Image</div>
                <div class="step-desc">Android 13 instance</div>
                <div class="step-action">
                    <div class="step-status" id="step3Status"></div>
                    <div class="step-action-split" id="step3Actions" style="display:none">
                        <button class="step-split-btn" id="step3DlBtn" onclick="doWizardDownload()">
                            <span class="step-split-icon"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></span>
                            <span class="step-split-label">Download</span>
                            <div class="dl-btn-progress"></div>
                        </button>
                        <div class="step-split-divider"></div>
                        <button class="step-split-btn" id="step3Bypass" onclick="bypassWizardImage()">
                            <span class="step-split-icon"><svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></span>
                            <span class="step-split-label">Own Source</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="step-card" id="step4">
                <div class="step-current-label">Current step</div>
                <div class="step-badge">In Progress</div>
                <div class="step-time"></div>
                <div class="step-visual" id="stepVis4">
                    <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/><circle cx="12" cy="16" r="1"/></svg>
                </div>
                <div class="step-title">Fix<br>Permissions</div>
                <div class="step-desc">Config access &amp; root</div>
                <div class="step-action">
                    <div class="step-status" id="step4Status"></div>
                    <div class="step-action-split step-action-single" id="step4Actions" style="display:none">
                        <button class="step-split-btn" id="step4FixBtn" onclick="doWizardPermissions()">
                            <span class="step-split-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></span>
                            <span class="step-split-label">Fix Permissions</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="setup-hint" id="setupHint">
        No instances showing up? Create them in BlueStacks Multi-Instance Manager first, then launch each one once before continuing.
    </div>

    <div class="divider"></div>

    <!-- Content area -->
    <div class="content">

        <!-- Path inputs (shared) -->
        <div class="paths hidden">
            <div class="path-field">
                <span class="path-label">Engine</span>
                <span class="path-value" id="enginePath">Detecting...</span>
                <button class="path-browse" onclick="browseEngineDir()">Browse</button>
            </div>
            <div class="path-field">
                <span class="path-label">Install</span>
                <span class="path-value" id="bsPath">—</span>
            </div>
        </div>

        <!-- ═══════ RANDOMIZE TAB ═══════ -->
        <div class="tab-pane" id="pane-randomize">

            <!-- Info notice -->
            <div class="rand-bar" id="randNotice">
                <div class="rand-bar-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></div>
                <div class="rand-bar-body">
                    <div class="rand-bar-title">Instances must be running</div>
                    <div class="rand-bar-text">Open your emulators in BlueStacks before randomizing. Greyed out instances are offline.</div>
                </div>
                <button class="rand-bar-dismiss" onclick="this.parentElement.style.display='none'" title="Dismiss">&times;</button>
            </div>

            <!-- Unified instance table -->
            <div class="ut-wrap" id="utWrap">
                <div class="ut-topbar">
                    <div class="ut-topbar-left">
                        <img class="ut-logo" src="bs-air.png" alt="" draggable="false">
                        <div class="ut-counts">
                            <span class="ut-count-val" id="utRunning">0</span>
                            <span class="ut-count-label">running</span>
                            <span class="ut-count-sep">·</span>
                            <span class="ut-count-val ut-count-val-dim" id="utOffline">0</span>
                            <span class="ut-count-label">offline</span>
                            <span class="ut-count-sep">·</span>
                            <span class="ut-count-val ut-count-val-dim" id="utTotal">0</span>
                            <span class="ut-count-label">total</span>
                        </div>
                    </div>
                    <div class="ut-topbar-right">
                        <button class="ut-btn" id="utBtnStartAll" onclick="utStartAll()">Start All</button>
                        <button class="ut-btn" id="utBtnStopAll" onclick="utStopAll()">Stop All</button>
                        <div class="ut-topbar-divider"></div>
                        <button class="ut-btn" id="utBtnRefresh" onclick="utRefresh()">Refresh</button>
                    </div>
                </div>
                <div class="ut-grid" id="utGrid">
                    <div class="ut-empty"><span class="spinner" style="width:14px;height:14px"></span> Scanning for instances...</div>
                </div>
            </div>

            <!-- Per-instance progress (shown during randomization) -->
            <div class="rand-progress-panel" id="randProgressPanel" style="display:none">
                <div class="rand-progress-header">
                    <span class="rand-progress-title">Operation Progress</span>
                    <span class="rand-progress-counter" id="randProgressCounter"><span class="counter-done">0</span> of 0</span>
                </div>
                <div class="rand-progress-list" id="randProgressList"></div>
            </div>
        </div>

        <!-- ═══════ VPN TAB ═══════ -->
        <div class="tab-pane" id="pane-vpn">
        <div class="v">

            <!-- Top bar: Suborbital auth -->
            <div class="v-topbar" id="vTopbar">
                <span style="font-size:10px;font-weight:500;color:rgba(255,255,255,0.15);letter-spacing:0.04em;text-transform:uppercase">Suborbital</span>
                <div class="v-topbar-spacer"></div>
                <span class="v-topbar-stat" id="vAuthStat"></span>
                <input type="email" class="v-input" id="vpnSubUser" placeholder="email" spellcheck="false" autocomplete="off" style="width:140px" />
                <input type="password" class="v-input" id="vpnSubPass" placeholder="password" autocomplete="off" style="width:100px" />
                <button class="v-btn primary" id="vAuthSignIn" onclick="vpnSuborbitalLogin()">Login</button>
                <button class="v-btn" id="vAuthRefresh" onclick="vpnFetchSuborbital()" style="display:none">↻</button>
                <button class="v-btn" id="vAuthLogout" onclick="vpnSuborbitalLogout()" style="display:none">Logout</button>
            </div>

            <!-- Two-column body -->
            <div class="v-body">

                <!-- Left column: Instances -->
                <div class="v-col" id="vColInst">
                    <div class="v-col-head">
                        <span class="v-col-title">Instances</span>
                        <div style="display:flex;gap:4px">
                            <button class="v-btn danger" id="vDiscAllBtn" onclick="vpnDisconnectAll()" style="display:none;font-size:9px;padding:3px 9px">Disconnect All</button>
                            <button class="v-link-btn" id="vLinkBtn" onclick="vpnShowLinkModal()">Link</button>
                        </div>
                    </div>
                    <div id="vInstList">
                        <div class="v-empty">No instances detected</div>
                    </div>
                </div>

                <!-- Right column: Proxies -->
                <div class="v-col" id="vColProxy">
                    <div class="v-col-head">
                        <span class="v-col-title">Proxies</span>
                        <div style="display:flex;gap:4px">
                            <button class="v-btn" onclick="vpnAddProxy()" style="font-size:9px;padding:3px 9px">+ Add</button>
                            <button class="v-btn" onclick="vpnBulkAdd()" style="font-size:9px;padding:3px 9px">Bulk Add</button>
                        </div>
                    </div>
                    <div id="vProxyList">
                        <div class="v-empty">Sign in or add proxies</div>
                    </div>
                    <!-- Bulk add form -->
                    <div class="v-bulkform" id="vBulkForm">
                        <textarea id="vpnBulkText" placeholder="host:port:username:password&#10;host:port:username:password:label" spellcheck="false"></textarea>
                        <div class="v-bulkform-hint">Format: host:port:username:password — optional label at end</div>
                        <div class="v-bulkform-actions">
                            <button class="v-btn" onclick="vpnCancelBulk()">Cancel</button>
                            <button class="v-btn primary" onclick="vpnParseBulk()">Import</button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Link confirmation modal -->
            <div class="v-modal-overlay" id="vLinkModal">
                <div class="v-modal">
                    <div class="v-modal-title" id="vLinkModalTitle">Confirm proxy linking</div>
                    <div class="v-modal-proxy" id="vLinkModalProxy"></div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.35);margin-bottom:6px">will be linked to the following instance(s):</div>
                    <ul class="v-modal-list" id="vLinkModalList"></ul>
                    <div class="v-modal-footer">
                        <button class="v-btn" onclick="vpnCloseLinkModal()">Cancel</button>
                        <button class="v-btn primary" onclick="vpnConfirmLink()">Link</button>
                    </div>
                </div>
            </div>

            <!-- Edit / Add proxy modal -->
            <div class="v-modal-overlay" id="vEditModal">
                <div class="v-modal">
                    <div class="v-modal-title" id="vEditModalTitle">Edit Proxy</div>
                    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
                        <input class="v-input" id="vEditLabel" placeholder="Label (e.g. US East)" spellcheck="false" style="width:100%" />
                        <div style="display:flex;gap:6px">
                            <input class="v-input" id="vEditServer" placeholder="Host / IP" spellcheck="false" style="flex:1" />
                            <input class="v-input" id="vEditPort" type="number" placeholder="Port" value="1337" style="width:60px" />
                        </div>
                        <div style="display:flex;gap:6px">
                            <input class="v-input" id="vEditUser" placeholder="Username" spellcheck="false" style="flex:1" />
                            <input class="v-input" id="vEditPass" type="password" placeholder="Password" style="flex:1" />
                        </div>
                    </div>
                    <input id="vEditId" type="hidden" value="" />
                    <div class="v-modal-footer">
                        <button class="v-btn" onclick="vpnCloseEditModal()">Cancel</button>
                        <button class="v-btn primary" onclick="vpnSaveFromModal()">Save</button>
                    </div>
                </div>
            </div>

        </div>
        </div>

        <!-- ═══════ CLONE TAB ═══════ -->
        <!-- ═══════ ADVANCED TAB ═══════ -->
        <div class="tab-pane" id="pane-advanced">
            <div class="adv-cards-row" id="advCardsRow">
                <div class="adv-card" data-option="wizard" onclick="selectAdvCard('wizard')">
                    <div class="adv-card-icon">
                        <svg viewBox="0 0 80 80">
                            <!-- Wand stick -->
                            <line class="adv-wand-stick" x1="18" y1="62" x2="48" y2="32" stroke-width="2.2" stroke-linecap="round"/>
                            <!-- Wand tip sparkle -->
                            <g class="adv-wand-sparkle">
                                <path d="M52 28 L52 18 M47 23 L57 23" stroke-width="1.6" stroke-linecap="round"/>
                                <path d="M60 34 L60 28 M57 31 L63 31" stroke-width="1.2" stroke-linecap="round" opacity="0.5"/>
                                <path d="M44 16 L44 12 M42 14 L46 14" stroke-width="1" stroke-linecap="round" opacity="0.4"/>
                            </g>
                        </svg>
                    </div>
                    <div class="adv-card-label">Setup<span class="adv-label-arrow">→</span></div>
                    <div class="adv-card-hint"></div>
                </div>

                <div class="adv-card" data-option="download" onclick="selectAdvCard('download')">
                    <img class="adv-card-watermark" src="bs.png" alt="" draggable="false" style="transform:translate(-50%,-50%) rotate(-15deg)">
                    <div class="adv-card-icon">
                        <svg viewBox="0 0 80 80">
                            <defs>
                                <clipPath id="cloudClip">
                                    <path d="M22 38c-1-0.5-2-1.5-2.5-3a7 7 0 0 1 1-13.5 12 12 0 0 1 11.5-9 11.5 11.5 0 0 1 11 7.5 9 9 0 0 1 12 8.5c0 .2 0 .3 0 .5a7 7 0 0 1-2 13.5H22z"/>
                                </clipPath>
                            </defs>
                            <!-- Cloud fill — water level rises from bottom to top using SMIL -->
                            <rect x="14" y="42" width="46" height="0" clip-path="url(#cloudClip)" fill="currentColor" opacity="0.15">
                                <animate attributeName="y" values="42;10;10;42" keyTimes="0;0.6;0.85;1" dur="4s" repeatCount="indefinite"/>
                                <animate attributeName="height" values="0;32;32;0" keyTimes="0;0.6;0.85;1" dur="4s" repeatCount="indefinite"/>
                            </rect>
                            <!-- Cloud outline -->
                            <path d="M22 38c-1-0.5-2-1.5-2.5-3a7 7 0 0 1 1-13.5 12 12 0 0 1 11.5-9 11.5 11.5 0 0 1 11 7.5 9 9 0 0 1 12 8.5c0 .2 0 .3 0 .5a7 7 0 0 1-2 13.5H22z" fill="none" stroke-width="1.6"/>
                            <!-- Download arrow (animated bob) -->
                            <g class="adv-dl-arrow">
                                <line x1="40" y1="46" x2="40" y2="62" stroke-width="1.8"/>
                                <polyline points="33 56 40 63 47 56" stroke-width="1.8" fill="none"/>
                            </g>
                        </svg>
                    </div>
                    <div class="adv-card-label">Download<span class="adv-label-arrow">→</span></div>
                </div>

                <div class="adv-card" data-option="clone" onclick="selectAdvCard('clone')">
                    <img class="adv-card-watermark" src="bs.png" alt="" draggable="false" style="transform:translate(-50%,-50%) rotate(-15deg)">
                    <div class="adv-card-icon">
                        <svg viewBox="0 0 80 80">
                            <!-- Back phone/device (animated drift) -->
                            <g class="adv-clone-back">
                                <rect x="38" y="10" width="26" height="42" rx="3" ry="3" stroke-width="1.5" fill="none" opacity="0.4"/>
                                <line x1="48" y1="46" x2="54" y2="46" stroke-width="1.2" opacity="0.4"/>
                            </g>
                            <!-- Front phone/device -->
                            <rect x="16" y="18" width="26" height="42" rx="3" ry="3" stroke-width="1.8" fill="none"/>
                            <line x1="26" y1="54" x2="32" y2="54" stroke-width="1.2"/>
                            <!-- Screen content lines -->
                            <line x1="22" y1="28" x2="36" y2="28" stroke-width="1" opacity="0.5"/>
                            <line x1="22" y1="33" x2="32" y2="33" stroke-width="1" opacity="0.35"/>
                            <line x1="22" y1="38" x2="34" y2="38" stroke-width="1" opacity="0.25"/>
                            <!-- Arrow between devices (animated nudge) -->
                            <g class="adv-clone-arrow">
                                <path d="M44 39 L52 39" stroke-width="1.5" fill="none"/>
                                <polyline points="49.5 36 52.5 39 49.5 42" stroke-width="1.5" fill="none"/>
                            </g>
                            <!-- Sparkle -->
                            <path d="M58 60 L58 54 M55 57 L61 57" stroke-width="1.2" opacity="0.5"/>
                            <circle cx="58" cy="57" r="0.8" fill="currentColor" opacity="0.5"/>
                        </svg>
                    </div>
                    <div class="adv-card-label">Clone<span class="adv-label-arrow">→</span></div>
                </div>

                <div class="adv-card" data-option="lockupdates" onclick="doDisableAutoUpdates()">
                    <div class="adv-card-icon">
                        <svg viewBox="0 0 80 80">
                            <!-- Lock body -->
                            <rect x="22" y="36" width="36" height="28" rx="4" ry="4" stroke-width="1.8" fill="none"/>
                            <!-- Lock shackle -->
                            <path d="M28 36V26a12 12 0 0 1 24 0v10" stroke-width="1.8" fill="none"/>
                            <!-- Keyhole -->
                            <circle cx="40" cy="48" r="4" stroke-width="1.5" fill="none"/>
                            <line x1="40" y1="52" x2="40" y2="58" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div class="adv-card-label">Lock Updates<span class="adv-label-arrow">→</span></div>
                    <div class="adv-card-hint">Prevent BlueStacks auto-updating</div>
                </div>

                <div class="adv-card" data-option="help" onclick="selectAdvCard('help')">
                    <!-- Discord watermark -->
                    <svg class="adv-card-watermark adv-wm-discord" viewBox="0 0 127.14 96.36" fill="#5865F2" style="width:150px;height:auto;transform:translate(-50%,-50%) rotate(12deg)">
                        <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.25,105.25,0,0,0,126.6,80.22h0C129.24,52.84,122.09,29.11,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s2.39-12.72,11.45-12.72S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s2.39-12.72,11.45-12.72S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z"/>
                    </svg>
                    <div class="adv-card-icon">
                        <svg viewBox="0 0 80 80">
                            <!-- Chat bubble -->
                            <path d="M12 16h40a4 4 0 0 1 4 4v22a4 4 0 0 1-4 4H28l-10 8v-8h-6a4 4 0 0 1-4-4V20a4 4 0 0 1 4-4z" stroke-width="1.8" fill="none"/>
                            <!-- Typing dots (animated stagger) -->
                            <circle class="adv-type-1" cx="24" cy="31" r="2" fill="currentColor"/>
                            <circle class="adv-type-2" cx="33" cy="31" r="2" fill="currentColor"/>
                            <circle class="adv-type-3" cx="42" cy="31" r="2" fill="currentColor"/>
                            <!-- Person silhouette -->
                            <circle cx="60" cy="24" r="6" stroke-width="1.5" fill="none"/>
                            <path d="M50 44c0-5.5 4.5-10 10-10s10 4.5 10 10" stroke-width="1.5" fill="none"/>
                        </svg>
                    </div>
                    <div class="adv-card-label">Help<span class="adv-label-arrow">→</span></div>
                </div>
            </div>

        </div>

    </div>

    <!-- Log (pop-out only, hidden by default) -->
    <div class="log hidden-inline">
        <div class="log-bar">
            <div class="log-bar-left">
                <div class="log-dot" id="logDot"></div>
                <span class="log-label">Activity</span>
            </div>
            <button class="log-clear" onclick="clearLog()">Clear</button>
        </div>
        <div class="log-body" id="logBody">
            <div class="l"><span class="l-dot do"></span><span class="l-msg">Ready</span></div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="footer-left">
            <span class="footer-clock" id="footerClock"></span>
        </div>
        <span class="footer-center" id="footerBrand">Luke's Mirage | adapted for Mac by Lukas</span>
        <div class="footer-right">
            <span id="footerRight">python 3.x</span>
        </div>
    </div>

</div>

<!-- Command Palette -->
<div class="cmd-overlay" id="cmdOverlay" onclick="if(event.target===this)closeCmdPalette()">
    <div class="cmd-palette">
        <div class="cmd-input-wrap">
            <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input class="cmd-input" id="cmdInput" placeholder="Type a command..." autocomplete="off" spellcheck="false">
        </div>
        <div class="cmd-results" id="cmdResults"></div>
        <div class="cmd-footer">
            <span><kbd>↑↓</kbd> navigate</span>
            <span><kbd>↵</kbd> run</span>
            <span><kbd>esc</kbd> close</span>
        </div>
    </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Clone Modal -->
<!-- Download Modal — split panel -->
<div class="modal-overlay" id="downloadModal" style="display:none" onclick="if(event.target===this)closeDownloadModal()">
    <div class="modal-box" style="max-width:420px; min-height:auto; border-radius:4px;">
        <div class="dl-panel" id="dlPanelA13" onclick="startAdvDownload('a13')" style="padding:42px 28px;">
            <div class="dl-panel-logos">
                <img class="dl-logo-bs" src="bs-air.png" alt="BlueStacks Air" draggable="false">
                <span class="dl-logo-x">x</span>
                <img class="dl-logo-android" src="a13.png" alt="Android 13" draggable="false">
            </div>
            <div class="dl-panel-label">Download Android 13</div>
            <div class="dl-panel-meta">BlueStacks Tiramisu64</div>
        </div>
        <!-- Download progress bar (shown during download) -->
        <div id="dlModalProgress" style="display:none; padding:12px 24px 16px;">
            <div style="height:4px; border-radius:2px; background:rgba(255,255,255,0.06); overflow:hidden;">
                <div id="dlModalBar" style="height:100%;border-radius:2px;background:#10B685;width:0%;transition:width 0.3s;"></div>
            </div>
            <div id="dlModalText" style="font-size:0.6rem;color:#606468;margin-top:6px;text-align:center;"></div>
        </div>
    </div>
</div>

<!-- Advanced Clone Modal — create new or replace existing -->
<div class="modal-overlay" id="advCloneModal" style="display:none" onclick="if(event.target===this)closeAdvCloneModal()">
    <div class="modal-box" style="max-width:460px; min-height:auto; border-radius:6px;">
        <!-- Header -->
        <div class="modal-title-area">
            <div>
                <div class="modal-title" style="font-size:0.92rem; font-weight:600; letter-spacing:-0.01em;">Clone Instance</div>
                <div class="clone-subtitle" id="advCloneSubtitle">Create or replace instances from a source</div>
            </div>
            <button class="modal-topbar-btn" onclick="closeAdvCloneModal()" title="Close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>

        <!-- Source selector -->
        <div class="adv-clone-source-bar">
            <span class="adv-clone-source-label">Source Instance</span>
            <select id="advCloneSource" onchange="updateAdvCloneSelection()"></select>
        </div>

        <!-- Clone mode — segmented tab control -->
        <div class="adv-clone-mode-bar">
            <button id="advCloneModeNew" class="adv-clone-mode-btn active" onclick="setAdvCloneMode('new')">Create New</button>
            <button id="advCloneModeReplace" class="adv-clone-mode-btn" onclick="setAdvCloneMode('replace')">Replace Existing</button>
        </div>

        <!-- Replace existing instances -->
        <div class="adv-clone-panel" id="advCloneReplacePanel" hidden>
            <div class="adv-clone-targets" id="advCloneTargets"></div>
        </div>

        <!-- Create new instances -->
        <div class="adv-clone-panel" id="advCloneNewPanel">
            <div class="adv-clone-new-wrap">
                <div class="adv-clone-new-grid">
                    <div class="adv-clone-new-field">
                        <label for="advClonePrefix">Prefix</label>
                        <input id="advClonePrefix" type="text" placeholder="Tiramisu64">
                    </div>
                    <div class="adv-clone-new-field">
                        <label for="advCloneCount">Count</label>
                        <input id="advCloneCount" type="number" min="1" max="100" value="3">
                    </div>
                    <button class="adv-clone-new-btn" onclick="generateAdvCloneNames()">Generate</button>
                </div>
                <div class="adv-clone-entry-header">
                    <span>Engine Name</span>
                    <span>Display Name (MIM)</span>
                    <span></span>
                </div>
                <div class="adv-clone-entries" id="advCloneEntries">
                    <div class="adv-clone-no-entries">Click <b>Generate</b> to create entries</div>
                </div>
                <div class="adv-clone-new-hint">Engine names are auto-generated and read-only. Edit the Display Name shown in MIM.</div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn modal-btn-secondary" onclick="closeAdvCloneModal()">Cancel</button>
            <button class="btn btn-primary modal-btn-primary" id="btnAdvClone" onclick="startAdvClone()">Create Instances</button>
        </div>
    </div>
</div>

<!-- ═══════ Delete Instances Modal ═══════ -->
<div class="modal-overlay" id="deleteModal" style="display:none" onclick="if(event.target===this)closeDeleteModal()">
    <div class="del-modal">
        <!-- Top bar -->
        <div class="del-topbar">
            <span class="del-topbar-title">Instances</span>
            <button class="del-topbar-close" onclick="closeDeleteModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>

        <!-- Instance cards grid -->
        <div class="del-grid" id="delGrid"></div>

        <!-- Subtitle -->
        <div class="del-subtitle" id="deleteSubtitle">Select instances to remove.</div>

        <!-- Footer -->
        <div class="del-footer">
            <button class="btn modal-btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button class="del-btn-delete" id="btnDeleteConfirm" onclick="startDeleteInstances()" disabled>Delete Selected</button>
        </div>
    </div>
</div>

<!-- ═══════ Instance Manager Modal ═══════ -->
<div class="modal-overlay" id="imModal" style="display:none" onclick="if(event.target===this)closeImModal()">
    <div class="im-modal">
        <!-- Top bar -->
        <div class="im-topbar">
            <span class="im-topbar-title">Instances</span>
            <button class="im-topbar-close" onclick="closeImModal()">
                <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>

        <!-- Action bar -->
        <div class="im-actions">
            <!-- Left: status counts -->
            <div class="im-actions-left">
                <span class="im-summary-count" id="imRunningCount">0</span>
                <span class="im-summary-label">running</span>
                <span class="im-summary-sep">|</span>
                <span class="im-summary-count im-summary-count-dim" id="imOfflineCount">0</span>
                <span class="im-summary-label">offline</span>
            </div>

            <!-- Right: actions -->
            <div class="im-actions-right">
                <button class="im-bulk-btn" id="imBtnStartAll" onclick="imStartAll()" title="Start all offline">Start All</button>
                <button class="im-bulk-btn" id="imBtnStopAll" onclick="imStopAll()" title="Stop all running">Stop All</button>

                <!-- Selection actions — appear when instances selected -->
                <div class="im-sel-actions" id="imSelActions" style="display:none">
                    <div class="im-summary-divider"></div>
                    <span class="im-sel-label" id="imSelLabel">0 selected</span>
                    <button class="im-bulk-btn im-bulk-btn-danger" id="imBtnDeleteSel" onclick="imDeleteSelected()">Delete</button>
                </div>

                <div class="im-summary-divider"></div>
                <button class="im-bulk-btn" id="imBtnRefresh" onclick="imRefreshInstances()" title="Refresh">Refresh</button>
            </div>
        </div>

        <!-- Scrollable card grid -->
        <div class="im-grid" id="imGrid">
            <div class="empty-state">No instances loaded.</div>
        </div>
    </div>
</div>

<!-- ═══════ Randomize Results Modal ═══════ -->
<div class="modal-overlay" id="randResultsModal" style="display:none" onclick="if(event.target===this)closeRandResults()">
    <div class="rr-modal">
        <div class="rr-topbar">
            <span class="rr-topbar-title">Randomization Results</span>
            <button class="del-topbar-close" onclick="closeRandResults()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <!-- Instance tabs -->
        <div class="rr-tabs" id="rrTabs"></div>
        <!-- Before / After table -->
        <div class="rr-body" id="rrBody"></div>
        <!-- Footer -->
        <div class="del-footer">
            <button class="btn modal-btn-secondary" onclick="closeRandResults()">Close</button>
        </div>
    </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════════════════
// (particle system removed)


// ═══════════════════════════════════════════════════════════════════════════════
//  LOTTIE ANIMATED ICONS
// ═══════════════════════════════════════════════════════════════════════════════
const LOTTIE_ANIMS = {};

// Inline Lottie JSON data for each step icon
// These are minimal hand-crafted animation definitions
const lottieData = {
    // Step 0: Folder check — draw a checkmark
    folder: {"v":"5.7.1","fr":30,"ip":0,"op":30,"w":52,"h":52,"layers":[
        {"ty":4,"ip":0,"op":30,"ks":{"o":{"a":0,"k":100},"p":{"a":0,"k":[26,26]},"s":{"a":0,"k":[100,100]}},"shapes":[
            {"ty":"gr","it":[
                {"ty":"sh","ks":{"a":0,"k":{"c":false,"v":[[6,14],[6,38],[46,38],[46,18],[46,14],[30,14],[26,10],[10,10],[6,14]],"i":[[0,0],[-2,0],[0,0],[0,0],[0,-2],[0,0],[0,0],[0,0],[0,-2]],"o":[[0,-2],[0,0],[2,0],[2,0],[0,0],[0,0],[0,0],[-2,0],[0,0]]}}},
                {"ty":"st","c":{"a":0,"k":[0,0,0,0]},"o":{"a":0,"k":0},"w":{"a":0,"k":0}},
                {"ty":"fl","c":{"a":0,"k":[0,0,0,0]}},
                {"ty":"tr","p":{"a":0,"k":[0,0]}}
            ]},
            {"ty":"gr","it":[
                {"ty":"sh","ks":{"a":0,"k":{"c":false,"v":[[18,27],[23,32],[34,21]],"i":[[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0]]}}},
                {"ty":"st","c":{"a":0,"k":[0.051,0.541,0.373,1]},"o":{"a":0,"k":100},"w":{"a":1,"k":[{"t":0,"s":[0]},{"t":10,"s":[2.5]}]}},
                {"ty":"tm","s":{"a":0,"k":0},"e":{"a":1,"k":[{"t":5,"s":[0]},{"t":20,"s":[100]}]},"o":{"a":0,"k":0}},
                {"ty":"tr","p":{"a":0,"k":[0,0]}}
            ]}
        ]}
    ]},
    // Step 1: Verify — circle draw + check
    verify: {"v":"5.7.1","fr":30,"ip":0,"op":40,"w":52,"h":52,"layers":[
        {"ty":4,"ip":0,"op":40,"ks":{"o":{"a":0,"k":100},"p":{"a":0,"k":[26,26]},"s":{"a":0,"k":[100,100]}},"shapes":[
            {"ty":"gr","it":[
                {"ty":"el","p":{"a":0,"k":[0,2]},"s":{"a":0,"k":[36,36]}},
                {"ty":"st","c":{"a":0,"k":[0.051,0.541,0.373,1]},"o":{"a":0,"k":100},"w":{"a":0,"k":2}},
                {"ty":"tm","s":{"a":0,"k":0},"e":{"a":1,"k":[{"t":0,"s":[0]},{"t":25,"s":[100]}]},"o":{"a":0,"k":-90}},
                {"ty":"tr","p":{"a":0,"k":[0,0]}}
            ]},
            {"ty":"gr","it":[
                {"ty":"sh","ks":{"a":0,"k":{"c":false,"v":[[-6,2],[-2,6],[8,-4]],"i":[[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0]]}}},
                {"ty":"st","c":{"a":0,"k":[0.051,0.541,0.373,1]},"o":{"a":0,"k":100},"w":{"a":1,"k":[{"t":0,"s":[0]},{"t":15,"s":[2.5]}]}},
                {"ty":"tm","s":{"a":0,"k":0},"e":{"a":1,"k":[{"t":15,"s":[0]},{"t":30,"s":[100]}]},"o":{"a":0,"k":0}},
                {"ty":"tr","p":{"a":0,"k":[0,0]}}
            ]}
        ]}
    ]},
    // Step 2: Search — magnifying glass pulse
    search: {"v":"5.7.1","fr":30,"ip":0,"op":50,"w":52,"h":52,"layers":[
        {"ty":4,"ip":0,"op":50,"ks":{"o":{"a":0,"k":100},"p":{"a":0,"k":[26,26]},"s":{"a":1,"k":[{"t":0,"s":[90,90]},{"t":15,"s":[105,105]},{"t":30,"s":[90,90]},{"t":45,"s":[100,100]}]}},"shapes":[
            {"ty":"gr","it":[
                {"ty":"el","p":{"a":0,"k":[-3,-3]},"s":{"a":0,"k":[26,26]}},
                {"ty":"st","c":{"a":0,"k":[0.051,0.541,0.373,1]},"o":{"a":0,"k":100},"w":{"a":0,"k":2}},
                {"ty":"tr","p":{"a":0,"k":[0,0]}}
            ]},
            {"ty":"gr","it":[
                {"ty":"sh","ks":{"a":0,"k":{"c":false,"v":[[6,6],[14,14]],"i":[[0,0],[0,0]],"o":[[0,0],[0,0]]}}},
                {"ty":"st","c":{"a":0,"k":[0.051,0.541,0.373,1]},"o":{"a":0,"k":100},"w":{"a":0,"k":2}},
                {"ty":"tr","p":{"a":0,"k":[0,0]}}
            ]}
        ]}
    ]},
    // Step 3: Randomize — cube rotate
    cube: {"v":"5.7.1","fr":30,"ip":0,"op":40,"w":52,"h":52,"layers":[
        {"ty":4,"ip":0,"op":40,"ks":{"o":{"a":0,"k":100},"p":{"a":0,"k":[26,26]},"r":{"a":1,"k":[{"t":0,"s":[0]},{"t":40,"s":[360]}]},"s":{"a":0,"k":[100,100]}},"shapes":[
            {"ty":"gr","it":[
                {"ty":"sh","ks":{"a":0,"k":{"c":true,"v":[[0,-14],[14,-6],[14,8],[0,16],[-14,8],[-14,-6]],"i":[[0,0],[0,0],[0,0],[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0],[0,0],[0,0],[0,0]]}}},
                {"ty":"st","c":{"a":0,"k":[0.051,0.541,0.373,1]},"o":{"a":0,"k":100},"w":{"a":0,"k":1.5}},
                {"ty":"tr","p":{"a":0,"k":[0,0]}}
            ]}
        ]}
    ]},
    // Step 4: Lightning — flash
    bolt: {"v":"5.7.1","fr":30,"ip":0,"op":30,"w":52,"h":52,"layers":[
        {"ty":4,"ip":0,"op":30,"ks":{"o":{"a":1,"k":[{"t":0,"s":[0]},{"t":5,"s":[100]},{"t":8,"s":[40]},{"t":12,"s":[100]}]},"p":{"a":0,"k":[26,26]},"s":{"a":1,"k":[{"t":0,"s":[80,80]},{"t":8,"s":[110,110]},{"t":16,"s":[100,100]}]}},"shapes":[
            {"ty":"gr","it":[
                {"ty":"sh","ks":{"a":0,"k":{"c":true,"v":[[2,-16],[-10,2],[0,2],[-2,16],[10,-2],[0,-2]],"i":[[0,0],[0,0],[0,0],[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0],[0,0],[0,0],[0,0]]}}},
                {"ty":"st","c":{"a":0,"k":[0.051,0.541,0.373,1]},"o":{"a":0,"k":100},"w":{"a":0,"k":1.5}},
                {"ty":"fl","c":{"a":0,"k":[0.063,0.714,0.522,0.15]}},
                {"ty":"tr","p":{"a":0,"k":[0,0]}}
            ]}
        ]}
    ]}
};

function initLottieIcons() {
    const keys = ['folder', 'verify', 'search', 'cube', 'bolt'];
    keys.forEach((key, i) => {
        const container = document.getElementById('stepVis' + i);
        if (!container) return;
        // Create lottie wrapper
        const wrapper = document.createElement('div');
        wrapper.className = 'lottie-icon';
        wrapper.style.display = 'none'; // Hidden initially
        wrapper.id = 'lottie' + i;
        container.appendChild(wrapper);
        try {
            LOTTIE_ANIMS[i] = lottie.loadAnimation({
                container: wrapper,
                renderer: 'svg',
                loop: false,
                autoplay: false,
                animationData: lottieData[key],
            });
        } catch(e) { /* Lottie CDN not loaded — graceful fallback */ }
    });
}

// Play Lottie for a specific step when it transitions to completed
function playStepAnim(stepIndex) {
    const wrapper = document.getElementById('lottie' + stepIndex);
    const anim = LOTTIE_ANIMS[stepIndex];
    if (!wrapper || !anim) return;

    // Show lottie, hide static SVG
    const container = document.getElementById('stepVis' + stepIndex);
    const staticSvg = container.querySelector(':scope > svg');
    if (staticSvg) staticSvg.style.display = 'none';
    wrapper.style.display = 'flex';

    anim.goToAndStop(0, true);
    anim.play();

    // After animation completes, swap to a clean completed checkmark SVG
    anim.addEventListener('complete', function onComplete() {
        anim.removeEventListener('complete', onComplete);
        wrapper.style.display = 'none';
        if (staticSvg) {
            staticSvg.style.display = '';
            // Replace with a completed checkmark icon
            staticSvg.innerHTML = '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>';
        }
    });
}


// ═══════════════════════════════════════════════════════════════════════════════
//  TAB INDICATOR
// ═══════════════════════════════════════════════════════════════════════════════
function updateTabIndicator() {
    const active = document.querySelector('.tab-btn.active');
    const indicator = document.getElementById('tabIndicator');
    if (active && indicator) {
        indicator.style.left = active.offsetLeft + 'px';
        indicator.style.width = active.offsetWidth + 'px';
    }
}
window.addEventListener('load', updateTabIndicator);
window.addEventListener('resize', updateTabIndicator);

// ── Disable right-click and dev tools shortcuts ──
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
    // Block F12, Ctrl/Cmd+Shift+I, Ctrl/Cmd+Shift+J, Ctrl/Cmd+U
    if (e.key === 'F12') { e.preventDefault(); return; }
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j')) { e.preventDefault(); return; }
    if ((e.ctrlKey || e.metaKey) && (e.key === 'U' || e.key === 'u')) { e.preventDefault(); return; }
});

// ═══════════════════════════════════════════════════════════════════════════════
//  BUTTON RIPPLE EFFECT
// ═══════════════════════════════════════════════════════════════════════════════
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.btn');
    if (!btn || btn.disabled) return;
    const rect = btn.getBoundingClientRect();
    const ripple = document.createElement('span');
    ripple.className = 'btn-ripple';
    const size = Math.max(rect.width, rect.height);
    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = (e.clientX - rect.left - size/2) + 'px';
    ripple.style.top = (e.clientY - rect.top - size/2) + 'px';
    btn.appendChild(ripple);
    ripple.addEventListener('animationend', () => ripple.remove());
});


// ═══════════════════════════════════════════════════════════════════════════════
//  COMMAND PALETTE
// ═══════════════════════════════════════════════════════════════════════════════
const CMD_ACTIONS = [
    { id: 'refresh', title: 'Refresh Instances', desc: 'Scan for BlueStacks instances', icon: 'refresh', action: () => refreshInstances() },
    { id: 'randomize', title: 'Randomize Selected', desc: 'Spoof selected instance identities', icon: 'shuffle', action: () => doRandomize() },
    { id: 'clone', title: 'Clone Instance', desc: 'Open clone modal from Cloning tab', icon: 'copy', action: () => { switchTab('advanced'); selectAdvCard('clone'); openAdvCloneModal(); } },
    { id: 'select-running', title: 'Select Running', desc: 'Select all running instances', icon: 'check', action: () => { switchTab('randomize'); selectRunning(); } },
    { id: 'tab-randomize', title: 'Go to Randomize', desc: 'Switch to Randomize tab', icon: 'tab', action: () => switchTab('randomize') },
    { id: 'tab-advanced', title: 'Go to Cloning', desc: 'Switch to Cloning tab', icon: 'tab', action: () => switchTab('advanced') },
    { id: 'tab-vpn', title: 'Go to VPN', desc: 'Switch to VPN tab', icon: 'tab', action: () => switchTab('vpn') },
    { id: 'wizard', title: 'Run Setup Wizard', desc: 'Guided first-time setup', icon: 'wand', action: () => { switchTab('advanced'); initSetupWizard(true); } },
    { id: 'browse', title: 'Browse Engine Directory', desc: 'Set BlueStacks engine path', icon: 'folder', action: () => browseEngineDir() },
    { id: 'clear-log', title: 'Clear Activity Log', desc: 'Remove all log entries', icon: 'trash', action: () => clearLog() },
];

const CMD_ICONS = {
    refresh: '<svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>',
    shuffle: '<svg viewBox="0 0 24 24"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>',
    copy: '<svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',
    check: '<svg viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
    tab: '<svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>',
    folder: '<svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
    wand: '<svg viewBox="0 0 24 24"><line x1="4" y1="20" x2="15" y2="9" stroke-width="2" stroke-linecap="round"/><path d="M17 7l-2-2m4-1l-1 1m3 3l-1-1m-6-3V2m-3 3l1 1" stroke-width="1.5" stroke-linecap="round"/></svg>',
    trash: '<svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
};

let cmdActiveIndex = 0;

function openCmdPalette() {
    const overlay = document.getElementById('cmdOverlay');
    overlay.classList.add('open');
    document.getElementById('cmdInput').value = '';
    document.getElementById('cmdInput').focus();
    cmdActiveIndex = 0;
    renderCmdResults('');
}

function closeCmdPalette() {
    document.getElementById('cmdOverlay').classList.remove('open');
}

function renderCmdResults(query) {
    const container = document.getElementById('cmdResults');
    const q = query.toLowerCase().trim();
    const filtered = q ? CMD_ACTIONS.filter(a =>
        a.title.toLowerCase().includes(q) || a.desc.toLowerCase().includes(q) || a.id.includes(q)
    ) : CMD_ACTIONS;

    if (filtered.length === 0) {
        container.innerHTML = '<div class="cmd-empty">No matching commands</div>';
        return;
    }

    cmdActiveIndex = Math.min(cmdActiveIndex, filtered.length - 1);
    container.innerHTML = filtered.map((item, i) => `
        <div class="cmd-item ${i === cmdActiveIndex ? 'active' : ''}" data-index="${i}" onclick="executeCmdAction(${CMD_ACTIONS.indexOf(item)})">
            <div class="cmd-item-icon">${CMD_ICONS[item.icon] || ''}</div>
            <div class="cmd-item-text">
                <div class="cmd-item-title">${highlightMatch(item.title, q)}</div>
                <div class="cmd-item-desc">${item.desc}</div>
            </div>
        </div>
    `).join('');

    // Hover effect
    container.querySelectorAll('.cmd-item').forEach((el, i) => {
        el.addEventListener('mouseenter', () => {
            container.querySelectorAll('.cmd-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            cmdActiveIndex = i;
        });
    });
}

function highlightMatch(text, query) {
    if (!query) return escapeHtml(text);
    const escaped = escapeHtml(text);
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return escaped.replace(regex, '<span style="color:#10B685">$1</span>');
}

function executeCmdAction(index) {
    closeCmdPalette();
    const action = CMD_ACTIONS[index];
    if (action) action.action();
}

document.getElementById('cmdInput').addEventListener('input', function() {
    cmdActiveIndex = 0;
    renderCmdResults(this.value);
});

document.getElementById('cmdInput').addEventListener('keydown', function(e) {
    const items = document.querySelectorAll('#cmdResults .cmd-item');
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        cmdActiveIndex = Math.min(cmdActiveIndex + 1, items.length - 1);
        items.forEach((el, i) => el.classList.toggle('active', i === cmdActiveIndex));
        items[cmdActiveIndex]?.scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        cmdActiveIndex = Math.max(cmdActiveIndex - 1, 0);
        items.forEach((el, i) => el.classList.toggle('active', i === cmdActiveIndex));
        items[cmdActiveIndex]?.scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'Enter') {
        e.preventDefault();
        const activeEl = document.querySelector('#cmdResults .cmd-item.active');
        if (activeEl) activeEl.click();
    } else if (e.key === 'Escape') {
        closeCmdPalette();
    }
});

// Global keyboard shortcut
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const overlay = document.getElementById('cmdOverlay');
        if (overlay.classList.contains('open')) closeCmdPalette();
        else openCmdPalette();
    }
    if (e.key === 'Escape') closeCmdPalette();
});


// ═══════════════════════════════════════════════════════════════════════════════
//  TOAST SYSTEM
// ═══════════════════════════════════════════════════════════════════════════════
function showToast(message, type = 'success', duration = 3500) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = `
        <div class="toast-accent ${type}"></div>
        <div class="toast-text">${escapeHtml(message)}</div>
    `;
    container.appendChild(toast);
    setTimeout(() => {
        toast.classList.add('exiting');
        toast.addEventListener('animationend', () => toast.remove());
    }, duration);
}


// ═══════════════════════════════════════════════════════════════════════════════
//  TOP PROGRESS BAR
// ═══════════════════════════════════════════════════════════════════════════════
function setProgressBar(active) {
    const bar = document.getElementById('topProgress');
    if (!bar) return;
    if (active) {
        bar.style.width = '100%';
        bar.classList.add('active');
    } else {
        bar.classList.remove('active');
        bar.style.width = '0%';
    }
}


// ═══════════════════════════════════════════════════════════════════════════════
//  APP STATE & LOGIC
// ═══════════════════════════════════════════════════════════════════════════════
let STATE = {
    engineDir: '',
    bsDir: '',
    pathChecks: null,
    instances: [],
    randInstances: [],
    selectedRand: new Set(),
    activeTab: 'advanced',
    running: false,
    pyVersion: '3.x',
    prevStep: -1,
    setupMode: false,
    setupComplete: false,
    imageDownloaded: false,
    advancedOption: null,
    imagesDir: '',
    sourceImages: [],
    selectedSourceImage: null,
    advCloneMode: 'new',
    permissionsOk: false,
    rooted: false,
    // Instance Manager tab
    imInstances: [],
    imSelected: new Set(),
    imPollingTimer: null,
    // VPN tab
    vpnProxyPool: [],        // [{id, label, server, port, username, password}]
    vpnAssignments: {},      // {instanceName: proxyId}
    vpnStatuses: {},         // {instanceName: {state, server, uptime}}
    vpnPolling: false,
    suborbitalUser: '',
    suborbitalLoggedIn: false,
    suborbitalProxies: [],
    suborbitalBalance: null,
};

function pathChecksReady(checks) {
    return !!(checks && checks.engine_exists && checks.bs_exists && checks.conf_exists && checks.adb_exists);
}

function renderSetupCheck(label, ok, detail) {
    const safeDetail = detail ? escapeHtml(detail) : '';
    const shortDetail = detail ? escapeHtml(truncPath(detail)) : '';
    const titleAttr = detail ? ` title="${safeDetail}"` : '';
    return '<div class="step-check ' + (ok ? 'ok' : 'fail') + '">'
        + '<span class="step-check-icon">' + (ok ? '✓' : '✗') + '</span>'
        + '<span class="step-check-label">' + escapeHtml(label) + '</span>'
        + (detail ? ('<span class="step-check-meta"' + titleAttr + '>' + shortDetail + '</span>') : '')
        + '</div>';
}

function renderPathChecklist(checks) {
    if (!checks) {
        return '<span class="status-fail">✗</span> Unable to verify paths';
    }
    const rows = [
        renderSetupCheck('Engine folder', !!checks.engine_exists, checks.engine_path),
        renderSetupCheck('BlueStacks install', !!checks.bs_exists, checks.bs_path),
        renderSetupCheck('bluestacks.conf', !!checks.conf_exists, checks.conf_path),
        renderSetupCheck('hd-adb', !!checks.adb_exists, checks.adb_path),
    ];
    const ok = pathChecksReady(checks);
    const summary = ok ? 'All required paths verified' : 'Missing required paths';
    return '<div class="step-check-summary ' + (ok ? 'ok' : 'fail') + '">' + summary + '</div>'
        + '<div class="step-checks">' + rows.join('') + '</div>';
}

async function refreshPathChecks() {
    try {
        STATE.pathChecks = await pywebview.api.verify_paths(STATE.engineDir, STATE.bsDir);
    } catch (e) {
        STATE.pathChecks = null;
    }
    return STATE.pathChecks;
}

async function refreshSourceImageState() {
    STATE.imageDownloaded = false;
    STATE.selectedSourceImage = null;
    if (!STATE.engineDir) return;
    try {
        const dlCheck = await pywebview.api.check_image_exists(STATE.engineDir);
        if (dlCheck && dlCheck.exists) {
            STATE.imageDownloaded = true;
            if (dlCheck.images && dlCheck.images.length > 0) {
                STATE.selectedSourceImage = dlCheck.images[0];
            }
        }
    } catch (e) {}
}

// ─── pywebview ready ─────────────────────────────────────────────────────────
window.addEventListener('pywebviewready', async function() {
    try {
        const state = await pywebview.api.get_initial_state();
        STATE.engineDir = state.engine_dir || '';
        STATE.bsDir = state.bs_dir || '';
        STATE.instances = state.instances || [];
        STATE.pyVersion = state.python_version || '3.x';
        STATE.imagesDir = state.images_dir || '';
        STATE.sourceImages = state.source_images || [];

        // Load persisted VPN state
        STATE.vpnProxyPool = state.vpn_proxy_pool || [];
        STATE.vpnAssignments = state.vpn_assignments || {};
        STATE.suborbitalUser = state.suborbital_email || '';
        STATE.suborbitalLoggedIn = !!(state.suborbital_email && state.suborbital_has_password);
        vpnInitIds();

        // Auto-restore always-on VPN connections from persisted state.
        // Runs in background — the backend discovers instance ports from
        // bluestacks.conf directly (initial scan doesn't include ports).
        if (STATE.vpnProxyPool.some(p => p.alwaysOn) && Object.keys(STATE.vpnAssignments).length > 0) {
            pywebview.api.vpn_restore_always_on().catch(() => {});
        }

        document.getElementById('enginePath').textContent = STATE.engineDir || 'Not detected — click Browse';
        document.getElementById('bsPath').textContent = STATE.bsDir || '—';
        document.getElementById('footerRight').textContent = 'python ' + STATE.pyVersion;

        updateTabIndicator();
        initLottieIcons();
        startFooterClock();

        await refreshPathChecks();
        await refreshSourceImageState();

        // Auto-enter setup wizard if required path checks are missing.
        if (pathChecksReady(STATE.pathChecks)) {
            STATE.setupMode = false;
            STATE.setupComplete = true;
            document.body.classList.add('setup-done');
            enterWorkspaceMode(false);
        } else {
            await initSetupWizard(false);
        }
    } catch (e) {
        appendLog('[Error] Failed to initialize: ' + e);
    }
});

// ═══════════════════════════════════════════════════════════════════════════════
//  INSTANCE MANAGER MODAL
// ═══════════════════════════════════════════════════════════════════════════════

function openImModal() {
    STATE.imSelected.clear();
    updateImDeleteBtn();
    document.getElementById('imModal').style.display = '';
    imRefreshInstances();
    imStartPolling();
}

function closeImModal() {
    document.getElementById('imModal').style.display = 'none';
    imStopPolling();
    // Sync randomize tab when closing
    if (typeof renderRandCards === 'function') renderRandCards();
    if (typeof renderIlList === 'function') renderIlList();
    if (typeof utRender === 'function') utRender();
    if (typeof updateRandSummary === 'function') updateRandSummary();
    if (typeof updateRandButton === 'function') updateRandButton();
}

function imIsOpen() {
    const m = document.getElementById('imModal');
    return m && m.style.display !== 'none';
}

async function imRefreshInstances() {
    if (STATE.running) return;
    if (!STATE.engineDir) return;
    const btn = document.getElementById('imBtnRefresh');
    if (btn) btn.disabled = true;

    // Only show spinner on first load when grid is empty
    const grid = document.getElementById('imGrid');
    const hasCards = grid && grid.querySelector('.im-card');
    if (grid && !hasCards) {
        grid.innerHTML = '<div class="empty-state"><span class="spinner" style="width:14px;height:14px"></span><span style="color:#70757a;font-weight:500">Scanning...</span></div>';
    }

    try {
        const result = await pywebview.api.refresh_instances(STATE.engineDir, STATE.bsDir);
        if (result && result.error) {
            if (grid && !hasCards) grid.innerHTML = '<div class="empty-state">' + escapeHtml(result.error) + '</div>';
        } else {
            STATE.imInstances = result.instances || [];
            STATE.randInstances = result.instances || [];
            renderImTable();
            renderIlList();
            utRender();
            updateImSummary();
            updateHeroStats();
        }
    } catch (e) {
        if (grid && !hasCards) grid.innerHTML = '<div class="empty-state">Error: ' + escapeHtml(String(e)) + '</div>';
    } finally {
        if (btn) btn.disabled = false;
    }
}

function renderImTable() {
    const grid = document.getElementById('imGrid');
    if (!grid) return;
    if (!STATE.imInstances.length) {
        grid.innerHTML = '<div class="empty-state">No instances found. Click Refresh.</div>';
        return;
    }

    grid.innerHTML = '';

    // Sort: running first, then alphabetical
    const sorted = [...STATE.imInstances].sort((a, b) => {
        if (a.running !== b.running) return b.running ? 1 : -1;
        return (a.display || a.name).localeCompare(b.display || b.name);
    });

    sorted.forEach(inst => {
        const card = document.createElement('div');
        const isRunning = !!inst.running;
        const isSelected = STATE.imSelected.has(inst.name);
        card.className = 'im-card' + (isRunning ? '' : ' stopped') + (isSelected ? ' selected' : '');
        card.dataset.name = inst.name;

        let actionBtn = '';
        if (isRunning) {
            actionBtn = '<div class="im-card-action"><button class="im-action-btn im-btn-stop" onclick="event.stopPropagation();imStopInstance(\'' + inst.name + '\')" title="Stop"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="1"/></svg></button></div>';
        } else {
            actionBtn = '<div class="im-card-action"><button class="im-action-btn im-btn-start" onclick="event.stopPropagation();imStartInstance(\'' + inst.name + '\')" title="Start"><svg viewBox="0 0 24 24"><polygon points="6 3 20 12 6 21 6 3"/></svg></button></div>';
        }

        card.innerHTML =
            '<img class="im-card-logo" src="bs.png" alt="" draggable="false">' +
            '<div class="im-card-text">' +
                '<div class="im-card-name">' + escapeHtml(inst.display || inst.name) + '</div>' +
                '<div class="im-card-meta">' +
                    '<span class="im-card-dot ' + (isRunning ? 'running' : 'stopped') + '"></span>' +
                    (isRunning ? 'Running' : 'Offline') +
                    ' · :' + (inst.port || '?') +
                '</div>' +
            '</div>' +
            actionBtn;

        card.onclick = () => {
            const sel = STATE.imSelected.has(inst.name);
            if (sel) STATE.imSelected.delete(inst.name);
            else STATE.imSelected.add(inst.name);
            document.querySelectorAll('.im-card').forEach(c => {
                c.classList.toggle('selected', STATE.imSelected.has(c.dataset.name));
            });
            updateImDeleteBtn();
        };

        grid.appendChild(card);
    });
}

function imToggleSelect(name, checked) {
    if (checked) STATE.imSelected.add(name);
    else STATE.imSelected.delete(name);

    document.querySelectorAll('.im-card').forEach(c => {
        c.classList.toggle('selected', STATE.imSelected.has(c.dataset.name));
    });
    updateImDeleteBtn();
}

function updateImSelActions() {
    const count = STATE.imSelected.size;
    const section = document.getElementById('imSelActions');
    const label = document.getElementById('imSelLabel');

    if (section) section.style.display = count > 0 ? '' : 'none';
    if (label) label.textContent = count + ' selected';
}

function updateImDeleteBtn() { updateImSelActions(); }

function updateImSummary() {
    const running = STATE.imInstances.filter(i => i.running).length;
    const offline = STATE.imInstances.length - running;
    const runEl = document.getElementById('imRunningCount');
    const offEl = document.getElementById('imOfflineCount');
    if (runEl) runEl.textContent = running;
    if (offEl) offEl.textContent = offline;
}

async function imStartInstance(name) {
    const btn = document.querySelector('.im-card[data-name="' + name + '"] .im-action-btn');
    if (btn) btn.classList.add('loading');
    appendLog('Starting ' + name + '...');

    try {
        const result = await pywebview.api.start_instance(name);
        if (result && result.error) {
            showToast('Failed to start ' + name, 'error');
            appendLog('[Error] ' + result.error);
        } else {
            showToast(name + ' starting...', 'success', 2000);
            appendLog(name + ' start command sent');
            setTimeout(() => imRefreshInstances(), 5000);
        }
    } catch (e) {
        showToast('Error: ' + String(e), 'error');
    } finally {
        if (btn) btn.classList.remove('loading');
    }
}

async function imStopInstance(name) {
    const btn = document.querySelector('.im-card[data-name="' + name + '"] .im-action-btn');
    if (btn) btn.classList.add('loading');
    appendLog('Stopping ' + name + '...');

    try {
        const result = await pywebview.api.stop_instance(name, STATE.engineDir, STATE.bsDir);
        if (result && result.error) {
            showToast('Failed to stop ' + name, 'error');
            appendLog('[Error] ' + result.error);
        } else {
            showToast(name + ' stopping...', 'success', 2000);
            appendLog(name + ' stop command sent (' + (result.method || 'adb') + ')');
            setTimeout(() => imRefreshInstances(), 3000);
        }
    } catch (e) {
        showToast('Error: ' + String(e), 'error');
    } finally {
        if (btn) btn.classList.remove('loading');
    }
}

async function imStartAll() {
    const stopped = STATE.imInstances.filter(i => !i.running);
    if (stopped.length === 0) {
        showToast('All instances already running', 'info', 2000);
        return;
    }
    appendLog('Starting all stopped instances (' + stopped.length + ')...');
    for (const inst of stopped) {
        try {
            await pywebview.api.start_instance(inst.name);
            appendLog('Start sent: ' + inst.name);
        } catch (e) {
            appendLog('[Error] ' + inst.name + ': ' + String(e));
        }
        await new Promise(r => setTimeout(r, 1500));
    }
    showToast('Start commands sent for ' + stopped.length + ' instances', 'success');
    setTimeout(() => imRefreshInstances(), 6000);
}

async function imStopAll() {
    const running = STATE.imInstances.filter(i => i.running);
    if (running.length === 0) {
        showToast('No running instances', 'info', 2000);
        return;
    }
    appendLog('Stopping all running instances (' + running.length + ')...');
    for (const inst of running) {
        try {
            await pywebview.api.stop_instance(inst.name, STATE.engineDir, STATE.bsDir);
            appendLog('Stop sent: ' + inst.name);
        } catch (e) {
            appendLog('[Error] ' + inst.name + ': ' + String(e));
        }
    }
    showToast('Stop commands sent for ' + running.length + ' instances', 'success');
    setTimeout(() => imRefreshInstances(), 4000);
}

async function imDeleteSelected() {
    const targets = Array.from(STATE.imSelected);
    if (targets.length === 0) return;

    const runningTargets = targets.filter(name => {
        const inst = STATE.imInstances.find(i => i.name === name);
        return inst && inst.running;
    });

    let msg = 'Permanently delete ' + targets.length + ' instance' + (targets.length !== 1 ? 's' : '') + '?\n\n' + targets.map(n => {
        const inst = STATE.imInstances.find(i => i.name === n);
        return (inst && inst.display) ? inst.display + ' (' + n + ')' : n;
    }).join('\n');
    if (runningTargets.length > 0) {
        msg += '\n\n' + runningTargets.length + ' selected instance(s) are running and will be stopped first.';
    }
    msg += '\n\nThis cannot be undone.';
    if (!confirm(msg)) return;

    if (runningTargets.length > 0) {
        appendLog('Stopping running instances before delete...');
        for (const name of runningTargets) {
            try { await pywebview.api.stop_instance(name, STATE.engineDir, STATE.bsDir); } catch (e) {}
        }
        await new Promise(r => setTimeout(r, 2000));
    }

    closeImModal();
    setRunning(true);
    appendLog('Deleting ' + targets.join(', '));
    showToast('Deleting ' + targets.length + ' instance(s)...', 'info');

    try {
        await pywebview.api.do_delete(targets, STATE.engineDir);
    } catch (e) {
        appendLog('[Error] ' + String(e));
        setRunning(false);
    }

    STATE.imSelected.clear();
    updateImDeleteBtn();
}

function imStartPolling() {
    imStopPolling();
    STATE.imPollingTimer = setInterval(() => {
        if (imIsOpen() && !STATE.running && STATE.engineDir) {
            imSilentRefresh();
        }
    }, 30000);
}

async function imSilentRefresh() {
    // Background refresh — only update changed cards, no full rebuild
    if (!STATE.engineDir) return;
    try {
        const result = await pywebview.api.refresh_instances(STATE.engineDir, STATE.bsDir);
        if (result.error || !result.instances) return;

        STATE.imInstances = result.instances;
        STATE.randInstances = result.instances;
        updateImSummary();
        renderIlList();
        utRender();
        updateHeroStats();

        // Update individual cards in-place instead of rebuilding the grid
        const grid = document.getElementById('imGrid');
        if (!grid) return;
        const cards = grid.querySelectorAll('.im-card');
        if (!cards.length) { renderImTable(); return; }

        result.instances.forEach(inst => {
            const card = grid.querySelector('.im-card[data-name="' + inst.name + '"]');
            if (!card) return;
            const wasRunning = !card.classList.contains('stopped');
            const isRunning = !!inst.running;
            if (wasRunning !== isRunning) {
                // Status changed — update this card
                card.classList.toggle('stopped', !isRunning);
                const dot = card.querySelector('.im-card-dot');
                if (dot) { dot.className = 'im-card-dot ' + (isRunning ? 'running' : 'stopped'); }
                const meta = card.querySelector('.im-card-meta');
                if (meta) {
                    meta.innerHTML = '<span class="im-card-dot ' + (isRunning ? 'running' : 'stopped') + '"></span>' +
                        (isRunning ? 'Running' : 'Offline') + ' · :' + (inst.port || '?');
                }
                const actionDiv = card.querySelector('.im-card-action');
                if (actionDiv) {
                    if (isRunning) {
                        actionDiv.innerHTML = '<button class="im-action-btn im-btn-stop" onclick="event.stopPropagation();imStopInstance(\'' + inst.name + '\')" title="Stop"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="1"/></svg></button>';
                    } else {
                        actionDiv.innerHTML = '<button class="im-action-btn im-btn-start" onclick="event.stopPropagation();imStartInstance(\'' + inst.name + '\')" title="Start"><svg viewBox="0 0 24 24"><polygon points="6 3 20 12 6 21 6 3"/></svg></button>';
                    }
                }
            }
        });

        // If instance count changed (new clones or deletes happened externally), do a full rebuild
        if (cards.length !== result.instances.length) {
            renderImTable();
        }
    } catch (e) { /* silent fail */ }
}

function imStopPolling() {
    if (STATE.imPollingTimer) {
        clearInterval(STATE.imPollingTimer);
        STATE.imPollingTimer = null;
    }
}

// ─── Tab switching ───────────────────────────────────────────────────────────
function switchTab(tab) {
    STATE.activeTab = tab;
    document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.tab === tab);
    });
    document.querySelectorAll('.tab-pane').forEach(p => {
        const isActive = p.id === 'pane-' + tab;
        p.classList.toggle('active', isActive);
        // Retrigger animation
        if (isActive) {
            p.style.animation = 'none';
            p.offsetHeight; // force reflow
            p.style.animation = '';
        }
    });
    updateTabIndicator();

    // Update hero text based on active tab and current state
    updateHeroContext();

    // VPN tab: start/stop polling, auto-scan instances if needed
    if (tab === 'vpn') {
        vpnRender();
        vpnStartPolling();
        // Auto-scan instances so the VPN tab works even if Randomize tab wasn't visited
        if ((!STATE.randInstances || !STATE.randInstances.length) && STATE.engineDir) {
            pywebview.api.refresh_instances(STATE.engineDir, STATE.bsDir).then(result => {
                if (result && !result.error && result.instances) {
                    STATE.randInstances = result.instances;
                    vpnRender();
                    vpnStartPolling();
                }
            }).catch(() => {});
        }
    } else if (STATE.vpnPolling) {
        // Only stop polling if no proxy has always-on enabled.
        // Always-on needs the poller running to detect drops and reconnect.
        const hasAlwaysOn = STATE.vpnProxyPool.some(p => p.alwaysOn);
        if (!hasAlwaysOn) {
            vpnStopPolling();
        }
    }
}

// ─── Engine dir browse ───────────────────────────────────────────────────────
async function browseEngineDir() {
    try {
        const path = await pywebview.api.browse_engine_dir();
        if (path) {
            STATE.engineDir = path;
            document.getElementById('enginePath').textContent = path;
            STATE.instances = await pywebview.api.scan_instances_for_dir(path);

            if (STATE.setupMode) {
                // Show success and re-run wizard
                document.getElementById('step0Status').innerHTML = '<span class="status-ok">✓</span> Found:<br>' + truncPath(path);
                document.getElementById('step0Actions').style.display = 'none';
                await sleep(120);
                // Re-run wizard checks from step 0 to ensure all sections validate.
                await runAutoDetect();
            } else {
                updateSteps();
                updateHeroStats();
                appendLog('Engine directory set: ' + path);
                showToast('Engine path updated', 'success');
            }
        }
    } catch (e) {
        appendLog('[Error] Browse failed: ' + e);
        showToast('Failed to set engine path', 'error');
    }
}

// ─── Refresh ─────────────────────────────────────────────────────────────────
async function refreshInstances() {
    if (STATE.running) return;
    if (!STATE.engineDir) {
        appendLog('[Error] Engine directory not set. Click Browse to set it.');
        showToast('Set engine directory first', 'error');
        return;
    }

    const _refreshBtn = document.getElementById('btnRefresh');
    if (_refreshBtn) _refreshBtn.disabled = true;
    const scanBanner = document.getElementById('randScanResult');
    if (scanBanner) scanBanner.className = 'rand-scan-result';
    const _rc = document.getElementById('randCards');
    if (_rc) _rc.innerHTML = '<div class="empty-state"><span class="spinner" style="width:14px;height:14px"></span><span style="color:#70757a;font-weight:500">Scanning for instances...</span><span style="font-size:0.58rem;color:#40454a">Checking ADB connections</span></div>';
    const _utg = document.getElementById('utGrid');
    if (_utg) _utg.innerHTML = '<div class="ut-empty"><span class="spinner" style="width:14px;height:14px"></span> Scanning...</div>';

    try {
        const result = await pywebview.api.refresh_instances(STATE.engineDir, STATE.bsDir);
        if (result && result.error) {
            appendLog('[Error] ' + result.error);
            if (_rc) _rc.innerHTML = '<div class="empty-state">' + escapeHtml(result.error) + '</div>';
            if (_utg) _utg.innerHTML = '<div class="ut-empty">' + escapeHtml(result.error) + '</div>';
            showToast('Refresh failed', 'error');
        } else {
            STATE.randInstances = result.instances || [];
            STATE.selectedRand.clear();
            // Auto-select running+root instances before rendering
            STATE.randInstances.forEach(inst => {
                if (inst.running && inst.root) STATE.selectedRand.add(inst.name);
            });
            renderRandCards();
            renderIlList();
            utRender();
            showRandCta();
            showScanResult();
            updateRandSummary();
            updateRandButton();
            updateSteps();
            updateHeroStats();
            const running = STATE.randInstances.filter(i => i.running).length;
            appendLog('Detected ' + STATE.randInstances.length + ' instance(s), ' + running + ' running');
            showToast(STATE.randInstances.length + ' instance(s) detected', 'success');
        }
    } catch (e) {
        appendLog('[Error] Refresh failed: ' + e);
        if (_rc) _rc.innerHTML = '<div class="empty-state">Refresh failed</div>';
        if (_utg) _utg.innerHTML = '<div class="ut-empty">Refresh failed</div>';
        showToast('Refresh error', 'error');
    }
    const _refreshBtn2 = document.getElementById('btnRefresh');
    if (_refreshBtn2) _refreshBtn2.disabled = false;
}

function _scanActions() {
    return '<div class="scan-actions">' +
        '<button class="scan-action-btn" id="btnRefresh" onclick="refreshInstances()">Refresh</button>' +
        '<div class="scan-actions-sep"></div>' +
        '<button class="scan-action-btn scan-action-primary" id="btnRandomizeBanner" onclick="doRandomize()">' +
            '<svg viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1.5px;margin-right:4px"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>' +
            'Randomize</button>' +
    '</div>';
}

function showScanResult() {
    const banner = document.getElementById('randScanResult');
    if (!banner) return;
    const rooted = STATE.randInstances.filter(i => i.running && i.root).length;
    const running = STATE.randInstances.filter(i => i.running).length;
    const total = STATE.randInstances.length;

    if (rooted > 0) {
        banner.className = 'rand-scan-result show success';
        banner.innerHTML =
            '<div class="scan-icon"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>' +
            '<div class="scan-body">' +
                '<div class="scan-title">' + rooted + ' instance' + (rooted !== 1 ? 's' : '') + ' auto-selected</div>' +
                '<div class="scan-text">Running with root access</div>' +
            '</div>' +
            _scanActions();
    } else if (running > 0) {
        banner.className = 'rand-scan-result show warn';
        banner.innerHTML =
            '<div class="scan-icon"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>' +
            '<div class="scan-body">' +
                '<div class="scan-title">No root access detected</div>' +
                '<div class="scan-text">' + running + ' instance' + (running !== 1 ? 's are' : ' is') + ' running but root is required</div>' +
            '</div>' +
            _scanActions();
    } else if (total > 0) {
        banner.className = 'rand-scan-result show warn';
        banner.innerHTML =
            '<div class="scan-icon"><svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>' +
            '<div class="scan-body">' +
                '<div class="scan-title">No running instances</div>' +
                '<div class="scan-text">' + total + ' found but none running — start your emulators</div>' +
            '</div>' +
            _scanActions();
    } else {
        banner.className = 'rand-scan-result';
        banner.innerHTML = '';
    }
}

// ─── Auto-refresh and auto-select on workspace entry ─────────────────────────
async function autoRefreshAndSelect() {
    if (STATE.running || !STATE.engineDir) return;

    // Hide previous scan result and show scanning state
    const scanBanner = document.getElementById('randScanResult');
    if (scanBanner) scanBanner.className = 'rand-scan-result';
    const container = document.getElementById('randCards');
    if (container) container.innerHTML = '<div class="empty-state"><span class="spinner" style="width:14px;height:14px"></span><span style="color:#70757a;font-weight:500">Scanning for instances...</span><span style="font-size:0.58rem;color:#40454a">Checking ADB connections</span></div>';

    try {
        const result = await pywebview.api.refresh_instances(STATE.engineDir, STATE.bsDir);
        if (result && !result.error) {
            STATE.randInstances = result.instances || [];
            STATE.selectedRand.clear();

            // Auto-select running instances with root access
            STATE.randInstances.forEach(inst => {
                if (inst.running && inst.root) STATE.selectedRand.add(inst.name);
            });

            renderRandCards();
            renderIlList();
            utRender();
            showRandCta();
            showScanResult();
            updateRandSummary();
            updateRandButton();
            updateHeroStats();
            updateHeroContext();
        } else {
            if (container) container.innerHTML = '<div class="empty-state">No instances found. Click Refresh.</div>';
            showScanResult();
        }
    } catch (e) {
        appendLog('[Error] Auto-scan failed: ' + e);
        if (container) container.innerHTML = '<div class="empty-state">Scan failed. Click Refresh to retry.</div>';
    }
}

// ─── Render randomize cards ──────────────────────────────────────────────────
function renderRandCards() {
    const container = document.getElementById('randCards');
    if (!container) return;
    const running = STATE.randInstances.filter(i => i.running);

    if (!STATE.randInstances.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>No instances found. Click Refresh.</div>';
        updateRandSummary();
        updateRandButton();
        return;
    }
    if (!running.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></div>No running instances detected. Launch instances in MIM and click Refresh.</div>';
        updateRandSummary();
        updateRandButton();
        return;
    }
    container.innerHTML = '';
    running.forEach((inst, i) => {
        const card = document.createElement('div');
        const isRunningRoot = inst.running && inst.root;
        const isSelected = STATE.selectedRand.has(inst.name);

        card.className = 'rand-card';
        if (isSelected) card.classList.add('selected');
        card.dataset.name = inst.name;
        card.onclick = () => toggleRandCard(inst.name);
        card.style.animationDelay = (i * 30) + 'ms';

        let statusLabel = 'No root';
        let dotClass = 'running';
        if (isRunningRoot) { statusLabel = 'Root'; dotClass = 'running'; }

        card.innerHTML = `
            <div class="rand-card-dot ${dotClass}"></div>
            <div class="rand-card-info">
                <div class="rand-card-name">${escapeHtml(inst.display || inst.name)}</div>
                <div class="rand-card-meta">:${inst.port || '?'} · ${statusLabel}</div>
            </div>
            <div class="rand-card-check"></div>
        `;
        container.appendChild(card);
    });
    updateRandSummary();
    updateRandButton();
}

function showRandCta() {
    const strip = document.getElementById('randActionStrip');
    if (strip && !strip.classList.contains('visible')) {
        requestAnimationFrame(() => strip.classList.add('visible'));
    }
}

function toggleRandCard(name) {
    // Only allow toggling running instances
    const inst = STATE.randInstances.find(i => i.name === name);
    if (!inst || !inst.running) return;
    if (STATE.selectedRand.has(name)) STATE.selectedRand.delete(name);
    else STATE.selectedRand.add(name);
    document.querySelectorAll('#randCards .rand-card').forEach(card => {
        card.classList.toggle('selected', STATE.selectedRand.has(card.dataset.name));
    });
    updateRandSummary(); updateRandButton(); updateHeroContext();
}

function selectRunning() {
    STATE.selectedRand.clear();
    STATE.randInstances.forEach(inst => {
        if (inst.running && inst.root) STATE.selectedRand.add(inst.name);
    });
    document.querySelectorAll('#randCards .rand-card').forEach(card => {
        card.classList.toggle('selected', STATE.selectedRand.has(card.dataset.name));
    });
    updateRandSummary(); updateRandButton(); updateHeroContext();
}

// ─── Inline Instance List ────────────────────────────────────────────────────
function renderIlList() {
    const container = document.getElementById('ilList');
    if (!container) return;
    const instances = STATE.randInstances;
    if (!instances.length) {
        container.innerHTML = '<div class="il-empty">No instances found. Click Refresh.</div>';
        updateIlSummary();
        return;
    }
    container.innerHTML = '';
    const sorted = [...instances].sort((a, b) => {
        if (a.running !== b.running) return b.running ? 1 : -1;
        return (a.display || a.name).localeCompare(b.display || b.name);
    });
    sorted.forEach(inst => {
        const row = document.createElement('div');
        const isRunning = !!inst.running;
        row.className = 'il-row' + (isRunning ? '' : ' stopped');
        row.dataset.name = inst.name;
        let actionBtn = '';
        if (isRunning) {
            actionBtn = '<div class="il-row-action"><button class="il-action-btn il-btn-stop" onclick="event.stopPropagation();ilStopInstance(\'' + inst.name + '\')" title="Stop"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="1"/></svg></button></div>';
        } else {
            actionBtn = '<div class="il-row-action"><button class="il-action-btn il-btn-start" onclick="event.stopPropagation();ilStartInstance(\'' + inst.name + '\')" title="Start"><svg viewBox="0 0 24 24"><polygon points="6 3 20 12 6 21 6 3"/></svg></button></div>';
        }
        row.innerHTML =
            '<div class="il-row-dot ' + (isRunning ? 'running' : 'stopped') + '"></div>' +
            '<div class="il-row-name">' + escapeHtml(inst.display || inst.name) + '</div>' +
            '<div class="il-row-port">:' + (inst.port || '?') + '</div>' +
            '<div class="il-row-status">' + (isRunning ? 'Running' : 'Offline') + '</div>' +
            actionBtn;
        container.appendChild(row);
    });
    updateIlSummary();
}

function updateIlSummary() {
    const running = STATE.randInstances.filter(i => i.running).length;
    const offline = STATE.randInstances.length - running;
    const runEl = document.getElementById('ilRunningCount');
    const offEl = document.getElementById('ilOfflineCount');
    if (runEl) runEl.textContent = running;
    if (offEl) offEl.textContent = offline;
}

async function ilStartInstance(name) {
    const btn = document.querySelector('.il-row[data-name="' + name + '"] .il-action-btn');
    if (btn) btn.classList.add('loading');
    try {
        const result = await pywebview.api.start_instance(name);
        if (result && result.error) {
            showToast('Failed to start ' + name, 'error');
            appendLog('[Error] ' + result.error);
        } else {
            showToast(name + ' starting...', 'success', 2000);
            appendLog(name + ' start command sent');
            setTimeout(() => ilRefresh(), 5000);
        }
    } catch (e) {
        showToast('Error: ' + String(e), 'error');
    } finally {
        if (btn) btn.classList.remove('loading');
    }
}

async function ilStopInstance(name) {
    const btn = document.querySelector('.il-row[data-name="' + name + '"] .il-action-btn');
    if (btn) btn.classList.add('loading');
    try {
        const result = await pywebview.api.stop_instance(name, STATE.engineDir, STATE.bsDir);
        if (result && result.error) {
            showToast('Failed to stop ' + name, 'error');
            appendLog('[Error] ' + result.error);
        } else {
            showToast(name + ' stopping...', 'success', 2000);
            appendLog(name + ' stop command sent');
            setTimeout(() => ilRefresh(), 3000);
        }
    } catch (e) {
        showToast('Error: ' + String(e), 'error');
    } finally {
        if (btn) btn.classList.remove('loading');
    }
}

async function ilStartAll() {
    const stopped = STATE.randInstances.filter(i => !i.running);
    if (stopped.length === 0) { showToast('All instances already running', 'info', 2000); return; }
    appendLog('Starting all stopped instances (' + stopped.length + ')...');
    for (const inst of stopped) {
        try {
            await pywebview.api.start_instance(inst.name);
            appendLog('Start sent: ' + inst.name);
        } catch (e) { appendLog('[Error] ' + inst.name + ': ' + String(e)); }
        await new Promise(r => setTimeout(r, 1500));
    }
    showToast('Start commands sent for ' + stopped.length + ' instances', 'success');
    setTimeout(() => ilRefresh(), 6000);
}

async function ilStopAll() {
    const running = STATE.randInstances.filter(i => i.running);
    if (running.length === 0) { showToast('No running instances', 'info', 2000); return; }
    appendLog('Stopping all running instances (' + running.length + ')...');
    for (const inst of running) {
        try {
            await pywebview.api.stop_instance(inst.name, STATE.engineDir, STATE.bsDir);
            appendLog('Stop sent: ' + inst.name);
        } catch (e) { appendLog('[Error] ' + inst.name + ': ' + String(e)); }
    }
    showToast('Stop commands sent for ' + running.length + ' instances', 'success');
    setTimeout(() => ilRefresh(), 4000);
}

async function ilRefresh() {
    if (STATE.running || !STATE.engineDir) return;
    const btn = document.getElementById('ilBtnRefresh');
    if (btn) btn.disabled = true;
    try {
        const result = await pywebview.api.refresh_instances(STATE.engineDir, STATE.bsDir);
        if (result && !result.error) {
            STATE.randInstances = result.instances || [];
            STATE.imInstances = result.instances || [];
            renderIlList();
            renderRandCards();
            showScanResult();
            updateRandSummary();
            updateRandButton();
            updateHeroStats();
            if (typeof imIsOpen === 'function' && imIsOpen()) {
                renderImTable();
                updateImSummary();
            }
        }
    } catch (e) {
        appendLog('[Error] Inline refresh failed: ' + e);
    } finally {
        if (btn) btn.disabled = false;
    }
}

// ─── Unified Table ───────────────────────────────────────────────────────────
function utRender() {
    const grid = document.getElementById('utGrid');
    if (!grid) return;
    const instances = STATE.randInstances;
    if (!instances.length) {
        grid.innerHTML = '<div class="ut-empty">No instances found. Click Refresh.</div>';
        utUpdateCounts();
        return;
    }
    grid.innerHTML = '';
    // Sort: running first, then alphabetical
    const sorted = [...instances].sort((a, b) => {
        if (a.running !== b.running) return b.running ? 1 : -1;
        return (a.display || a.name).localeCompare(b.display || b.name);
    });
    sorted.forEach(inst => {
        const card = document.createElement('div');
        const isRunning = !!inst.running;
        const hasRoot = !!inst.root;
        const canRand = isRunning && hasRoot;
        card.className = 'ut-card' + (isRunning ? '' : ' offline');
        card.dataset.name = inst.name;

        const startBtn = '<button class="ut-act ut-act-start' + (isRunning ? ' disabled' : '') + '" onclick="event.stopPropagation();utStart(\'' + inst.name + '\')" title="Start"><svg viewBox="0 0 24 24"><polygon points="6 3 20 12 6 21 6 3"/></svg></button>';
        const stopBtn = '<button class="ut-act ut-act-stop' + (!isRunning ? ' disabled' : '') + '" onclick="event.stopPropagation();utStop(\'' + inst.name + '\')" title="Stop"><svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="1"/></svg></button>';
        const deleteBtn = '<button class="ut-act ut-act-delete" onclick="event.stopPropagation();utDelete(\'' + inst.name + '\')" title="Delete"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>';
        const randBtn = '<button class="ut-act ut-act-rand' + (!canRand ? ' disabled' : '') + '" onclick="event.stopPropagation();utRandomize(\'' + inst.name + '\')" title="Randomize"><svg viewBox="0 0 24 24"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg></button>';

        const statusText = isRunning ? (hasRoot ? 'Root' : 'No root') : 'Offline';

        card.innerHTML =
            '<div class="ut-dot ' + (isRunning ? 'on' : 'off') + '"></div>' +
            '<div class="ut-card-info">' +
                '<div class="ut-card-name">' + escapeHtml(inst.display || inst.name) + '</div>' +
                '<div class="ut-card-meta">:' + (inst.port || '?') + ' · ' + statusText + '</div>' +
            '</div>' +
            '<div class="ut-actions">' + startBtn + stopBtn + randBtn + deleteBtn + '</div>';

        grid.appendChild(card);
    });
    utUpdateCounts();
}

function utUpdateCounts() {
    const running = STATE.randInstances.filter(i => i.running).length;
    const total = STATE.randInstances.length;
    const offline = total - running;
    const runEl = document.getElementById('utRunning');
    const offEl = document.getElementById('utOffline');
    const totEl = document.getElementById('utTotal');
    if (runEl) runEl.textContent = running;
    if (offEl) offEl.textContent = offline;
    if (totEl) totEl.textContent = total;
}

async function utStart(name) {
    const btn = document.querySelector('.ut-card[data-name="' + name + '"] .ut-act-start');
    if (btn) btn.classList.add('loading');
    try {
        const result = await pywebview.api.start_instance(name);
        if (result && result.error) {
            showToast('Failed to start ' + name, 'error');
            appendLog('[Error] ' + result.error);
        } else {
            showToast(name + ' starting...', 'success', 2000);
            appendLog(name + ' start command sent');
            setTimeout(() => utRefresh(), 5000);
        }
    } catch (e) { showToast('Error: ' + String(e), 'error'); }
    finally { if (btn) btn.classList.remove('loading'); }
}

async function utStop(name) {
    const btn = document.querySelector('.ut-card[data-name="' + name + '"] .ut-act-stop');
    if (btn) btn.classList.add('loading');
    try {
        const result = await pywebview.api.stop_instance(name, STATE.engineDir, STATE.bsDir);
        if (result && result.error) {
            showToast('Failed to stop ' + name, 'error');
            appendLog('[Error] ' + result.error);
        } else {
            showToast(name + ' stopping...', 'success', 2000);
            appendLog(name + ' stop command sent');
            setTimeout(() => utRefresh(), 3000);
        }
    } catch (e) { showToast('Error: ' + String(e), 'error'); }
    finally { if (btn) btn.classList.remove('loading'); }
}

async function utDelete(name) {
    const inst = STATE.randInstances.find(i => i.name === name);
    const display = inst ? (inst.display || inst.name) : name;
    const isRunning = inst && inst.running;
    let msg = 'Permanently delete ' + display + '?';
    if (isRunning) msg += '\n\nThis instance is running and will be stopped first.';
    msg += '\n\nThis cannot be undone.';
    if (!confirm(msg)) return;

    if (isRunning) {
        appendLog('Stopping ' + name + ' before delete...');
        try { await pywebview.api.stop_instance(name, STATE.engineDir, STATE.bsDir); } catch (e) {}
        await new Promise(r => setTimeout(r, 2000));
    }

    setRunning(true);
    appendLog('Deleting ' + name);
    showToast('Deleting ' + display + '...', 'info');
    try {
        await pywebview.api.do_delete([name], STATE.engineDir);
        setRunning(false);
    } catch (e) {
        appendLog('[Error] ' + String(e));
        setRunning(false);
    }
}

async function utRandomize(name) {
    if (STATE.running) return;
    const inst = STATE.randInstances.find(i => i.name === name);
    if (!inst || !inst.running || !inst.root) {
        showToast('Instance must be running with root', 'error');
        return;
    }
    // Set selection to just this instance and fire randomize
    STATE.selectedRand.clear();
    STATE.selectedRand.add(name);
    doRandomize();
}

async function utStartAll() {
    const stopped = STATE.randInstances.filter(i => !i.running);
    if (!stopped.length) { showToast('All instances already running', 'info', 2000); return; }
    appendLog('Starting all stopped instances (' + stopped.length + ')...');
    for (const inst of stopped) {
        try { await pywebview.api.start_instance(inst.name); appendLog('Start sent: ' + inst.name); }
        catch (e) { appendLog('[Error] ' + inst.name + ': ' + String(e)); }
        await new Promise(r => setTimeout(r, 1500));
    }
    showToast('Start commands sent for ' + stopped.length + ' instances', 'success');
    setTimeout(() => utRefresh(), 6000);
}

async function utStopAll() {
    const running = STATE.randInstances.filter(i => i.running);
    if (!running.length) { showToast('No running instances', 'info', 2000); return; }
    appendLog('Stopping all running instances (' + running.length + ')...');
    for (const inst of running) {
        try { await pywebview.api.stop_instance(inst.name, STATE.engineDir, STATE.bsDir); appendLog('Stop sent: ' + inst.name); }
        catch (e) { appendLog('[Error] ' + inst.name + ': ' + String(e)); }
    }
    showToast('Stop commands sent for ' + running.length + ' instances', 'success');
    setTimeout(() => utRefresh(), 4000);
}

async function utRefresh() {
    if (STATE.running || !STATE.engineDir) return;
    const btn = document.getElementById('utBtnRefresh');
    if (btn) btn.disabled = true;
    try {
        const result = await pywebview.api.refresh_instances(STATE.engineDir, STATE.bsDir);
        if (result && !result.error) {
            STATE.randInstances = result.instances || [];
            STATE.imInstances = result.instances || [];
            utRender();
            updateHeroStats();
            if (typeof imIsOpen === 'function' && imIsOpen()) {
                renderImTable();
                updateImSummary();
            }
        }
    } catch (e) { appendLog('[Error] Refresh failed: ' + e); }
    finally { if (btn) btn.disabled = false; }
}

function updateRandSummary() {
    const running = STATE.randInstances.filter(i => i.running).length;
    const total = STATE.randInstances.length;
    const offline = total - running;
    const selected = STATE.selectedRand.size;
    const countEl = document.getElementById('randReadyCount');
    const labelEl = document.querySelector('.rand-summary-label');
    if (countEl) countEl.textContent = running;
    if (labelEl) {
        let html = `running`;
        if (offline > 0) html += ` <span class="rand-summary-sel">| ${offline} offline</span>`;
        if (selected > 0) html += ` <span class="rand-summary-sel">· ${selected} selected</span>`;
        labelEl.innerHTML = html;
    }
}

function updateRandButton() {
    const btn = document.getElementById('btnRandomizeAll');
    const stripText = document.getElementById('randStripText');
    const label = document.getElementById('btnRandLabel');
    if (!btn) return;

    if (STATE.running) return;

    const hasSelection = STATE.selectedRand.size > 0;
    const count = STATE.selectedRand.size;

    btn.classList.toggle('active', hasSelection);

    // Update strip text contextually
    if (stripText) {
        if (hasSelection) {
            stripText.textContent = count + ' instance' + (count > 1 ? 's' : '') + ' ready to shuffle';
            stripText.style.color = '#80858a';
        } else {
            stripText.textContent = 'Shuffle device identities across selected instances';
            stripText.style.color = '';
        }
    }

    // Update button label
    if (label) {
        label.textContent = hasSelection ? 'Randomize' : 'Select Instance(s)';
    }
}

// toggleRandOptions: removed (HTML elements randOptions/randOptionsToggle no longer exist)

function resetRandUI() {
    setRunning(false);
    cancelParticles(); // Cancel any ongoing scramble animation
    const ctaBtn = document.getElementById('btnRandomizeAll');
    if (ctaBtn) {
        ctaBtn.classList.remove('running');
    }
    // Defer so DOM repaints with new content size first
    requestAnimationFrame(() => updateRandButton());
}

// ─── Per-instance progress callbacks (called from Python backend) ────────────
window.onRandProgress = function(instanceName, stepIndex, stepStatus, statusText) {
    const row = document.getElementById('prog-' + instanceName);
    const fill = document.getElementById('prog-' + instanceName + '-fill');
    const ind = document.getElementById('prog-' + instanceName + '-ind');
    const statusEl = document.getElementById('prog-' + instanceName + '-status');
    const totalSteps = row ? parseInt(row.dataset.steps) || 4 : 4;

    // Update progress bar fill
    if (fill) {
        let pct = 0;
        if (stepStatus === 'done') pct = ((stepIndex + 1) / totalSteps) * 100;
        else if (stepStatus === 'active') pct = (stepIndex / totalSteps) * 100 + (50 / totalSteps);
        else if (stepStatus === 'fail') {
            pct = ((stepIndex + 1) / totalSteps) * 100;
            fill.classList.add('fail');
        }
        fill.style.width = Math.min(pct, 100) + '%';
    }

    // Update indicator circle
    if (ind) {
        ind.className = 'rand-prog-indicator';
        if (stepStatus === 'active') {
            ind.classList.add('active');
            ind.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" stroke="currentColor" fill="none"/></svg>';
        } else if (stepStatus === 'done') {
            ind.classList.add('active');
            ind.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" stroke="currentColor" fill="none"/></svg>';
        } else if (stepStatus === 'fail') {
            ind.classList.add('fail');
            ind.innerHTML = '<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
        }
    }

    // Update status text
    if (statusEl) {
        statusEl.textContent = statusText || '';
        statusEl.className = 'rand-prog-status';
        if (stepStatus === 'done') statusEl.classList.add('active');
        else if (stepStatus === 'fail') statusEl.classList.add('fail');
        else statusEl.classList.add('active');
    }
};

window.onRandInstanceDone = function(instanceName, success) {
    const row = document.getElementById('prog-' + instanceName);
    const fill = document.getElementById('prog-' + instanceName + '-fill');
    const ind = document.getElementById('prog-' + instanceName + '-ind');
    const statusEl = document.getElementById('prog-' + instanceName + '-status');

    if (row) row.classList.add(success ? 'done' : 'fail');

    if (fill) {
        fill.style.width = '100%';
        if (!success) fill.classList.add('fail');
    }

    if (ind) {
        ind.className = 'rand-prog-indicator ' + (success ? 'ok' : 'fail');
        ind.innerHTML = success
            ? '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>'
            : '<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
    }

    if (statusEl) {
        statusEl.textContent = success ? 'Complete' : 'Failed';
        statusEl.className = 'rand-prog-status ' + (success ? 'ok' : 'fail');
    }

    // Update counter
    const doneCount = document.querySelectorAll('.rand-prog-item.done, .rand-prog-item.fail').length;
    const total = STATE.selectedRand.size;
    const counterEl = document.getElementById('randProgressCounter');
    if (counterEl) counterEl.innerHTML = '<span class="counter-done">' + doneCount + '</span> of ' + total;
};

// ─── Shuffle Icon Loading ────────────────────────────────────────────────────
let _iconStopPending = false;
let _iconAnimHandler = null;

function disintegrateButton() {
    _iconStopPending = false;
    const icon = document.getElementById('randBtnIcon');
    if (!icon) return;

    // Listen for each rotation cycle completing
    if (_iconAnimHandler) icon.removeEventListener('animationiteration', _iconAnimHandler);
    _iconAnimHandler = function() {
        if (_iconStopPending) {
            icon.classList.remove('loading');
            icon.removeEventListener('animationiteration', _iconAnimHandler);
            _iconAnimHandler = null;
            _iconStopPending = false;
            requestAnimationFrame(() => updateRandButton());
        }
    };
    icon.addEventListener('animationiteration', _iconAnimHandler);
    icon.classList.add('loading');
}

function reformButton() {
    // Signal: stop at the end of the current full rotation
    _iconStopPending = true;
}

function cancelParticles() {
    _iconStopPending = false;
    const icon = document.getElementById('randBtnIcon');
    if (icon) {
        if (_iconAnimHandler) icon.removeEventListener('animationiteration', _iconAnimHandler);
        _iconAnimHandler = null;
        icon.classList.remove('loading');
    }
}

// ─── Randomize ───────────────────────────────────────────────────────────────
async function doRandomize() {
    if (STATE.running || STATE.selectedRand.size === 0) return;
    const names = Array.from(STATE.selectedRand);
    const doProfile = true;
    const skipReboot = false;

    setRunning(true);
    appendLog('Starting randomization for ' + names.length + ' instance(s)...');

    // Scramble button text
    disintegrateButton();

    // Switch button to running state (keep content visible — icon spins)
    const ctaBtn = document.getElementById('btnRandomizeAll');
    if (ctaBtn) {
        ctaBtn.classList.remove('active');
        ctaBtn.classList.add('running');
    }

    // Show progress panel and build per-instance rows
    const panel = document.getElementById('randProgressPanel');
    const list = document.getElementById('randProgressList');
    if (panel) panel.style.display = '';
    const counter = document.getElementById('randProgressCounter');
    if (counter) counter.innerHTML = '<span class="counter-done">0</span> of ' + names.length;

    // Step count: connect, [profile], identifiers, cache, reboot
    const stepCount = doProfile ? 5 : 4;

    if (list) list.innerHTML = '';
    names.forEach(name => {
        const inst = STATE.randInstances.find(i => i.name === name);
        const display = inst ? (inst.display || inst.name) : name;
        const row = document.createElement('div');
        row.className = 'rand-prog-item';
        row.id = 'prog-' + name;
        row.dataset.steps = stepCount;
        row.innerHTML = `
            <div class="rand-prog-indicator waiting" id="prog-${name}-ind">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" fill="#4a4f54" stroke="none"/></svg>
            </div>
            <div class="rand-prog-body">
                <div class="rand-prog-name">${escapeHtml(display)}</div>
                <div class="rand-prog-track">
                    <div class="rand-prog-fill" id="prog-${name}-fill"></div>
                </div>
            </div>
            <span class="rand-prog-status" id="prog-${name}-status">Queued</span>
        `;
        list.appendChild(row);
    });

    try {
        const result = await pywebview.api.do_randomize(names, STATE.engineDir, STATE.bsDir, doProfile, skipReboot);
        if (result && result.error) {
            appendLog('[Error] ' + result.error);
            showToast('Randomization failed', 'error');
            resetRandUI();
        }
    } catch (e) {
        appendLog('[Error] ' + e);
        showToast('Randomization error', 'error');
        resetRandUI();
    }
}

// ─── Steps ───────────────────────────────────────────────────────────────────
function updateSteps() {
    let currentStep = 0;
    if (STATE.engineDir) currentStep = 1;
    if (STATE.engineDir && STATE.bsDir) currentStep = 2;
    if (STATE.rooted) currentStep = 3;
    if (STATE.imageDownloaded) currentStep = 4;
    if (STATE.permissionsOk) currentStep = 5;

    for (let i = 0; i < 5; i++) {
        const card = document.getElementById('step' + i);
        if (!card) continue;
        const wasCompleted = card.classList.contains('completed');
        card.className = 'step-card';

        if (i < currentStep) {
            card.classList.add('completed');
            card.querySelector('.step-time').textContent = 'Complete';
            if (!wasCompleted && STATE.prevStep >= 0 && !STATE.setupMode) {
                playStepAnim(i);
            }
        } else if (i === currentStep) {
            card.classList.add('current');
            card.querySelector('.step-time').textContent = '';
        } else {
            card.classList.add(STATE.setupMode ? 'waiting' : 'locked');
            card.querySelector('.step-time').textContent = '';
        }
    }

    // Connector fill — 5 cards → 4 gaps
    const fillPct = currentStep <= 0 ? 0 : (currentStep / 4) * 100;
    const fillEl = document.getElementById('connectorFill');
    if (fillEl) {
        fillEl.style.width = Math.min(fillPct, 100) + '%';
        fillEl.style.display = currentStep <= 0 ? 'none' : 'block';
    }

    STATE.prevStep = currentStep;
}

// ─── Running state ───────────────────────────────────────────────────────────
function setRunning(val) {
    STATE.running = val;
    const logDot = document.getElementById('logDot');
    if (logDot) logDot.classList.toggle('active', val);
    setProgressBar(val);
    updateRandButton();
    const refreshBtn = document.getElementById('btnRefresh');
    if (refreshBtn) refreshBtn.disabled = val;
    const randBannerBtn = document.getElementById('btnRandomizeBanner');
    if (randBannerBtn) randBannerBtn.disabled = val;
    const mgrBtn = document.getElementById('btnManageInstances');
    if (mgrBtn) mgrBtn.disabled = val;
    // Disable unified table bulk buttons during operations
    ['utBtnStartAll','utBtnStopAll','utBtnRefresh','utBtnCdp'].forEach(id => {
        const b = document.getElementById(id);
        if (b) b.disabled = val;
    });
    updateHeroContext();
}

// ─── Log ─────────────────────────────────────────────────────────────────────
let logLineCount = 0;
window.appendLog = function(line) {
    const body = document.getElementById('logBody');
    if (!body) return;
    const div = document.createElement('div');
    div.className = 'l';
    div.style.animationDelay = ((logLineCount % 10) * 15) + 'ms';
    logLineCount++;

    const tagMatch = line.match(/^\[(ok|do|fail|skip|Error|——)\]\s*/);
    let dotClass = 'do';
    let msg = line;
    if (tagMatch) {
        const tag = tagMatch[1];
        msg = line.slice(tagMatch[0].length);
        if (tag === 'ok') dotClass = 'ok';
        else if (tag === 'fail' || tag === 'Error') dotClass = 'fail';
        else if (tag === 'skip') dotClass = 'skip';
    }
    div.innerHTML = `<span class="l-dot ${dotClass}"></span><span class="l-msg">${formatLogMsg(msg)}</span>`;
    body.appendChild(div);
    body.scrollTop = body.scrollHeight;
};

window.replaceLine = function(line) {
    const body = document.getElementById('logBody');
    if (!body) { window.appendLog(line); return; }
    const last = body.lastElementChild;
    if (last) {
        const tagMatch = line.match(/^\[(ok|do|fail|skip|Error|——)\]\s*/);
        let dotClass = 'do';
        let msg = line;
        if (tagMatch) {
            const tag = tagMatch[1];
            msg = line.slice(tagMatch[0].length);
            if (tag === 'ok') dotClass = 'ok';
            else if (tag === 'fail' || tag === 'Error') dotClass = 'fail';
        }
        last.innerHTML = `<span class="l-dot ${dotClass}"></span><span class="l-msg">${formatLogMsg(msg)}</span>`;
        body.scrollTop = body.scrollHeight;
    } else {
        window.appendLog(line);
    }
};

window.onOperationDone = function(opName) {
    const op = (opName || '').toLowerCase();
    const doneMsg = {
        randomize: 'Randomization complete',
        clone: 'Clone complete',
        download: 'Download complete',
        delete: 'Delete complete',
    }[op] || 'Operation complete';

    setRunning(false);
    showToast(doneMsg, 'success');
    updateHeroStats();

    // Refresh instance data and sync randomize tab after any operation
    if (STATE.engineDir) {
        imRefreshInstances();
        if (typeof renderRandCards === 'function') renderRandCards();
        if (typeof renderIlList === 'function') renderIlList();
        if (typeof utRender === 'function') utRender();
        if (typeof updateRandSummary === 'function') updateRandSummary();
        if (typeof updateRandButton === 'function') updateRandButton();
    }

    // Randomize CTA cleanup
    if (!op || op === 'randomize') {
        const ctaBtn = document.getElementById('btnRandomizeAll');
        if (ctaBtn) {
            ctaBtn.classList.remove('running');
        }
        // Stop icon spin (waits for full rotation)
        reformButton();
    }

    // Re-scan instances
    if (STATE.engineDir) {
        pywebview.api.scan_instances_for_dir(STATE.engineDir).then(instances => {
            STATE.instances = instances;
            updateHeroStats();
        }).catch(() => {});
    }
};

function formatLogMsg(msg) {
    msg = escapeHtml(msg);
    msg = msg.replace(/\(([^)]+)\)/g, '(<span class="hl">$1</span>)');
    msg = msg.replace(/→\s*(.+?)$/g, '→ <span class="ac">$1</span>');
    msg = msg.replace(/(complete\.?)/gi, '<span class="gn">$1</span>');
    msg = msg.replace(/(reboot issued)/gi, '<span class="gn">$1</span>');
    msg = msg.replace(/(successfully)/gi, '<span class="gn">$1</span>');
    return msg;
}

function clearLog() {
    const logBody = document.getElementById('logBody');
    if (logBody) logBody.innerHTML = '';
    logLineCount = 0;
}

// ─── Toggle Paths (Engine/Install directory bar) ─────────────────────────────
function togglePaths() {
    const paths = document.querySelector('.paths');
    const btn = document.getElementById('togglePathsBtn');
    if (!paths || !btn) return;
    paths.classList.toggle('hidden');
    btn.classList.toggle('active', !paths.classList.contains('hidden'));
}

// ─── Toggle Activity Log (hidden ↔ pop-out) ──────────────────────────────────
let logPopout = false;
function toggleLog() {
    const log = document.querySelector('.log');
    const btn = document.getElementById('toggleLogBtn');
    if (!log || !btn) return;
    logPopout = !logPopout;

    if (logPopout) {
        log.classList.add('popout');
        log.classList.remove('hidden-inline');
        btn.classList.add('active');
    } else {
        log.classList.remove('popout');
        log.classList.add('hidden-inline');
        btn.classList.remove('active');
    }
}

// ─── Utils ───────────────────────────────────────────────────────────────────
function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Placeholder for future external link handling

// ─── Advanced tab ────────────────────────────────────────────────────────────
function selectAdvCard(option) {
    // Second click on already-selected card = execute the action
    if (STATE.advancedOption === option) {
        doAdvancedAction();
        return;
    }

    STATE.advancedOption = option;
    document.querySelectorAll('.adv-card').forEach(c => {
        c.classList.toggle('selected', c.dataset.option === option);
    });
}

function doAdvancedAction() {
    const option = STATE.advancedOption;
    if (!option) return;
    if (option === 'wizard') {
        initSetupWizard(true);
        return;
    }
    if (option === 'help') {
        window.open('https://discord.com/channels/272130394655031308/1472408258533789862');
        return;
    }
    if (option === 'download') {
        openDownloadModal();
        return;
    }
    if (option === 'clone') {
        openAdvCloneModal();
        return;
    }
}

// ─── Download modal ──────────────────────────────────────────────────────────
function openDownloadModal() {
    // Mark panels that already have complete images
    const complete = new Set((STATE.sourceImages || []).filter(i => i.complete).map(i => i.name));
    const a11Panel = document.getElementById('dlPanelA11');
    const a13Panel = document.getElementById('dlPanelA13');
    if (a11Panel) a11Panel.classList.toggle('dl-done', complete.has('a11'));
    if (a13Panel) a13Panel.classList.toggle('dl-done', complete.has('a13'));

    // Reset progress bar
    const dlProgress = document.getElementById('dlModalProgress');
    const dlBar = document.getElementById('dlModalBar');
    const dlText = document.getElementById('dlModalText');
    if (dlProgress) dlProgress.style.display = 'none';
    if (dlBar) dlBar.style.width = '0%';
    if (dlText) dlText.textContent = '';

    const dlModal = document.getElementById('downloadModal');
    if (dlModal) dlModal.style.display = '';
}

function closeDownloadModal() {
    document.getElementById('downloadModal').style.display = 'none';
}

async function startAdvDownload(version) {
    const progressWrap = document.getElementById('dlModalProgress');
    const bar = document.getElementById('dlModalBar');
    const text = document.getElementById('dlModalText');

    progressWrap.style.display = '';
    bar.style.width = '0%';
    text.textContent = 'Starting download...';

    try {
        const result = await pywebview.api.download_image(STATE.engineDir, version);
        if (result && result.skipped) {
            text.textContent = result.message || 'No download URL configured. Place files manually.';
            showToast('Directory created: ' + (result.path || version), 'info', 4000);
            await sleep(2000);
            closeDownloadModal();
        } else if (result && result.error) {
            text.textContent = 'Error: ' + result.error;
        }
        // If download started in background, onDownloadProgress will update the bar
    } catch (e) {
        text.textContent = 'Error: ' + e;
    }
}

// Download progress handler — called from Python via evaluate_js
window.onDownloadProgress = function(pct, status) {
    const bar = document.getElementById('dlModalBar');
    const text = document.getElementById('dlModalText');
    if (!bar || !text) return;

    if (pct >= 0) {
        bar.style.width = pct + '%';
    }

    if (status === 'downloading') {
        text.textContent = 'Downloading... ' + pct + '%';
    } else if (status === 'extracting') {
        text.textContent = 'Extracting archive...';
    } else if (status === 'done') {
        text.textContent = 'Complete!';
        refreshSourceImages();
        setTimeout(closeDownloadModal, 1500);
    } else {
        text.textContent = status;  // Error message
    }
};

async function refreshSourceImages() {
    try {
        const result = await pywebview.api.get_source_images();
        STATE.imagesDir = result.images_dir;
        STATE.sourceImages = result.images;
    } catch(e) {}
}

// ─── Advanced Clone modal ────────────────────────────────────────────────────
let _cloneAnalysis = null;

/**
 * Extract the instance family (base name) from an instance name.
 * "Rvc64_2" -> "Rvc64", "Cnc64" -> "Cnc64"
 */
function getInstanceFamily(name) {
    const m = name.match(/^(.+?)_(\d+)$/);
    if (!m) return name;
    const candidate = m[1];
    const allFolders = (_cloneAnalysis && _cloneAnalysis.all_dirs) || [];
    return allFolders.some(f => (f.name || f) === candidate) ? candidate : name;
}

function escapeRegExp(str) {
    return String(str || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function getAdvCloneSourceValue() {
    const el = document.getElementById('advCloneSource');
    return el ? el.value : '';
}

function getAdvClonePrefixFromSource() {
    const sourceVal = getAdvCloneSourceValue();
    if (!sourceVal) return 'Tiramisu64';
    if (sourceVal.startsWith('IMAGE:')) {
        // MUST use Tiramisu64 prefix — BS's MIM parses instance name prefixes
        // to determine Android image type via UtlAndroidImageTraits::get().
        // Any other prefix (a13, data, Clone, etc.) causes a SIGTRAP crash.
        return 'Tiramisu64';
    }
    return getInstanceFamily(sourceVal);
}

function setAdvCloneMode(mode) {
    const newMode = (mode === 'replace') ? 'replace' : 'new';
    STATE.advCloneMode = newMode;

    const btnNew = document.getElementById('advCloneModeNew');
    const btnReplace = document.getElementById('advCloneModeReplace');
    const panelNew = document.getElementById('advCloneNewPanel');
    const panelReplace = document.getElementById('advCloneReplacePanel');
    const actionBtn = document.getElementById('btnAdvClone');

    if (btnNew) btnNew.classList.toggle('active', newMode === 'new');
    if (btnReplace) btnReplace.classList.toggle('active', newMode === 'replace');
    if (panelNew) panelNew.hidden = (newMode !== 'new');
    if (panelReplace) panelReplace.hidden = (newMode !== 'replace');
    if (actionBtn) actionBtn.textContent = (newMode === 'new') ? 'Create Instances' : 'Replace Selected';

    if (newMode === 'new') {
        const prefixInput = document.getElementById('advClonePrefix');
        if (prefixInput && !prefixInput.value.trim()) {
            prefixInput.value = getAdvClonePrefixFromSource();
        }
        const entriesEl = document.getElementById('advCloneEntries');
        if (entriesEl && !entriesEl.querySelector('.adv-clone-entry-row')) {
            generateAdvCloneNames();
        }
    }
    updateAdvCloneCount();
}

async function openAdvCloneModal() {
    if (!STATE.engineDir) {
        showToast('Engine directory not set', 'error');
        return;
    }
    // Analyze existing instances
    try {
        _cloneAnalysis = await pywebview.api.analyze_clones(STATE.engineDir);
    } catch (e) {
        _cloneAnalysis = { error: String(e), source: '', clones: [], all_dirs: [] };
    }

    const allFolders = (_cloneAnalysis && _cloneAnalysis.all_dirs) || [];
    const srcName = (_cloneAnalysis && _cloneAnalysis.source) || '';
    const firstFolder = allFolders.length ? (allFolders[0].name || allFolders[0]) : 'Rvc64';
    const src = srcName || firstFolder;

    if (allFolders.length === 0 && _cloneAnalysis && _cloneAnalysis.error) {
        showToast(_cloneAnalysis.error, 'error');
        return;
    }

    // ── Populate source dropdown ──
    const sel = document.getElementById('advCloneSource');
    sel.innerHTML = '';
    const seen = new Set();

    // Source images first (recommended)
    const sourceImages = (STATE.sourceImages || []).filter(img => img.complete);
    if (sourceImages.length > 0) {
        const imgGroup = document.createElement('optgroup');
        imgGroup.label = 'Source Images (Recommended)';
        sourceImages.forEach((img, i) => {
            const o = document.createElement('option');
            o.value = 'IMAGE:' + img.path;
            o.textContent = img.name + ' (' + img.size_mb + ' MB)' + (i === 0 ? ' (Recommended)' : '');
            imgGroup.appendChild(o);
        });
        sel.appendChild(imgGroup);
    }

    // Engine instances
    if (allFolders.length) {
        const instGroup = document.createElement('optgroup');
        instGroup.label = 'Engine Instances';
        allFolders.forEach(folder => {
            const name = folder.name || folder;
            const display = folder.display || name;
            if (seen.has(name)) return;
            seen.add(name);
            const o = document.createElement('option');
            o.value = name;
            o.textContent = display;
            instGroup.appendChild(o);
        });
        sel.appendChild(instGroup);
    } else if (sourceImages.length === 0) {
        // No images and no instances — fall back to default
        const o = document.createElement('option');
        o.value = src;
        o.textContent = src;
        sel.appendChild(o);
    }

    // ── Build target instance checklist from the actual selected source option ──
    const selectedSource = sel.value || src;
    buildAdvCloneTargets(selectedSource.startsWith('IMAGE:') ? null : selectedSource);

    // Initialize new-instance defaults
    const prefix = document.getElementById('advClonePrefix');
    const count = document.getElementById('advCloneCount');
    const entriesContainer = document.getElementById('advCloneEntries');
    if (prefix) prefix.value = getAdvClonePrefixFromSource();
    if (count && (!count.value || parseInt(count.value, 10) <= 0)) count.value = '3';
    if (entriesContainer) entriesContainer.innerHTML = '<div class="adv-clone-no-entries">Click <b>Generate</b> to create entries</div>';

    // Default to "create new" mode for no-MIM flow
    setAdvCloneMode('new');
    generateAdvCloneNames();

    document.getElementById('advCloneModal').style.display = '';
}

function buildAdvCloneTargets(sourceName) {
    const list = document.getElementById('advCloneTargets');
    const allFolders = (_cloneAnalysis && _cloneAnalysis.all_dirs) || [];
    const checkSvg = '<svg viewBox="0 0 17 17" fill="none" stroke="#10B685" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3.5 8.5 7 12 13.5 5"/></svg>';

    list.innerHTML = '';

    // Select-all row
    list.innerHTML = '<div class="modal-select-all"><label class="modal-check"><input type="checkbox" id="advSelectAll" checked onchange="toggleAdvCloneAll(this.checked)"><span class="modal-check-mark">' + checkSvg + '</span></label><label for="advSelectAll">Select all</label></div>';

    // Filter targets to same family as source (prevent cross-family cloning)
    let filteredFolders;
    if (sourceName) {
        const sourceFamily = getInstanceFamily(sourceName);
        filteredFolders = allFolders.filter(f => getInstanceFamily(f.name || f) === sourceFamily);
    } else {
        filteredFolders = allFolders; // Source image — all instances are valid targets
    }

    let targetCount = 0;
    filteredFolders.forEach(folder => {
        const name = folder.name || folder;
        const display = folder.display || name;
        const isSource = (name === sourceName);

        const item = document.createElement('div');
        item.className = 'adv-clone-target-item' + (isSource ? ' is-source' : '');

        if (isSource) {
            item.innerHTML = '<label class="modal-check"><input type="checkbox" disabled class="adv-clone-cb" value="' + name + '"><span class="modal-check-mark">' + checkSvg + '</span></label>'
                + '<span class="adv-clone-target-name">' + display + '</span>'
                + '<span class="adv-clone-target-meta">source</span>';
        } else {
            targetCount++;
            item.innerHTML = '<label class="modal-check"><input type="checkbox" checked class="adv-clone-cb" value="' + name + '" onchange="updateAdvCloneCount()"><span class="modal-check-mark">' + checkSvg + '</span></label>'
                + '<span class="adv-clone-target-name">' + display + '</span>';
            item.onclick = function(e) {
                if (e.target.tagName !== 'INPUT' && !e.target.closest('.modal-check')) {
                    const cb = item.querySelector('input');
                    cb.checked = !cb.checked;
                    updateAdvCloneCount();
                }
            };
        }
        list.appendChild(item);
    });

    // Bottom hint
    const hint = document.createElement('div');
    hint.className = 'adv-clone-target-hint';
    hint.textContent = 'Select existing instances to overwrite. Use Create New mode to build instances from scratch.';
    list.appendChild(hint);

    updateAdvCloneCount();
}

function toggleAdvCloneAll(checked) {
    document.querySelectorAll('.adv-clone-cb:not(:disabled)').forEach(cb => cb.checked = checked);
    updateAdvCloneCount();
}

// ─── Delete instances (standalone modal) ─────────────────────────────────────

var _deleteAnalysis = null;
var _deleteSelected = new Set();

async function openDeleteModal() {
    if (!STATE.engineDir) {
        showToast('Engine directory not set', 'error');
        return;
    }
    try {
        _deleteAnalysis = await pywebview.api.analyze_clones(STATE.engineDir);
    } catch (e) {
        _deleteAnalysis = { error: String(e), source: '', clones: [], all_dirs: [] };
    }
    _deleteSelected = new Set();
    buildDeleteGrid();
    updateDeleteCount();
    document.getElementById('deleteModal').style.display = '';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

function buildDeleteGrid() {
    const grid = document.getElementById('delGrid');
    if (!grid) return;
    grid.innerHTML = '';

    const allFolders = (_deleteAnalysis && _deleteAnalysis.all_dirs) || [];
    const checkSvg = '<svg viewBox="0 0 17 17" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3.5 8.5 7 12 13.5 5"/></svg>';

    if (allFolders.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px 0;color:#3a3f48;font-size:0.6rem;">No instances found</div>';
        return;
    }

    allFolders.forEach(folder => {
        const name = folder.name || folder;
        const display = folder.display || name;
        const isSelected = _deleteSelected.has(name);

        const card = document.createElement('div');
        card.className = 'del-card' + (isSelected ? ' selected' : '');
        card.dataset.instance = name;

        card.innerHTML =
            '<img class="del-card-logo" src="bs.png" alt="" draggable="false">'
            + '<div class="del-card-text">'
            +   '<div class="del-card-name">' + display + '</div>'
            +   '<div class="del-card-desc">' + name + '</div>'
            + '</div>'
            + '<div class="del-card-check">' + checkSvg + '</div>';

        card.onclick = function() {
            if (_deleteSelected.has(name)) {
                _deleteSelected.delete(name);
                card.classList.remove('selected');
            } else {
                _deleteSelected.add(name);
                card.classList.add('selected');
            }
            updateDeleteCount();
        };

        grid.appendChild(card);
    });
}

function updateDeleteCount() {
    const selected = _deleteSelected.size;
    const btn = document.getElementById('btnDeleteConfirm');
    const sub = document.getElementById('deleteSubtitle');
    if (btn) {
        btn.disabled = selected === 0;
        btn.textContent = selected > 0 ? 'Delete ' + selected + ' Instance' + (selected !== 1 ? 's' : '') : 'Delete Selected';
    }
    if (sub) {
        if (selected > 0) {
            sub.textContent = selected + ' instance' + (selected !== 1 ? 's' : '') + ' will be permanently deleted.';
            sub.style.color = '#dc3545';
        } else {
            sub.textContent = 'Select instances to permanently remove.';
            sub.style.color = '#4a4f58';
        }
    }
}

async function startDeleteInstances() {
    const targets = Array.from(_deleteSelected);
    if (targets.length === 0) {
        showToast('Select at least one instance to delete', 'error', 3000);
        return;
    }

    const confirmMsg = 'Are you sure you want to permanently delete ' + targets.length + ' instance' + (targets.length !== 1 ? 's' : '') + '?\n\n' + targets.join('\n') + '\n\nThis cannot be undone.';
    if (!confirm(confirmMsg)) return;

    closeDeleteModal();
    setRunning(true);
    appendLog('Deleting ' + targets.join(', '));
    showToast('Deleting ' + targets.length + ' instance' + (targets.length !== 1 ? 's' : '') + '...', 'info');

    try {
        const result = await pywebview.api.do_delete(targets, STATE.engineDir);
        if (result && result.error) {
            appendLog('[Error] ' + result.error);
            setRunning(false);
            showToast('Delete failed', 'error');
        }
    } catch (e) {
        appendLog('[Error] ' + String(e));
        setRunning(false);
        showToast('Delete failed: ' + String(e), 'error');
    }
}

// ─── Randomize Results Modal ─────────────────────────────────────────────────

var _randResultsData = [];
var _rrActiveTab = 0;

// Human-readable labels for identifier keys
const IDENT_LABELS = {
    'ACTIVE_PROFILE':       'Device Profile',
    'PROFILE_IMEI':         'IMEI',
    'PROFILE_MEID':         'MEID',
    'PROFILE_IMSI':         'IMSI',
    'PROFILE_ICCID':        'ICCID',
    'PROFILE_PHONE_NUMBER': 'Phone Number',
    'PROFILE_ANDROID_ID':   'Android ID',
    'PROFILE_GSF_ID':       'GSF ID',
    'PROFILE_GAID':         'Google Ad ID',
};

// Preferred display order
const IDENT_ORDER = [
    'ACTIVE_PROFILE',
    'PROFILE_IMEI',
    'PROFILE_MEID',
    'PROFILE_IMSI',
    'PROFILE_ICCID',
    'PROFILE_PHONE_NUMBER',
    'PROFILE_ANDROID_ID',
    'PROFILE_GSF_ID',
    'PROFILE_GAID',
];

window.onRandResults = function(data) {
    try {
        _randResultsData = (typeof data === 'string') ? JSON.parse(data) : data;
    } catch (e) {
        _randResultsData = [];
    }
    if (_randResultsData.length === 0) return;
    _rrActiveTab = 0;
    buildRRTabs();
    buildRRTable(0);
    document.getElementById('randResultsModal').style.display = '';
};

function closeRandResults() {
    document.getElementById('randResultsModal').style.display = 'none';
}

function buildRRTabs() {
    const container = document.getElementById('rrTabs');
    if (!container) return;
    container.innerHTML = '';
    _randResultsData.forEach((inst, idx) => {
        const tab = document.createElement('button');
        tab.className = 'rr-tab' + (idx === 0 ? ' active' : '');
        tab.textContent = inst.display || inst.name;
        tab.onclick = function() {
            _rrActiveTab = idx;
            container.querySelectorAll('.rr-tab').forEach((t, i) => t.classList.toggle('active', i === idx));
            buildRRTable(idx);
        };
        container.appendChild(tab);
    });
}

function buildRRTable(idx) {
    const body = document.getElementById('rrBody');
    if (!body) return;
    const inst = _randResultsData[idx];
    if (!inst) { body.innerHTML = ''; return; }

    const before = inst.before || {};
    const after = inst.after || {};

    // Collect all keys from both, but prefer our ordered list
    const allKeys = new Set([...IDENT_ORDER]);
    Object.keys(before).forEach(k => allKeys.add(k));
    Object.keys(after).forEach(k => allKeys.add(k));

    // Build ordered list: known keys first, then any extras
    const ordered = [];
    IDENT_ORDER.forEach(k => { if (allKeys.has(k)) ordered.push(k); });
    allKeys.forEach(k => { if (!IDENT_ORDER.includes(k)) ordered.push(k); });

    let html = '<table class="rr-table">';
    html += '<tr><th>Identifier</th><th>Before</th><th></th><th>After</th></tr>';

    ordered.forEach(key => {
        const oldVal = escapeHtml(before[key] || '—');
        const newVal = escapeHtml(after[key] || '—');
        const label = escapeHtml(IDENT_LABELS[key] || key);
        const changed = oldVal !== newVal;

        html += '<tr>'
            + '<td class="rr-label">' + label + '</td>'
            + '<td class="' + (changed ? 'rr-old' : 'rr-unchanged') + '">' + oldVal + '</td>'
            + '<td class="rr-arrow">' + (changed ? '→' : '') + '</td>'
            + '<td class="' + (changed ? 'rr-new' : 'rr-unchanged') + '">' + newVal + '</td>'
            + '</tr>';
    });

    html += '</table>';
    body.innerHTML = html;
}

function parseAdvCloneNewEntries() {
    const sourceVal = getAdvCloneSourceValue();
    const sourceName = sourceVal && !sourceVal.startsWith('IMAGE:') ? sourceVal : null;
    const existing = new Set(((_cloneAnalysis && _cloneAnalysis.all_dirs) || []).map(f => f.name || f));
    const container = document.getElementById('advCloneEntries');
    const rows = container ? container.querySelectorAll('.adv-clone-entry-row') : [];
    const entries = [];
    const errors = [];
    const seen = new Set();

    rows.forEach((row, i) => {
        const engineInput = row.querySelector('.entry-engine');
        const displayInput = row.querySelector('.entry-display');
        if (!engineInput || !displayInput) return;

        const name = engineInput.value.trim();
        const display = displayInput.value.trim();
        const lineNo = i + 1;

        if (!name) {
            errors.push(`Row ${lineNo}: missing engine name`);
            return;
        }
        if (!/^[A-Za-z0-9._-]+$/.test(name)) {
            errors.push(`Row ${lineNo}: invalid name '${name}'`);
            return;
        }
        if (sourceName && name === sourceName) {
            errors.push(`Row ${lineNo}: '${name}' matches source`);
            return;
        }
        if (seen.has(name)) {
            errors.push(`Row ${lineNo}: duplicate '${name}'`);
            return;
        }
        if (existing.has(name)) {
            errors.push(`Row ${lineNo}: '${name}' already exists`);
            return;
        }

        seen.add(name);
        entries.push({
            name: name,
            display: display || name,
        });
    });

    return { entries, errors };
}

function _buildCloneEntryRow(engineName, displayName) {
    const row = document.createElement('div');
    row.className = 'adv-clone-entry-row';

    const engineInput = document.createElement('input');
    engineInput.type = 'text';
    engineInput.className = 'entry-engine';
    engineInput.value = engineName;
    engineInput.readOnly = true;
    engineInput.tabIndex = -1;

    const displayInput = document.createElement('input');
    displayInput.type = 'text';
    displayInput.className = 'entry-display';
    displayInput.value = displayName;
    displayInput.placeholder = engineName;
    displayInput.oninput = updateAdvCloneCount;

    const removeBtn = document.createElement('button');
    removeBtn.className = 'adv-clone-entry-remove';
    removeBtn.title = 'Remove';
    removeBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
    removeBtn.onclick = function() {
        row.remove();
        updateAdvCloneCount();
    };

    row.appendChild(engineInput);
    row.appendChild(displayInput);
    row.appendChild(removeBtn);
    return row;
}

function generateAdvCloneNames() {
    const prefixEl = document.getElementById('advClonePrefix');
    const countEl = document.getElementById('advCloneCount');
    const container = document.getElementById('advCloneEntries');
    if (!container) return;

    let prefix = (prefixEl ? prefixEl.value : '').trim();
    if (!prefix) {
        prefix = getAdvClonePrefixFromSource();
        if (prefixEl) prefixEl.value = prefix;
    }
    prefix = prefix.replace(/[^A-Za-z0-9._-]+/g, '_').replace(/^_+|_+$/g, '') || 'Clone';
    if (prefixEl) prefixEl.value = prefix;

    let count = parseInt(countEl ? countEl.value : '0', 10);
    if (!Number.isFinite(count) || count < 1) count = 1;
    if (count > 100) count = 100;
    if (countEl) countEl.value = String(count);

    const existing = new Set(((_cloneAnalysis && _cloneAnalysis.all_dirs) || []).map(f => f.name || f));
    const pat = new RegExp('^' + escapeRegExp(prefix) + '_(\\d+)$');
    let nextNum = 1;
    existing.forEach(name => {
        const m = name.match(pat);
        if (m) nextNum = Math.max(nextNum, parseInt(m[1], 10) + 1);
    });

    // Clear existing rows
    container.innerHTML = '';

    let generated = 0;
    let guard = 0;
    while (generated < count && guard < count + 5000) {
        const engineName = `${prefix}_${nextNum}`;
        if (!existing.has(engineName)) {
            const displayName = `${prefix} ${nextNum}`;
            container.appendChild(_buildCloneEntryRow(engineName, displayName));
            existing.add(engineName);
            generated++;
        }
        nextNum++;
        guard++;
    }

    updateAdvCloneCount();
}

function updateAdvCloneCount() {
    const sub = document.getElementById('advCloneSubtitle');
    const btn = document.getElementById('btnAdvClone');
    if (!sub || !btn) return;

    if (STATE.advCloneMode === 'replace') {
        const selected = document.querySelectorAll('.adv-clone-cb:checked:not(:disabled)').length;
        btn.disabled = selected === 0;
        if (selected === 0) {
            sub.textContent = 'No targets selected.';
        } else {
            sub.textContent = selected + ' existing instance' + (selected !== 1 ? 's' : '') + ' will be overwritten.';
        }
    } else {
        const parsed = parseAdvCloneNewEntries();
        const valid = parsed.entries.length;
        const issues = parsed.errors.length;
        btn.disabled = valid === 0 || issues > 0;
        if (valid === 0 && issues === 0) {
            sub.textContent = 'No new instances configured.';
        } else if (issues > 0) {
            sub.textContent = valid + ' valid, ' + issues + ' issue' + (issues !== 1 ? 's' : '') + ' to fix.';
        } else {
            sub.textContent = valid + ' new instance' + (valid !== 1 ? 's' : '') + ' will be created.';
        }
    }
}

function updateAdvCloneSelection() {
    // When source changes, rebuild the target list (greys out the new source)
    const sourceVal = document.getElementById('advCloneSource').value;
    let sourceName = sourceVal;
    if (sourceVal.startsWith('IMAGE:')) {
        sourceName = null; // Source images aren't in the engine list — nothing to grey out
    }
    buildAdvCloneTargets(sourceName);
    const prefix = document.getElementById('advClonePrefix');
    if (prefix) prefix.value = getAdvClonePrefixFromSource();
    if (STATE.advCloneMode === 'new') {
        generateAdvCloneNames();
    } else {
        updateAdvCloneCount();
    }
}

function closeAdvCloneModal() {
    document.getElementById('advCloneModal').style.display = 'none';
}

async function startAdvClone() {
    const sourceVal = document.getElementById('advCloneSource').value;
    let source;
    let sourceLabel;
    let sourceImagePath = null;

    if (sourceVal.startsWith('IMAGE:')) {
        sourceImagePath = sourceVal.substring(6);
        sourceLabel = sourceImagePath.split(/[\/\\]/).pop();
        source = (_cloneAnalysis && _cloneAnalysis.source) ? _cloneAnalysis.source : sourceLabel;
    } else {
        source = sourceVal;
        sourceLabel = sourceVal;
    }

    let targets = [];
    let fixMode = true;
    const cloneDisplayNames = {};

    if (STATE.advCloneMode === 'replace') {
        targets = Array.from(document.querySelectorAll('.adv-clone-cb:checked:not(:disabled)')).map(cb => cb.value);
        if (targets.length === 0) {
            showToast('Select at least one target instance', 'error', 3000);
            return;
        }
        fixMode = true;
    } else {
        const parsed = parseAdvCloneNewEntries();
        if (parsed.errors.length > 0) {
            showToast(parsed.errors[0], 'error', 4500);
            updateAdvCloneCount();
            return;
        }
        if (parsed.entries.length === 0) {
            showToast('Enter at least one new instance name', 'error', 3000);
            return;
        }
        parsed.entries.forEach(e => {
            targets.push(e.name);
            cloneDisplayNames[e.name] = e.display;
        });
        fixMode = false;
    }

    if (!fixMode && sourceImagePath && !((_cloneAnalysis && _cloneAnalysis.source) || '')) {
        showToast('No engine source instance found for config template. Create one instance first.', 'error', 4500);
        return;
    }

    // Enforce Tiramisu64_N naming — BS MIM parses prefix to determine image traits.
    // Any non-Tiramisu64 prefix causes UtlAndroidImageTraits::get() assertion → SIGTRAP.
    if (!fixMode) {
        const badNames = targets.filter(t => !t.match(/^Tiramisu64(_\d+)?$/));
        if (badNames.length > 0) {
            showToast('Instance names must use Tiramisu64_N format (e.g. Tiramisu64_1). Got: ' + badNames[0], 'error', 5000);
            return;
        }
    }

    closeAdvCloneModal();
    setRunning(true);
    if (fixMode) {
        appendLog('Replacing from ' + sourceLabel + ' → ' + targets.join(', '));
        showToast('Replacing ' + targets.length + ' instance' + (targets.length !== 1 ? 's' : '') + '...', 'info');
    } else {
        appendLog('Creating from ' + sourceLabel + ' → ' + targets.join(', '));
        showToast('Creating ' + targets.length + ' new instance' + (targets.length !== 1 ? 's' : '') + '...', 'info');
    }

    try {
        const result = await pywebview.api.do_clone(
            source, targets, STATE.engineDir, STATE.bsDir, fixMode, false,
            false, sourceImagePath, cloneDisplayNames
        );
        if (result && result.error) {
            appendLog('[Error] ' + result.error);
            setRunning(false);
            showToast(fixMode ? 'Replace failed' : 'Create failed', 'error');
        }
    } catch (e) {
        appendLog('[Error] ' + e);
        setRunning(false);
        showToast(fixMode ? 'Replace error' : 'Create error', 'error');
    }
}

// ─── Hero context (interactive, follows user progress) ───────────────────────
function updateHeroContext() {
    const heading = document.getElementById('heroHeading');
    const sub = document.getElementById('heroSub');
    if (!heading || !sub) return;
    const tab = STATE.activeTab;

    if (tab === 'download') {
        heading.textContent = 'Download & Clone';
        if (STATE.running) {
            sub.textContent = 'Download in progress...';
        } else {
            sub.textContent = 'Get a fresh instance and clone it';
        }
    } else if (tab === 'clone') {
        heading.textContent = 'Clone Instance';
        if (STATE.running) {
            sub.textContent = 'Cloning in progress...';
        } else if (!STATE.engineDir) {
            sub.textContent = 'Set engine directory to begin';
        } else {
            sub.textContent = 'Duplicate with unique identifiers';
        }
    } else if (tab === 'advanced') {
        heading.textContent = 'Cloning';
        sub.textContent = 'Download, clone, and get help';
    } else if (tab === 'vpn') {
        heading.textContent = 'VPN Manager';
        const connected = Object.values(STATE.vpnStatuses).filter(s => s.state === 'connected').length;
        const total = Object.keys(STATE.vpnAssignments).length;
        if (connected > 0) {
            sub.textContent = connected + ' connected' + (total > connected ? ', ' + (total - connected) + ' pending' : '');
        } else if (total > 0) {
            sub.textContent = total + ' proxies assigned';
        } else {
            sub.textContent = 'Configure proxies for your instances';
        }
    } else {
        if (STATE.running) {
            heading.textContent = 'Randomizing...';
            sub.textContent = 'Assigning new device identities';
        } else if (STATE.randInstances.length > 0 && STATE.selectedRand.size > 0) {
            heading.textContent = 'Randomize Instances';
            sub.textContent = STATE.selectedRand.size + ' selected';
        } else if (STATE.randInstances.length > 0) {
            heading.textContent = 'Randomize Instances';
            sub.textContent = 'Select instances to spoof';
        } else if (STATE.engineDir) {
            heading.textContent = 'Randomize Instances';
            sub.textContent = 'Refresh to scan for instances';
        } else {
            heading.textContent = 'Set up your instances';
            sub.textContent = 'Configure BlueStacks engine paths';
        }
    }
}

// ─── Hero stat chips ─────────────────────────────────────────────────────────
function updateHeroStats() {
    const total = STATE.randInstances.length || STATE.instances.length || 0;
    const running = STATE.randInstances.filter(i => i.running).length;
    const chipInst = document.getElementById('chipInstances');
    const chipRun = document.getElementById('chipRunning');
    if (chipInst) chipInst.textContent = total;
    if (chipRun) chipRun.textContent = running;
    // Also refresh hero context
    updateHeroContext();
}

// ═══════════════════════════════════════════════════════════════════════════════
//  VPN TAB — Two-column: Instances | Proxies  (click-to-link)
// ═══════════════════════════════════════════════════════════════════════════════

let _vpnNextId = 1;
let _vpnSelectedInstances = new Set();   // instance names

// Helper: get instances from whichever source has them
function _vpnGetInstances() {
    if (STATE.randInstances && STATE.randInstances.length) return STATE.randInstances;
    if (STATE.instances && STATE.instances.length) return STATE.instances;
    return [];
}
let _vpnSelectedProxy = null;            // proxy id

window.onVpnStatus = function(instanceName, statusObj) {
    STATE.vpnStatuses[instanceName] = statusObj;
    if (STATE.activeTab === 'vpn') vpnRender();
    updateHeroContext();
};

// ── Master render ──
function vpnRender() {
    vpnRenderAuth();
    vpnRenderInstances();
    vpnRenderProxies();
    vpnUpdateLinkBtn();
}

// ── Show / hide the Link button ──
function vpnUpdateLinkBtn() {
    const btn = document.getElementById('vLinkBtn');
    if (!btn) return;
    if (_vpnSelectedInstances.size > 0 && _vpnSelectedProxy) {
        btn.classList.add('show');
    } else {
        btn.classList.remove('show');
    }
}

// ── Top bar auth ──
function vpnRenderAuth() {
    const signIn = document.getElementById('vAuthSignIn');
    const refresh = document.getElementById('vAuthRefresh');
    const logout = document.getElementById('vAuthLogout');
    const emailInput = document.getElementById('vpnSubUser');
    const passInput = document.getElementById('vpnSubPass');
    const stat = document.getElementById('vAuthStat');

    if (STATE.suborbitalLoggedIn) {
        if (signIn) signIn.style.display = 'none';
        if (emailInput) emailInput.style.display = 'none';
        if (passInput) passInput.style.display = 'none';
        if (refresh) refresh.style.display = '';
        if (logout) logout.style.display = '';
        const b = STATE.suborbitalBalance;
        const parts = [escapeHtml(STATE.suborbitalUser)];
        parts.push('<b>' + STATE.suborbitalProxies.length + '</b> IPs');
        if (b !== null && b !== undefined) parts.push('$' + parseFloat(b).toFixed(1));
        if (stat) stat.innerHTML = parts.join(' · ');
    } else {
        if (signIn) signIn.style.display = '';
        if (emailInput) emailInput.style.display = '';
        if (passInput) passInput.style.display = '';
        if (refresh) refresh.style.display = 'none';
        if (logout) logout.style.display = 'none';
        if (stat) stat.innerHTML = '';
        if (emailInput && STATE.suborbitalUser && !emailInput.value) emailInput.value = STATE.suborbitalUser;
    }
}

// ── Left column: Instances (clickable, multi-select, 2-column grid) ──
function vpnRenderInstances() {
    const el = document.getElementById('vInstList');
    if (!el) return;
    const instances = _vpnGetInstances();

    if (!instances.length) {
        el.innerHTML = '<div class="v-empty">No instances detected</div>';
        return;
    }

    let cards = '';
    for (let i = 0; i < instances.length; i++) {
        const inst = instances[i];
        const status = STATE.vpnStatuses[inst.name] || { state: 'unknown' };
        const st = status.state || 'unknown';
        const dotCls = st === 'connected' ? 'on' : st === 'reconnecting' ? 'warn' : st === 'stopped' ? 'err' : 'off';
        const sel = _vpnSelectedInstances.has(inst.name) ? ' selected' : '';
        const offlineCls = !inst.running ? ' offline' : '';

        // Status label
        let statusLabel = 'Offline';
        if (st === 'connected') statusLabel = 'VPN On';
        else if (st === 'reconnecting') statusLabel = 'Reconnecting';
        else if (inst.running) statusLabel = 'Running';

        // Show assigned proxy label
        const assignedId = STATE.vpnAssignments[inst.name];
        const assignedProxy = assignedId ? STATE.vpnProxyPool.find(p => p.id === assignedId) : null;
        const proxyMeta = assignedProxy ? ' · ' + escapeHtml(assignedProxy.label || assignedProxy.server) : '';

        // Disconnect button for connected instances
        const showDisc = (st === 'connected' || st === 'reconnecting') && inst.running;
        const discBtn = showDisc
            ? `<button class="v-inst-card-disc" onclick="event.stopPropagation();vpnDisconnect('${escapeHtml(inst.name)}',${inst.port})" title="Disconnect VPN">✕</button>`
            : '';

        cards += `<div class="v-inst-card${sel}${offlineCls}" onclick="vpnToggleInstance('${escapeHtml(inst.name)}')" style="animation-delay:${i * 25}ms">
            <div class="v-inst-card-dot ${dotCls}"></div>
            <div class="v-inst-card-info">
                <div class="v-inst-card-name">${escapeHtml(inst.display || inst.name)}</div>
                <div class="v-inst-card-meta">:${inst.port || '?'} · ${statusLabel}${proxyMeta}</div>
            </div>
            <div class="v-inst-card-check"></div>
            ${discBtn}
        </div>`;
    }
    el.innerHTML = '<div class="v-inst-grid">' + cards + '</div>';

    // Show/hide "Disconnect All" button
    const discAllBtn = document.getElementById('vDiscAllBtn');
    if (discAllBtn) {
        const hasConnected = instances.some(i => {
            const s = (STATE.vpnStatuses[i.name] || {}).state;
            return s === 'connected' || s === 'reconnecting';
        });
        discAllBtn.style.display = hasConnected ? '' : 'none';
    }
}

// ── Right column: Proxies (single-select, card layout with toggles) ──
function vpnRenderProxies() {
    const el = document.getElementById('vProxyList');
    const pool = STATE.vpnProxyPool;
    const subs = STATE.suborbitalProxies || [];

    // Build reverse map: proxyId -> list of assigned instance names
    const assignedMap = {};
    for (const [instName, proxyId] of Object.entries(STATE.vpnAssignments)) {
        if (!assignedMap[proxyId]) assignedMap[proxyId] = [];
        assignedMap[proxyId].push(instName);
    }

    let html = '';

    // Pool entries (card layout with sub-section)
    for (const p of pool) {
        const flag = countryFlag((p.countryCode || '').toUpperCase());
        const ipTrunc = (p.server.length > 12 ? p.server.substring(0, 12) + '…' : p.server);
        const sel = _vpnSelectedProxy === p.id ? ' selected' : '';

        // Assigned instance tags
        const assigned = assignedMap[p.id] || [];
        let tagsHtml = '';
        if (assigned.length) {
            tagsHtml = '<div class="v-proxy-tags">';
            for (const instName of assigned) {
                const inst = _vpnGetInstances().find(i => i.name === instName);
                const display = inst ? (inst.display || inst.name) : instName;
                tagsHtml += `<span class="v-proxy-tag">${escapeHtml(display)}</span>`;
            }
            tagsHtml += '</div>';
        }

        // Toggle states
        const alwaysOnCls = p.alwaysOn ? ' active' : '';
        const killSwitchCls = p.killSwitch ? ' active' : '';

        html += `<div class="v-proxy-card${sel}" onclick="vpnSelectProxy('${p.id}')">
            <div class="v-proxy-main">
                <span class="v-dot on"></span>
                <span class="v-proxy-ip">${flag ? flag + ' ' : ''}${escapeHtml(ipTrunc)}:${p.port}</span>
                <span class="v-proxy-loc">${escapeHtml(p.label || '')}</span>
                <button class="v-proxy-edit" onclick="event.stopPropagation();vpnOpenEditModal('${p.id}')" title="Edit">✎</button>
                <button class="v-proxy-x" onclick="event.stopPropagation();vpnRemoveProxy('${p.id}')" title="Remove">×</button>
            </div>
            <div class="v-proxy-sub">
                ${tagsHtml}
                <div class="v-proxy-toggles">
                    <div class="v-toggle-wrap">
                        <span class="v-toggle-label">Always On</span>
                        <div class="v-toggle${alwaysOnCls}" onclick="event.stopPropagation();vpnToggleAlwaysOn('${p.id}')"></div>
                    </div>
                    <div class="v-toggle-wrap">
                        <span class="v-toggle-label">Kill Switch</span>
                        <div class="v-toggle${killSwitchCls}" onclick="event.stopPropagation();vpnToggleKillSwitch('${p.id}')"></div>
                    </div>
                </div>
            </div>
        </div>`;
    }

    // Suborbital entries (not yet imported)
    for (let i = 0; i < subs.length; i++) {
        const p = subs[i];
        const rawIp = p.ip || p.host || '';
        const subServer = rawIp && !rawIp.includes('.suborbit.al') ? rawIp + '.suborbit.al' : rawIp;
        const subPort = parseInt(p.port) || 0;
        const alreadyImported = pool.some(
            pp => pp.server === subServer && parseInt(pp.port) === subPort
        );
        if (alreadyImported) continue;

        const country = (p.country || '').toUpperCase();
        const flag = countryFlag(country);
        const ip = (p.ip || p.host || '');
        const ipTrunc = ip.length > 12 ? ip.substring(0, 12) + '…' : ip;
        const locParts = [];
        if (p.city) locParts.push(p.city);
        if (p.country_name || country) locParts.push(p.country_name || country);
        const loc = locParts.join(', ') || country;

        html += `<div class="v-row" style="cursor:pointer;opacity:0.5" onclick="vpnImportSuborbital(${i})">
            <span class="v-dot off"></span>
            <span class="v-proxy-ip">${flag ? flag + ' ' : ''}${escapeHtml(ipTrunc)}:${p.port || ''}</span>
            <span class="v-proxy-loc">${escapeHtml(loc)}</span>
            <button class="v-btn" onclick="event.stopPropagation();vpnImportSuborbital(${i})" style="font-size:9px;padding:3px 8px">Import</button>
        </div>`;
    }

    if (!html) {
        html = '<div class="v-empty">Sign in or add proxies</div>';
    }
    el.innerHTML = html;
}

// ── Selection handlers ──
function vpnToggleInstance(name) {
    if (_vpnSelectedInstances.has(name)) {
        _vpnSelectedInstances.delete(name);
    } else {
        _vpnSelectedInstances.add(name);
    }
    vpnRenderInstances();
    vpnUpdateLinkBtn();
}

function vpnSelectProxy(proxyId) {
    _vpnSelectedProxy = (_vpnSelectedProxy === proxyId) ? null : proxyId;
    vpnRenderProxies();
    vpnUpdateLinkBtn();
}

// ── Link modal ──
function vpnShowLinkModal() {
    if (!_vpnSelectedInstances.size || !_vpnSelectedProxy) return;

    const proxy = STATE.vpnProxyPool.find(p => p.id === _vpnSelectedProxy);
    if (!proxy) return;

    // Build proxy display: IP | location
    const proxyParts = [proxy.server + ':' + proxy.port];
    if (proxy.label) proxyParts.push(proxy.label);
    document.getElementById('vLinkModalProxy').textContent = proxyParts.join('  |  ');

    // Build instance list
    const listEl = document.getElementById('vLinkModalList');
    const instances = _vpnGetInstances();
    let listHtml = '';
    for (const name of _vpnSelectedInstances) {
        const inst = instances.find(i => i.name === name);
        const display = inst ? (inst.display || inst.name) : name;
        listHtml += `<li>${escapeHtml(display)}</li>`;
    }
    listEl.innerHTML = listHtml;

    // Title
    document.getElementById('vLinkModalTitle').textContent = 'The proxy:';

    document.getElementById('vLinkModal').classList.add('open');
}

function vpnCloseLinkModal() {
    document.getElementById('vLinkModal').classList.remove('open');
}

async function vpnConfirmLink() {
    vpnCloseLinkModal();

    const proxy = STATE.vpnProxyPool.find(p => p.id === _vpnSelectedProxy);
    if (!proxy) return;

    const instances = _vpnGetInstances();

    // Assign proxy to all selected instances
    for (const name of _vpnSelectedInstances) {
        STATE.vpnAssignments[name] = _vpnSelectedProxy;
    }
    vpnSaveState();

    // Apply to instances — try to connect even if inst.running is stale
    // First, refresh instances if needed so we have current running state
    if (STATE.engineDir) {
        try {
            const result = await pywebview.api.refresh_instances(STATE.engineDir, STATE.bsDir);
            if (result && !result.error && result.instances) {
                STATE.randInstances = result.instances;
            }
        } catch (_) {}
    }
    const freshInstances = _vpnGetInstances();

    const toApply = [];
    for (const name of _vpnSelectedInstances) {
        const inst = freshInstances.find(i => i.name === name);
        if (inst && inst.port) {
            toApply.push({
                instance_name: name, adb_port: String(inst.port),
                server: proxy.server, port: String(proxy.port),
                username: proxy.username || '', password: proxy.password || ''
            });
        }
    }

    if (toApply.length) {
        showToast(`Connecting ${toApply.length} instance(s)...`, 'info');
        try {
            const bulkResult = await pywebview.api.vpn_apply_bulk(toApply);

            // Handle top-level error (e.g. VPN manager init failure)
            if (bulkResult && bulkResult.error && !Object.keys(bulkResult).some(k => k !== 'error')) {
                showToast('VPN bulk apply failed: ' + bulkResult.error, 'error');
                appendLog('[VPN] Bulk apply error: ' + bulkResult.error);
                setRunning(false);
                return;
            }

            // Check which instances actually connected
            const failed = [];
            const succeeded = [];
            for (const entry of toApply) {
                const r = (bulkResult || {})[entry.instance_name];
                if (r && r.ok) {
                    succeeded.push(entry);
                } else {
                    failed.push(entry.instance_name + ': ' + ((r && r.error) || 'unknown error'));
                }
            }

            if (succeeded.length) {
                showToast(`VPN connected (${succeeded.length}/${toApply.length})`, 'success');
                // Propagate always-on / kill-switch only for successful connections
                for (const entry of succeeded) {
                    if (proxy.alwaysOn) {
                        pywebview.api.vpn_set_always_on(
                            entry.instance_name, true,
                            proxy.server, String(proxy.port),
                            proxy.username || '', proxy.password || ''
                        ).catch(() => {});
                    }
                    if (proxy.killSwitch) {
                        pywebview.api.vpn_set_kill_switch(
                            entry.instance_name, entry.adb_port, true
                        ).catch(() => {});
                    }
                }
            }
            if (failed.length) {
                showToast('Failed: ' + failed.join('; '), 'error');
            }
        } catch (e) { showToast('Error: ' + e, 'error'); }
    } else {
        showToast('Proxy assigned — instance not detected. Try refreshing.', 'error');
    }

    // Clear selections
    _vpnSelectedInstances.clear();
    _vpnSelectedProxy = null;
    vpnRender();
}

function countryFlag(code) {
    if (!code || code.length !== 2) return '';
    const offset = 0x1F1E6;
    return String.fromCodePoint(code.charCodeAt(0) - 65 + offset, code.charCodeAt(1) - 65 + offset);
}

// ── Add/Edit Proxy (modal-based) ──
function vpnAddProxy() {
    document.getElementById('vBulkForm').classList.remove('open');
    vpnOpenEditModal(null);
}

function vpnEditProxy(proxyId) {
    document.getElementById('vBulkForm').classList.remove('open');
    vpnOpenEditModal(proxyId);
}

function vpnOpenEditModal(proxyId) {
    const isNew = !proxyId;
    const proxy = proxyId ? STATE.vpnProxyPool.find(p => p.id === proxyId) : null;

    document.getElementById('vEditModalTitle').textContent = isNew ? 'Add Proxy' : 'Edit Proxy';
    document.getElementById('vEditLabel').value = proxy ? proxy.label || '' : '';
    document.getElementById('vEditServer').value = proxy ? proxy.server || '' : '';
    document.getElementById('vEditPort').value = proxy ? proxy.port || 1337 : 1337;
    document.getElementById('vEditUser').value = proxy ? proxy.username || '' : '';
    document.getElementById('vEditPass').value = proxy ? proxy.password || '' : '';
    document.getElementById('vEditId').value = proxyId || '';
    document.getElementById('vEditModal').classList.add('open');
    document.getElementById('vEditServer').focus();
}

function vpnCloseEditModal() {
    document.getElementById('vEditModal').classList.remove('open');
}

function vpnSaveFromModal() {
    const label = document.getElementById('vEditLabel').value.trim();
    const server = document.getElementById('vEditServer').value.trim();
    const port = parseInt(document.getElementById('vEditPort').value) || 1337;
    const username = document.getElementById('vEditUser').value.trim();
    const password = document.getElementById('vEditPass').value.trim();
    const editId = document.getElementById('vEditId').value;
    if (!server) { showToast('Host required', 'error'); return; }

    if (editId) {
        const proxy = STATE.vpnProxyPool.find(p => p.id === editId);
        if (proxy) { proxy.label = label || 'Proxy'; proxy.server = server; proxy.port = port; proxy.username = username; proxy.password = password; }
    } else {
        const id = 'p' + (_vpnNextId++);
        STATE.vpnProxyPool.push({ id, label: label || 'Proxy ' + id, server, port, username, password });
    }
    vpnCloseEditModal();
    vpnSaveState();
    vpnRender();
}

// Keep legacy functions as no-ops for safety
function vpnCancelForm() {}
function vpnSaveProxy() { vpnSaveFromModal(); }

// ── Toggle functions ──
async function vpnToggleAlwaysOn(proxyId) {
    const proxy = STATE.vpnProxyPool.find(p => p.id === proxyId);
    if (!proxy) return;
    proxy.alwaysOn = !proxy.alwaysOn;
    vpnSaveState();
    vpnRenderProxies();

    // Notify backend for every running instance assigned to this proxy
    const instances = _vpnGetInstances();
    for (const [instName, pid] of Object.entries(STATE.vpnAssignments)) {
        if (pid !== proxyId) continue;
        const inst = instances.find(i => i.name === instName);
        if (!inst || !inst.running) continue;
        try {
            await pywebview.api.vpn_set_always_on(
                instName, proxy.alwaysOn,
                proxy.server || '', String(proxy.port || 1337),
                proxy.username || '', proxy.password || ''
            );
        } catch (e) { console.warn('[vpn] always-on backend error:', e); }
    }
    if (proxy.alwaysOn) {
        showToast('Always On enabled — VPN will auto-reconnect if it drops', 'info');
    } else {
        showToast('Always On disabled', 'info');
    }
}

async function vpnToggleKillSwitch(proxyId) {
    const proxy = STATE.vpnProxyPool.find(p => p.id === proxyId);
    if (!proxy) return;
    proxy.killSwitch = !proxy.killSwitch;
    vpnSaveState();
    vpnRenderProxies();

    // Notify backend for every running instance assigned to this proxy
    const instances = _vpnGetInstances();
    for (const [instName, pid] of Object.entries(STATE.vpnAssignments)) {
        if (pid !== proxyId) continue;
        const inst = instances.find(i => i.name === instName);
        if (!inst || !inst.running) continue;
        try {
            await pywebview.api.vpn_set_kill_switch(instName, String(inst.port), proxy.killSwitch);
        } catch (e) { console.warn('[vpn] kill-switch backend error:', e); }
    }
    if (proxy.killSwitch) {
        showToast('Kill Switch ON \u2014 All traffic blocked if VPN disconnects', 'info');
    } else {
        showToast('Kill Switch OFF', 'info');
    }
}

// ── Bulk Add ──
function vpnBulkAdd() {
    vpnCloseEditModal();
    document.getElementById('vpnBulkText').value = '';
    document.getElementById('vBulkForm').classList.add('open');
    document.getElementById('vpnBulkText').focus();
}

function vpnCancelBulk() { document.getElementById('vBulkForm').classList.remove('open'); }

function vpnParseBulk() {
    const text = document.getElementById('vpnBulkText').value.trim();
    if (!text) { showToast('Paste proxies to import', 'error'); return; }

    const lines = text.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('#'));
    let count = 0;
    for (const line of lines) {
        const parts = line.split(':');
        if (parts.length < 4) { continue; } // need at least host:port:user:pass
        const host = parts[0].trim();
        const port = parseInt(parts[1].trim()) || 1337;
        const username = parts[2].trim();
        const password = parts[3].trim();
        const label = parts.length >= 5 ? parts[4].trim() : '';
        if (!host) continue;

        const id = 'p' + (_vpnNextId++);
        STATE.vpnProxyPool.push({ id, label: label || `Proxy ${id}`, server: host, port, username, password });
        count++;
    }

    document.getElementById('vBulkForm').classList.remove('open');
    if (count > 0) {
        vpnSaveState();
        vpnRender();
        showToast(`Imported ${count} prox${count === 1 ? 'y' : 'ies'}`, 'success');
    } else {
        showToast('No valid proxies found. Format: host:port:username:password', 'error');
    }
}

function vpnRemoveProxy(proxyId) {
    STATE.vpnProxyPool = STATE.vpnProxyPool.filter(p => p.id !== proxyId);
    for (const [name, pid] of Object.entries(STATE.vpnAssignments)) {
        if (pid === proxyId) delete STATE.vpnAssignments[name];
    }
    vpnSaveState();
    vpnRender();
}

// ── Disconnect ──
async function vpnDisconnect(instName, port) {
    try {
        await pywebview.api.vpn_disconnect(instName, String(port));
        STATE.vpnStatuses[instName] = { state: 'stopped' };
        vpnSaveState();
        vpnRender();
        showToast('Disconnected', 'info');
    } catch (e) { showToast('Error: ' + e, 'error'); }
}

async function vpnApplyAll() {
    // Refresh instances first to get current running state
    if (STATE.engineDir) {
        try {
            const result = await pywebview.api.refresh_instances(STATE.engineDir, STATE.bsDir);
            if (result && !result.error && result.instances) STATE.randInstances = result.instances;
        } catch (_) {}
    }
    const instances = _vpnGetInstances().filter(i => i.port);
    const toApply = [];
    for (const inst of instances) {
        const pid = STATE.vpnAssignments[inst.name]; if (!pid) continue;
        const proxy = STATE.vpnProxyPool.find(p => p.id === pid); if (!proxy) continue;
        toApply.push({ instance_name: inst.name, adb_port: String(inst.port), server: proxy.server, port: String(proxy.port), username: proxy.username || '', password: proxy.password || '' });
    }
    if (!toApply.length) { showToast('No assignments', 'info'); return; }
    showToast(`Applying to ${toApply.length}...`, 'info');
    try {
        await pywebview.api.vpn_apply_bulk(toApply);
        // Propagate always-on / kill-switch for connected instances
        for (const inst of instances) {
            const pid = STATE.vpnAssignments[inst.name]; if (!pid) continue;
            const proxy = STATE.vpnProxyPool.find(p => p.id === pid); if (!proxy) continue;
            if (proxy.alwaysOn) {
                pywebview.api.vpn_set_always_on(inst.name, true, proxy.server, String(proxy.port), proxy.username || '', proxy.password || '').catch(() => {});
            }
            if (proxy.killSwitch) {
                pywebview.api.vpn_set_kill_switch(inst.name, String(inst.port), true).catch(() => {});
            }
        }
        showToast('Done', 'success');
    } catch (e) { showToast('Error: ' + e, 'error'); }
}

async function vpnDisconnectAll() {
    const running = _vpnGetInstances().filter(i => i.running);
    if (!running.length) return;
    try {
        await pywebview.api.vpn_disconnect_all(running.map(i => ({ name: i.name, port: String(i.port) })));
        for (const inst of running) { STATE.vpnStatuses[inst.name] = { state: 'stopped' }; }
        vpnSaveState(); vpnRender(); showToast('All disconnected', 'info');
    } catch (e) { showToast('Error: ' + e, 'error'); }
}

// ── Polling ──
function vpnStartPolling() {
    if (STATE.vpnPolling) return;
    const running = _vpnGetInstances().filter(i => i.running);
    if (!running.length) return;
    STATE.vpnPolling = true;
    pywebview.api.vpn_start_polling(running.map(i => ({ name: i.name, port: String(i.port) }))).catch(() => {});
}
function vpnStopPolling() {
    if (!STATE.vpnPolling) return;
    // Never stop polling if always-on is active — it needs the poller
    // to detect VPN drops and auto-reconnect after instance reboots.
    if (STATE.vpnProxyPool.some(p => p.alwaysOn)) return;
    STATE.vpnPolling = false;
    pywebview.api.vpn_stop_polling().catch(() => {});
}

// ── Suborbital ──
async function vpnSuborbitalLogin() {
    const user = document.getElementById('vpnSubUser').value.trim();
    const pass = document.getElementById('vpnSubPass').value.trim();
    if (!user || !pass) { showToast('Enter email and password', 'error'); return; }
    showToast('Signing in...', 'info');
    try {
        const result = await pywebview.api.vpn_suborbital_login(user, pass);
        if (result.error) { showToast('Failed: ' + result.error, 'error'); return; }
        STATE.suborbitalUser = user;
        STATE.suborbitalLoggedIn = true;
        STATE.suborbitalProxies = result.proxies || [];
        STATE.suborbitalBalance = result.balance;
        document.getElementById('vpnSubPass').value = '';
        vpnRender();
        showToast(`Signed in — ${STATE.suborbitalProxies.length} IPs`, 'success');
    } catch (e) { showToast('Error: ' + e, 'error'); }
}

async function vpnSuborbitalLogout() {
    try { await pywebview.api.vpn_suborbital_logout(); } catch (e) {}
    STATE.suborbitalUser = ''; STATE.suborbitalLoggedIn = false;
    STATE.suborbitalProxies = []; STATE.suborbitalBalance = null;
    vpnRender(); showToast('Signed out', 'info');
}

async function vpnFetchSuborbital() {
    if (!STATE.suborbitalLoggedIn) { showToast('Sign in first', 'error'); return; }
    showToast('Refreshing...', 'info');
    try {
        const result = await pywebview.api.vpn_fetch_proxies();
        if (result.error) { showToast(result.error, 'error'); return; }
        STATE.suborbitalProxies = result.proxies || [];
        vpnRender();
        showToast(`${STATE.suborbitalProxies.length} proxies`, 'success');
    } catch (e) { showToast('Error: ' + e, 'error'); }
}

function vpnImportSuborbital(index) {
    const p = STATE.suborbitalProxies[index]; if (!p) return;
    const rawIp = p.ip || p.host || '';
    // Suborbital SOCKS5 servers use {ip}.suborbit.al as the hostname
    const server = rawIp && !rawIp.includes('.suborbit.al') ? rawIp + '.suborbit.al' : rawIp;
    const port = parseInt(p.port) || 1337;
    // Skip if already in pool
    if (STATE.vpnProxyPool.some(pp => pp.server === server && parseInt(pp.port) === port)) {
        // Remove the greyed-out entry since it's already imported
        STATE.suborbitalProxies.splice(index, 1);
        vpnRender();
        return;
    }
    const country = (p.country || '').toUpperCase();
    const locParts = [];
    if (p.city) locParts.push(p.city);
    if (p.state || p.region || p.province) locParts.push(p.state || p.region || p.province);
    if (p.country_name || country) locParts.push(p.country_name || country);
    const label = locParts.join(', ') || `${countryFlag(country)} ${country}`;
    const id = 'p' + (_vpnNextId++);
    // SOCKS5 auth: username is "user-ip" format, password is account password (injected by backend)
    const socksUser = p.username_formatted || p.username || '';
    const socksPass = p.password || '';
    STATE.vpnProxyPool.push({ id, label, server, port, username: socksUser, password: socksPass, countryCode: country });
    // Remove from Suborbital list so it doesn't show greyed out
    STATE.suborbitalProxies.splice(index, 1);
    vpnSaveState(); vpnRender();
    showToast(`Imported: ${label}`, 'success');
}

async function vpnSaveState() {
    try {
        await pywebview.api.vpn_save_state(STATE.vpnProxyPool, STATE.vpnAssignments);
    } catch (e) {
        console.error('[vpn] Save state failed:', e);
        appendLog('[VPN] Warning: Failed to save VPN state');
    }
}

function vpnInitIds() {
    let maxId = 0;
    for (const p of STATE.vpnProxyPool) {
        if (p.id && p.id.startsWith('p')) { const n = parseInt(p.id.substring(1)); if (n > maxId) maxId = n; }
    }
    _vpnNextId = maxId + 1;
}


// ─── Footer clock ────────────────────────────────────────────────────────────
function startFooterClock() {
    const el = document.getElementById('footerClock');
    if (!el) return;
    function tick() {
        const now = new Date();
        const h = String(now.getHours()).padStart(2, '0');
        const m = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        el.textContent = h + ':' + m + ':' + s;
    }
    tick();
    setInterval(tick, 1000);
}

// ═══════════════════════════════════════════════════════════════════════════════
//  SETUP WIZARD
// ═══════════════════════════════════════════════════════════════════════════════

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function truncPath(p) { return p.length > 38 ? '...' + p.slice(-35) : p; }

async function initSetupWizard(forceWizard) {
    // Re-fetch state from Python (handles reset + fresh launch)
    try {
        const state = await pywebview.api.get_initial_state();
        STATE.engineDir = state.engine_dir || '';
        STATE.bsDir = state.bs_dir || '';
        STATE.instances = state.instances || [];
        STATE.pyVersion = state.python_version || '3.x';
        STATE.imagesDir = state.images_dir || '';
        STATE.sourceImages = state.source_images || [];
        document.getElementById('enginePath').textContent = STATE.engineDir || 'Not detected — click Browse';
        document.getElementById('bsPath').textContent = STATE.bsDir || '—';
        await refreshPathChecks();
        await refreshSourceImageState();
    } catch(e) {}

    // If required setup checks already pass, skip wizard.
    const ready = pathChecksReady(STATE.pathChecks);
    if (ready && !forceWizard) {
        STATE.setupMode = false;
        STATE.setupComplete = true;
        document.body.classList.add('setup-done');
        enterWorkspaceMode(false); // no animation, instant
        return;
    }
    if (ready && forceWizard) {
        // Still play through the full wizard visually so the user can see each step
    }

    // Enter setup mode — remove setup-done so wizard elements become visible again
    STATE.setupMode = true;
    STATE.setupComplete = false;
    document.body.classList.remove('setup-done');
    document.body.classList.add('setup-mode');

    // DON'T call updateSteps() here — it would use real STATE values
    // and jump the connector/cards ahead. setWizardStep(0) inside
    // runAutoDetect() handles the initial visual state.

    // Ensure connector is fully hidden before wizard starts
    const fillEl = document.getElementById('connectorFill');
    if (fillEl) {
        fillEl.style.transition = 'none';
        fillEl.style.width = '0%';
        fillEl.style.display = 'none';
    }
    const stepsConn = document.querySelector('.steps-connector');
    if (stepsConn) stepsConn.style.display = 'none';

    // Set all cards to waiting state initially
    for (let i = 0; i < 5; i++) {
        const card = document.getElementById('step' + i);
        if (card) {
            card.className = 'step-card waiting';
            card.querySelector('.step-time').textContent = '';
        }
    }

    // Run auto-detect sequence (plays through visually step by step)
    await runAutoDetect();
}

// Force visual step state during wizard — independent of STATE-based updateSteps()
function setWizardStep(stepIndex) {
    for (let i = 0; i < 5; i++) {
        const card = document.getElementById('step' + i);
        if (!card) continue;
        card.className = 'step-card';
        if (i < stepIndex) {
            card.classList.add('completed');
            card.querySelector('.step-time').textContent = 'Complete';
        } else if (i === stepIndex) {
            card.classList.add('current');
            card.querySelector('.step-time').textContent = '';
        } else {
            card.classList.add('waiting');
            card.querySelector('.step-time').textContent = '';
        }
    }

    // Connector: green line reaches from card 0 up to the current active card.
    // 5 cards → 4 gaps, so divide by 4 to get percentage.
    const connector = document.querySelector('.steps-connector');
    const fillEl = document.getElementById('connectorFill');

    if (stepIndex <= 0) {
        if (connector) connector.style.display = 'none';
        if (fillEl) {
            fillEl.style.transition = 'none';
            fillEl.style.width = '0%';
            fillEl.style.display = 'none';
        }
    } else {
        if (connector) connector.style.display = 'block';
        if (fillEl) {
            fillEl.style.display = 'block';
            fillEl.style.transition = 'width 0.4s ease';
            const fillPct = (stepIndex / 4) * 100;
            fillEl.style.width = fillPct + '%';
        }
    }
}

async function runAutoDetect() {
    // Step 0: BlueStacks Setup — check install & version
    setWizardStep(0);
    const s0 = document.getElementById('step0Status');
    s0.classList.remove('is-checklist');
    s0.innerHTML = '<span class="spinner"></span> Checking BlueStacks...';
    await sleep(150);

    let bsCheck;
    try {
        bsCheck = await pywebview.api.check_bluestacks();
    } catch(e) {
        s0.innerHTML = '<span class="status-fail">✗</span> Check failed: ' + escapeHtml(String(e));
        return;
    }

    // Track whether this will be a reinstall (for doWizardInstall)
    STATE._bsNeedsReinstall = false;

    if (bsCheck.installed && bsCheck.version_ok) {
        s0.innerHTML = '<span class="status-ok">✓</span> v' + escapeHtml(bsCheck.version) + ' installed';
    } else if (bsCheck.installed && !bsCheck.version_ok) {
        s0.innerHTML = '<span class="status-fail">✗</span> v' + escapeHtml(bsCheck.version) +
            ' found<br>Need v' + escapeHtml(bsCheck.required_version);
        STATE._bsNeedsReinstall = true;
        const installBtn = document.getElementById('step0InstallBtn');
        if (installBtn) installBtn.querySelector('.step-split-label').textContent = 'Reinstall';
        document.getElementById('step0Actions').style.display = '';
        return;
    } else {
        s0.innerHTML = '<span class="status-fail">✗</span> BlueStacks not installed';
        const installBtn = document.getElementById('step0InstallBtn');
        if (installBtn) installBtn.querySelector('.step-split-label').textContent = 'Install';
        document.getElementById('step0Actions').style.display = '';
        return;
    }

    // Step 1: Verify paths — highlight card 1
    setWizardStep(1);
    const s1 = document.getElementById('step1Status');
    s1.classList.remove('is-checklist');
    s1.innerHTML = '<span class="spinner"></span> Verifying configuration...';
    await sleep(150);

    await refreshPathChecks();
    let checks = STATE.pathChecks;

    // If Engine dir missing (fresh install), launch BS once to let it fully initialize.
    // This takes 30-60 seconds because BS needs to write its complete config file.
    // Killing it too early leaves bluestacks.conf incomplete → "Failed to read configuration file".
    if (checks && !checks.engine_exists && bsCheck.installed) {
        s1.innerHTML = '<span class="spinner"></span> Initializing BlueStacks (first launch — this may take up to a minute)...';
        try {
            const dirResult = await pywebview.api.ensure_bluestacks_dirs();
            if (dirResult && dirResult.created) {
                // Re-check paths after dir creation
                await refreshPathChecks();
                checks = STATE.pathChecks;
            }
            if (dirResult && dirResult.detail) {
                appendLog('[Init] ' + dirResult.detail);
            }
        } catch(e) {
            // Continue anyway — pathChecksReady will catch it
        }
    }

    if (pathChecksReady(checks)) {
        const found = ['Engine', 'BlueStacks', 'Config', 'ADB'].join(', ');
        s1.innerHTML = '<span class="status-ok">✓</span> Found:<br>' + found;
    } else {
        const missing = [];
        if (!checks || !checks.engine_exists) missing.push('Engine');
        if (!checks || !checks.bs_exists) missing.push('BlueStacks');
        if (!checks || !checks.conf_exists) missing.push('Config');
        if (!checks || !checks.adb_exists) missing.push('ADB');
        s1.innerHTML = '<span class="status-fail">✗</span> Missing:<br>' + missing.join(', ');
        document.getElementById('step1Actions').style.display = '';
        return;
    }

    // Step 2: Root BlueStacks — highlight card 2
    setWizardStep(2);
    const s2 = document.getElementById('step2Status');
    s2.classList.remove('is-checklist');
    s2.innerHTML = '<span class="spinner"></span> Checking root status...';
    await sleep(150);

    try {
        const rootResult = await pywebview.api.check_root_status();
        if (rootResult && rootResult.rooted) {
            s2.innerHTML = '<span class="status-ok">✓</span> Already rooted';
            STATE.rooted = true;
        } else {
            s2.innerHTML = '';
            // Show "Root Now" button
            document.getElementById('step2Actions').style.display = '';
            return; // Pause — doWizardRoot() will resume
        }
    } catch(e) {
        s2.innerHTML = '';
        document.getElementById('step2Actions').style.display = '';
        return;
    }

    // Step 3: Source image — highlight card 3
    setWizardStep(3);
    const s3 = document.getElementById('step3Status');
    s3.classList.remove('is-checklist');
    s3.innerHTML = '<span class="spinner"></span> Checking for source images...';
    await sleep(150);

    await refreshSourceImageState();
    if (!STATE.imageDownloaded) {
        s3.innerHTML = '';
        // Show download / own source split buttons
        document.getElementById('step3Actions').style.display = '';
        return; // Pause — doWizardDownload() or bypassWizardImage() will resume
    }
    await refreshSourceImages();
    const completeImages = (STATE.sourceImages || []).filter(i => i.complete);
    if (completeImages.length > 0) {
        const names = completeImages.map(i => i.name).join(', ');
        s3.innerHTML = '<span class="status-ok">✓</span> Found: ' + names;
        STATE.selectedSourceImage = completeImages[0];
    } else {
        s3.innerHTML = '<span class="status-ok">✓</span> Image ready';
    }

    // Step 4: Permissions — highlight card 4, show button
    setWizardStep(4);
    const s4 = document.getElementById('step4Status');
    s4.classList.remove('is-checklist');
    s4.innerHTML = '';
    document.getElementById('step4Actions').style.display = '';
    // Wait for user to click "Fix Permissions" button
    return;
}

function renderPermChecklist(result) {
    if (!result) return '<span class="status-fail">✗</span> Unable to check permissions';
    const rows = [];
    if (result.conf_unlocked !== undefined) {
        rows.push(renderSetupCheck(
            'bluestacks.conf writable',
            result.conf_unlocked,
            result.conf_unlocked ? 'uchg flag cleared' : 'Needs password'
        ));
    }
    if (result.conf_locked !== undefined) {
        const lockOk = result.conf_locked || result.conf_lock_skipped;
        const lockDetail = result.conf_locked ? 'uchg flag restored'
            : result.conf_lock_skipped ? 'Skipped (fresh install)'
            : 'Could not re-lock';
        rows.push(renderSetupCheck(
            'bluestacks.conf re-locked',
            lockOk,
            lockDetail
        ));
    }
    if (result.auto_updates_disabled !== undefined) {
        rows.push(renderSetupCheck(
            'Auto-updates disabled',
            result.auto_updates_disabled,
            result.auto_updates_disabled ? 'Config keys set' : 'Could not set'
        ));
    }
    if (result.checker_root !== undefined) {
        rows.push(renderSetupCheck(
            'Checker root access',
            result.checker_root,
            result.checker_root_detail || (result.checker_root ? 'Granted' : 'No running instance')
        ));
    }
    const allOk = rows.length > 0 && result.conf_unlocked && (result.conf_locked || result.conf_lock_skipped);
    const summary = allOk ? 'Permissions configured' : 'Some permissions need attention';
    return '<div class="step-check-summary ' + (allOk ? 'ok' : 'fail') + '">' + summary + '</div>'
        + '<div class="step-checks">' + rows.join('') + '</div>';
}

// Permissions handler
async function doWizardPermissions() {
    const s4 = document.getElementById('step4Status');
    const actions = document.getElementById('step4Actions');
    const btn = document.getElementById('step4FixBtn');

    btn.disabled = true;
    actions.style.display = 'none';

    const shieldD = 'M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z';

    s4.innerHTML =
        '<div class="perm-anim-wrap">' +
            '<div class="perm-anim-icon">' +
                '<svg class="perm-shield-svg" id="permShield" width="20" height="20" viewBox="0 0 24 24">' +
                    '<path class="perm-shield-rail" d="' + shieldD + '"/>' +
                    '<path class="perm-shield-trace" id="permTrace" d="' + shieldD + '"/>' +
                '</svg>' +
                '<svg class="perm-check-svg" id="permCheck" width="20" height="20" viewBox="0 0 24 24">' +
                    '<polyline class="perm-check-line" id="permCheckLine" points="6 13 10 17 18 8"/>' +
                '</svg>' +
            '</div>' +
            '<div class="perm-anim-label" id="permLabel">Verifying Permissions<br>& Establishing Root</div>' +
        '</div>';

    // Measure path length, set dasharray, kick off looping animation
    const trace = document.getElementById('permTrace');
    const checkLine = document.getElementById('permCheckLine');

    if (trace) {
        const pathLen = trace.getTotalLength();
        trace.style.strokeDasharray = String(pathLen);
        trace.style.strokeDashoffset = String(pathLen);
        trace.style.setProperty('--path-len', String(pathLen));
        trace.getBoundingClientRect();
        trace.classList.add('animating');
    }

    if (checkLine) {
        const checkLen = checkLine.getTotalLength();
        checkLine.style.strokeDasharray = String(checkLen);
        checkLine.style.strokeDashoffset = String(checkLen);
        checkLine.style.setProperty('--check-len', String(checkLen));
    }

    // Fire off actual work in parallel
    const permPromise = (async () => {
        try {
            return await pywebview.api.fix_permissions(STATE.engineDir);
        } catch(e) {
            return { error: String(e) };
        }
    })();

    // Wait for both API and minimum 6s animation
    const [permResult] = await Promise.all([permPromise, sleep(6000)]);

    // Stop the loop — freeze trace at current position
    if (trace) trace.classList.remove('animating');

    // Fade out shield (opacity only, no scaling)
    const shieldSvg = document.getElementById('permShield');
    if (shieldSvg) shieldSvg.classList.add('hiding');
    await sleep(550);

    // Fade in checkmark and draw it
    const checkSvg = document.getElementById('permCheck');
    if (checkSvg) checkSvg.classList.add('visible');
    if (checkLine) checkLine.classList.add('drawing');

    // Swap label
    const permLabelEl = document.getElementById('permLabel');
    if (permLabelEl) {
        permLabelEl.style.opacity = '0';
        await sleep(300);
        // Check success: must have unlocked+relocked conf (host-side is the hard requirement)
        // Device-side (magisk settings, root policies) is best-effort — may not have a running instance
        const permOk = permResult && !permResult.error && permResult.conf_unlocked && (permResult.conf_locked || permResult.conf_lock_skipped);
        if (permOk) {
            permLabelEl.innerHTML = 'Permissions &amp; Root<br>Established';
        } else if (permResult && permResult.error) {
            permLabelEl.innerHTML = escapeHtml(permResult.error);
        } else {
            permLabelEl.innerHTML = 'Some permissions could not be set<br>Try again';
        }
        permLabelEl.style.opacity = '1';
    }

    const permOk = permResult && !permResult.error && permResult.conf_unlocked && (permResult.conf_locked || permResult.conf_lock_skipped);
    if (permOk) {
        STATE.permissionsOk = true;
        await sleep(1500);
        await completeSetupWizard();
    } else {
        // Re-show actions and re-enable button so user can retry
        await sleep(1500);
        actions.style.display = '';
        btn.disabled = false;
        btn.querySelector('.step-split-label').textContent = 'Retry';
        if (permResult) {
            if (permResult.error) {
                appendLog('[Error] Permissions: ' + permResult.error);
            } else if (!permResult.conf_unlocked) {
                appendLog('[Error] Could not unlock bluestacks.conf — admin password required');
            } else if (!permResult.conf_locked && !permResult.conf_lock_skipped) {
                appendLog('[Error] Could not re-lock bluestacks.conf');
            }
        }
    }
}

// Manual disable-auto-updates action (Lock Updates card)
async function doDisableAutoUpdates() {
    if (!STATE.engineDir) { appendLog('[Error] Engine directory not set'); return; }
    appendLog('Disabling BlueStacks auto-updates...');
    try {
        const result = await pywebview.api.disable_auto_updates(STATE.engineDir);
        if (result && !result.error) {
            appendLog('[OK] Auto-updates disabled: ' + (result.detail || 'Success'));
        } else {
            appendLog('[Error] ' + (result ? result.error || result.detail : 'Unknown error'));
        }
    } catch (e) {
        appendLog('[Error] ' + String(e));
    }
}

// BlueStacks install handler
async function doWizardInstall() {
    const s0 = document.getElementById('step0Status');
    const actions = document.getElementById('step0Actions');
    const btn = document.getElementById('step0InstallBtn');
    const label = btn.querySelector('.step-split-label');
    const progressBar = btn.querySelector('.dl-btn-progress');
    const isReinstall = !!STATE._bsNeedsReinstall;

    btn.disabled = true;
    label.textContent = isReinstall ? 'Reinstalling...' : 'Installing...';
    s0.innerHTML = '';

    // Shield animation
    const shieldD = 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3';
    s0.innerHTML =
        '<div class="perm-anim-wrap">' +
            '<div class="perm-anim-icon">' +
                '<svg class="perm-shield-svg" id="installShield" width="20" height="20" viewBox="0 0 24 24">' +
                    '<path class="perm-shield-rail" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>' +
                    '<path class="perm-shield-trace" id="installTrace" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>' +
                '</svg>' +
                '<svg class="perm-check-svg" id="installCheck" width="20" height="20" viewBox="0 0 24 24">' +
                    '<polyline class="perm-check-line" id="installCheckLine" points="6 13 10 17 18 8"/>' +
                '</svg>' +
            '</div>' +
            '<div class="perm-anim-label" id="installLabel">Downloading &amp; Installing<br>BlueStacks v5.21</div>' +
        '</div>';

    const trace = document.getElementById('installTrace');
    const checkLine = document.getElementById('installCheckLine');
    if (trace) {
        const pathLen = trace.getTotalLength();
        trace.style.strokeDasharray = String(pathLen);
        trace.style.strokeDashoffset = String(pathLen);
        trace.style.setProperty('--path-len', String(pathLen));
        trace.getBoundingClientRect();
        trace.classList.add('animating');
    }
    if (checkLine) {
        const checkLen = checkLine.getTotalLength();
        checkLine.style.strokeDasharray = String(checkLen);
        checkLine.style.strokeDashoffset = String(checkLen);
        checkLine.style.setProperty('--check-len', String(checkLen));
    }

    // Register live progress callback
    const installLabelEl = document.getElementById('installLabel');
    window._onBsInstallProgress = function(data) {
        if (!installLabelEl) return;
        const phase = data.phase || '';
        const detail = data.detail || '';
        const pct = data.pct;

        let display = '';
        if (phase === 'download' && pct >= 0) {
            display = 'Downloading BlueStacks<br>' + pct + '%';
            if (progressBar) progressBar.style.width = pct + '%';
        } else if (phase === 'install') {
            display = 'Installing BlueStacks...<br>Admin password required';
            if (progressBar) progressBar.style.width = '100%';
        } else if (phase === 'verify') {
            display = 'Verifying installation...';
        } else if (phase === 'uninstall') {
            display = 'Removing old version...';
        } else if (phase === 'kill') {
            display = 'Stopping BlueStacks...';
        } else if (phase === 'done') {
            display = 'Installation complete!';
        } else {
            display = escapeHtml(detail.substring(0, 80));
        }
        installLabelEl.innerHTML = display;
    };

    // Fire off actual install
    const installPromise = (async () => {
        try {
            return await pywebview.api.install_bluestacks(isReinstall);
        } catch(e) {
            return { success: false, output: String(e), phase: 'error' };
        }
    })();

    const [installResult] = await Promise.all([installPromise, sleep(4000)]);

    // Cleanup callback
    window._onBsInstallProgress = null;

    // Stop animation
    if (trace) trace.classList.remove('animating');

    const shieldSvg = document.getElementById('installShield');
    if (shieldSvg) shieldSvg.classList.add('hiding');
    await sleep(550);

    const checkSvg = document.getElementById('installCheck');
    if (checkSvg) checkSvg.classList.add('visible');
    if (checkLine) checkLine.classList.add('drawing');

    if (installLabelEl) {
        installLabelEl.style.opacity = '0';
        await sleep(300);
        if (installResult && installResult.success) {
            installLabelEl.innerHTML = 'BlueStacks Installed<br>v5.21.755.7538';
        } else {
            const errMsg = (installResult && installResult.output) ? installResult.output : 'Installation failed';
            installLabelEl.innerHTML = escapeHtml(errMsg.substring(0, 120));
        }
        installLabelEl.style.opacity = '1';
    }

    if (installResult && installResult.success) {
        actions.style.display = 'none';
        await sleep(1500);

        // Continue wizard from step 1 (Verify Paths)
        setWizardStep(1);
        const s1 = document.getElementById('step1Status');
        s1.classList.remove('is-checklist');
        s1.innerHTML = '<span class="spinner"></span> Verifying configuration...';
        await sleep(150);

        // Fresh install — need to launch BS once for full initialization
        s1.innerHTML = '<span class="spinner"></span> Initializing BlueStacks (first launch — this may take up to a minute)...';
        try {
            const dirResult = await pywebview.api.ensure_bluestacks_dirs();
            if (dirResult && dirResult.detail) appendLog('[Init] ' + dirResult.detail);
        } catch(e) { /* continue anyway */ }

        await refreshPathChecks();
        const checks = STATE.pathChecks;

        if (pathChecksReady(checks)) {
            s1.innerHTML = '<span class="status-ok">✓</span> Found:<br>Engine, BlueStacks, Config, ADB';
        } else {
            const missing = [];
            if (!checks || !checks.engine_exists) missing.push('Engine');
            if (!checks || !checks.bs_exists) missing.push('BlueStacks');
            if (!checks || !checks.conf_exists) missing.push('Config');
            if (!checks || !checks.adb_exists) missing.push('ADB');
            s1.innerHTML = '<span class="status-fail">✗</span> Missing:<br>' + missing.join(', ');
            document.getElementById('step1Actions').style.display = '';
            return;
        }

        // Continue to step 2: Root
        setWizardStep(2);
        const s2 = document.getElementById('step2Status');
        s2.classList.remove('is-checklist');
        s2.innerHTML = '<span class="spinner"></span> Checking root status...';
        await sleep(150);

        try {
            const rootResult = await pywebview.api.check_root_status();
            if (rootResult && rootResult.rooted) {
                s2.innerHTML = '<span class="status-ok">✓</span> Already rooted';
                STATE.rooted = true;
            } else {
                s2.innerHTML = '';
                document.getElementById('step2Actions').style.display = '';
                return;
            }
        } catch(e) {
            s2.innerHTML = '';
            document.getElementById('step2Actions').style.display = '';
            return;
        }

        // Continue to step 3: Download Image
        setWizardStep(3);
        const s3 = document.getElementById('step3Status');
        s3.classList.remove('is-checklist');
        s3.innerHTML = '<span class="spinner"></span> Checking for source images...';
        await sleep(150);

        await refreshSourceImageState();
        if (!STATE.imageDownloaded) {
            s3.innerHTML = '';
            document.getElementById('step3Actions').style.display = '';
            return;
        }
        await refreshSourceImages();
        const completeImages = (STATE.sourceImages || []).filter(i => i.complete);
        if (completeImages.length > 0) {
            s3.innerHTML = '<span class="status-ok">✓</span> Found: ' + completeImages.map(i => i.name).join(', ');
            STATE.selectedSourceImage = completeImages[0];
        } else {
            s3.innerHTML = '<span class="status-ok">✓</span> Image ready';
        }

        // Continue to step 4: Permissions
        setWizardStep(4);
        const s4 = document.getElementById('step4Status');
        s4.classList.remove('is-checklist');
        s4.innerHTML = '';
        document.getElementById('step4Actions').style.display = '';
    } else {
        // Install failed — let user retry
        await sleep(1500);
        btn.disabled = false;
        label.textContent = isReinstall ? 'Retry Reinstall' : 'Retry Install';
        actions.style.display = '';
        if (installResult && installResult.output) {
            appendLog('[Error] BlueStacks install failed: ' + installResult.output);
        }
    }
}

// Retry paths handler
async function doWizardRetryPaths() {
    const s1 = document.getElementById('step1Status');
    const actions = document.getElementById('step1Actions');
    const btn = document.getElementById('step1RetryBtn');
    btn.disabled = true;
    actions.style.display = 'none';
    s1.innerHTML = '<span class="spinner"></span> Re-checking paths...';

    // Try to ensure dirs again if BS is installed
    try {
        const bsCheck = await pywebview.api.check_bluestacks();
        if (bsCheck && bsCheck.installed) {
            await pywebview.api.ensure_bluestacks_dirs();
        }
    } catch(e) { /* continue to re-check */ }

    await refreshPathChecks();
    const checks = STATE.pathChecks;

    if (pathChecksReady(checks)) {
        const found = ['Engine', 'BlueStacks', 'Config', 'ADB'].join(', ');
        s1.innerHTML = '<span class="status-ok">✓</span> Found:<br>' + found;
        btn.disabled = false;
        await sleep(300);

        // Continue wizard from step 2 onward
        setWizardStep(2);
        const s2 = document.getElementById('step2Status');
        s2.classList.remove('is-checklist');
        s2.innerHTML = '<span class="spinner"></span> Checking root status...';
        await sleep(150);
        try {
            const rootResult = await pywebview.api.check_root_status();
            if (rootResult && rootResult.rooted) {
                s2.innerHTML = '<span class="status-ok">✓</span> Already rooted';
                STATE.rooted = true;
            } else {
                s2.innerHTML = '';
                document.getElementById('step2Actions').style.display = '';
                return;
            }
        } catch(e) {
            s2.innerHTML = '';
            document.getElementById('step2Actions').style.display = '';
            return;
        }
        // Continue steps 3-4 same as runAutoDetect
        setWizardStep(3);
        const s3 = document.getElementById('step3Status');
        s3.classList.remove('is-checklist');
        s3.innerHTML = '<span class="spinner"></span> Checking for source images...';
        await sleep(150);
        await refreshSourceImageState();
        if (!STATE.imageDownloaded) {
            s3.innerHTML = '';
            document.getElementById('step3Actions').style.display = '';
            return;
        }
        s3.innerHTML = '<span class="status-ok">✓</span> Image ready';
        setWizardStep(4);
        document.getElementById('step4Status').innerHTML = '';
        document.getElementById('step4Actions').style.display = '';
    } else {
        const missing = [];
        if (!checks || !checks.engine_exists) missing.push('Engine');
        if (!checks || !checks.bs_exists) missing.push('BlueStacks');
        if (!checks || !checks.conf_exists) missing.push('Config');
        if (!checks || !checks.adb_exists) missing.push('ADB');
        s1.innerHTML = '<span class="status-fail">✗</span> Still missing:<br>' + missing.join(', ');
        btn.disabled = false;
        actions.style.display = '';
    }
}

// Root handler
async function doWizardRoot() {
    const s2 = document.getElementById('step2Status');
    const actions = document.getElementById('step2Actions');
    const btn = document.getElementById('step2RootBtn');
    const label = btn.querySelector('.step-split-label');

    btn.disabled = true;
    label.textContent = 'Rooting...';
    s2.innerHTML = '';

    // Shield trace animation (same style as permissions)
    const shieldD = 'M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z';
    s2.innerHTML =
        '<div class="perm-anim-wrap">' +
            '<div class="perm-anim-icon">' +
                '<svg class="perm-shield-svg" id="rootShield" width="20" height="20" viewBox="0 0 24 24">' +
                    '<path class="perm-shield-rail" d="' + shieldD + '"/>' +
                    '<path class="perm-shield-trace" id="rootTrace" d="' + shieldD + '"/>' +
                '</svg>' +
                '<svg class="perm-check-svg" id="rootCheck" width="20" height="20" viewBox="0 0 24 24">' +
                    '<polyline class="perm-check-line" id="rootCheckLine" points="6 13 10 17 18 8"/>' +
                '</svg>' +
            '</div>' +
            '<div class="perm-anim-label" id="rootLabel">Closing BlueStacks<br>& Patching Boot Image</div>' +
        '</div>';

    const trace = document.getElementById('rootTrace');
    const checkLine = document.getElementById('rootCheckLine');
    if (trace) {
        const pathLen = trace.getTotalLength();
        trace.style.strokeDasharray = String(pathLen);
        trace.style.strokeDashoffset = String(pathLen);
        trace.style.setProperty('--path-len', String(pathLen));
        trace.getBoundingClientRect();
        trace.classList.add('animating');
    }
    if (checkLine) {
        const checkLen = checkLine.getTotalLength();
        checkLine.style.strokeDasharray = String(checkLen);
        checkLine.style.strokeDashoffset = String(checkLen);
        checkLine.style.setProperty('--check-len', String(checkLen));
    }

    // Fire off actual rooting in parallel with min animation time
    const rootPromise = (async () => {
        try {
            return await pywebview.api.root_bluestacks();
        } catch(e) {
            return { success: false, output: String(e) };
        }
    })();

    const [rootResult] = await Promise.all([rootPromise, sleep(6000)]);

    // Stop the loop
    if (trace) trace.classList.remove('animating');

    // Fade out shield
    const shieldSvg = document.getElementById('rootShield');
    if (shieldSvg) shieldSvg.classList.add('hiding');
    await sleep(550);

    // Fade in checkmark and draw it
    const checkSvg = document.getElementById('rootCheck');
    if (checkSvg) checkSvg.classList.add('visible');
    if (checkLine) checkLine.classList.add('drawing');

    // Swap label
    const rootLabelEl = document.getElementById('rootLabel');
    if (rootLabelEl) {
        rootLabelEl.style.opacity = '0';
        await sleep(300);
        if (rootResult && rootResult.success) {
            rootLabelEl.innerHTML = 'Magisk Installed<br>Root Established';
        } else {
            const errMsg = (rootResult && rootResult.output) ? rootResult.output : 'Rooting failed';
            rootLabelEl.innerHTML = escapeHtml(errMsg.substring(0, 120));
        }
        rootLabelEl.style.opacity = '1';
    }

    if (rootResult && rootResult.success) {
        STATE.rooted = true;
        actions.style.display = 'none';
        await sleep(1500);

        // Continue to step 3: Download Image
        setWizardStep(3);
        const s3 = document.getElementById('step3Status');
        s3.classList.remove('is-checklist');
        s3.innerHTML = '<span class="spinner"></span> Checking for source images...';
        await sleep(150);

        await refreshSourceImageState();
        if (!STATE.imageDownloaded) {
            s3.innerHTML = '';
            document.getElementById('step3Actions').style.display = '';
            return;
        }
        await refreshSourceImages();
        const completeImages = (STATE.sourceImages || []).filter(i => i.complete);
        if (completeImages.length > 0) {
            const names = completeImages.map(i => i.name).join(', ');
            s3.innerHTML = '<span class="status-ok">✓</span> Found: ' + names;
            STATE.selectedSourceImage = completeImages[0];
        } else {
            s3.innerHTML = '<span class="status-ok">✓</span> Image ready';
        }

        // Continue to step 4: Permissions
        setWizardStep(4);
        const s4 = document.getElementById('step4Status');
        s4.classList.remove('is-checklist');
        s4.innerHTML = '';
        document.getElementById('step4Actions').style.display = '';
    } else {
        // Rooting failed — let user retry
        await sleep(1500);
        btn.disabled = false;
        label.textContent = 'Retry';
        actions.style.display = '';
        if (rootResult && rootResult.output) {
            appendLog('[Error] Rooting failed: ' + rootResult.output);
        }
    }
}

// Download handler
async function doWizardDownload() {
    const s3 = document.getElementById('step3Status');
    const actions = document.getElementById('step3Actions');
    const btn = document.getElementById('step3DlBtn');
    const label = btn.querySelector('.step-split-label');
    const progressBar = btn.querySelector('.dl-btn-progress');

    btn.disabled = true;
    document.getElementById('step3Bypass').disabled = true;
    label.textContent = '0%';
    s3.innerHTML = '<span class="spinner"></span> Downloading base image...';

    progressBar.style.transition = 'none';
    progressBar.style.width = '0%';

    let success = false;
    let skipped = false;
    let errorText = '';
    let lastPct = 0;

    // Set up completion listener BEFORE calling API
    let downloadResolve;
    const downloadDone = new Promise(r => { downloadResolve = r; });
    const origDone = window.onOperationDone;
    window.onOperationDone = function(op) {
        if (op === 'download') downloadResolve();
        else if (origDone) origDone(op);
    };

    // Hook into real download progress from Python backend
    const origProgress = window.onDownloadProgress;
    window.onDownloadProgress = function(pct, status) {
        if (pct >= 0 && pct <= 100) {
            lastPct = pct;
            progressBar.style.transition = 'width 0.3s ease';
            progressBar.style.width = pct + '%';
            label.textContent = pct + '%';
            if (status === 'downloading') {
                s3.innerHTML = '<span class="spinner"></span> Downloading... ' + pct + '%';
            } else if (status === 'extracting') {
                s3.innerHTML = '<span class="spinner"></span> Extracting...';
                label.textContent = 'Extracting';
            } else if (status === 'complete' || status === 'done') {
                s3.innerHTML = '<span class="spinner"></span> Finishing...';
                label.textContent = '100%';
            }
        } else if (pct < 0) {
            errorText = status || 'Download failed';
            s3.innerHTML = '<span class="status-fail">✗</span> ' + escapeHtml(errorText);
        }
        if (origProgress) origProgress(pct, status);
    };

    try {
        const result = await pywebview.api.download_image(STATE.engineDir, 'a13');
        if (result && result.skipped) {
            skipped = true;
            success = true;
        } else if (result && result.error) {
            errorText = String(result.error);
        } else {
            // download_image() returned OK — wait for background thread to finish
            s3.innerHTML = '<span class="spinner"></span> Downloading... 0%';
            await downloadDone;
            success = !errorText;
        }
    } catch(e) {
        errorText = String(e);
    }

    // Always restore original handlers
    window.onDownloadProgress = origProgress;
    window.onOperationDone = origDone;

    await refreshSourceImages();

    if (success) {
        STATE.imageDownloaded = true;

        progressBar.style.transition = 'width 0.3s ease';
        progressBar.style.width = '100%';
        label.textContent = '100%';
        await sleep(350);

        // Hide the split cards
        actions.style.transition = 'opacity 0.3s ease';
        actions.style.opacity = '0';
        await sleep(300);
        actions.style.display = 'none';
        actions.style.opacity = '';
        actions.style.transition = '';

        // Reset for re-use
        label.textContent = 'Download';
        progressBar.style.width = '0%';
        btn.disabled = false;
        document.getElementById('step3Bypass').disabled = false;

        if (skipped) {
            s3.innerHTML = '<span class="status-ok">✓</span><br>Place image manually';
            appendLog('[Setup] No download URL configured — place golden image in images/ directory');
        } else {
            s3.innerHTML = '<span class="status-ok">✓</span><br>Image Downloaded';
        }
        await sleep(400);
        // Continue to step 4: Permissions
        setWizardStep(4);
        const s4dl = document.getElementById('step4Status');
        s4dl.classList.remove('is-checklist');
        s4dl.innerHTML = '';
        document.getElementById('step4Actions').style.display = '';
    } else {
        progressBar.style.width = '0%';
        label.textContent = 'Retry';
        btn.disabled = false;
        document.getElementById('step3Bypass').disabled = false;
        s3.innerHTML = '<span class="status-fail">✗</span> Download failed';
        if (errorText) {
            appendLog('[Error] Download failed: ' + errorText);
        }
    }
}

async function bypassWizardImage() {
    const s3 = document.getElementById('step3Status');
    const actions = document.getElementById('step3Actions');

    actions.style.transition = 'opacity 0.3s ease';
    actions.style.opacity = '0';
    await sleep(300);
    actions.style.display = 'none';
    actions.style.opacity = '';
    actions.style.transition = '';

    s3.innerHTML = '<span class="status-ok">✓</span><br>Own Source';
    STATE.imageDownloaded = true;
    await sleep(400);
    // Continue to step 4: Permissions
    setWizardStep(4);
    const s4bp = document.getElementById('step4Status');
    s4bp.classList.remove('is-checklist');
    s4bp.innerHTML = '';
    document.getElementById('step4Actions').style.display = '';
}

async function completeSetupWizard() {
    // Fade out entire setup scene (hero + steps + everything in setup mode)
    const setupHero = document.getElementById('setupHero');
    const wrapper = document.querySelector('.steps-wrapper');
    const label = document.querySelector('.steps-label');
    const hint = document.getElementById('setupHint');
    const allSetup = [setupHero, wrapper, label, hint].filter(Boolean);

    allSetup.forEach(el => {
        el.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        el.style.opacity = '0';
        el.style.transform = 'translateY(-16px)';
    });

    await sleep(420);

    // 3. Switch to workspace mode
    STATE.setupMode = false;
    STATE.setupComplete = true;
    document.body.classList.remove('setup-mode');
    document.body.classList.add('setup-done');

    // Clean up inline styles
    allSetup.forEach(el => {
        el.style.transition = '';
        el.style.opacity = '';
        el.style.transform = '';
    });

    // 4. Start workspace elements hidden, then fade them in
    const workspaceEls = [
        document.querySelector('.header'),
        document.querySelector('.tabs'),
        document.querySelector('.page-title-strip'),
        document.querySelector('.content'),
        document.querySelector('.divider'),
        document.querySelector('.footer'),
    ].filter(Boolean);

    workspaceEls.forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(12px)';
    });

    enterWorkspaceMode(false); // no built-in animation — we do it manually

    // Trigger reflow then animate in
    await sleep(30);
    workspaceEls.forEach((el, i) => {
        el.style.transition = `opacity 0.45s ease ${i * 0.06}s, transform 0.45s ease ${i * 0.06}s`;
        el.style.opacity = '1';
        el.style.transform = 'translateY(0)';
    });

    // Clean up after animation
    await sleep(600);
    workspaceEls.forEach(el => {
        el.style.transition = '';
        el.style.opacity = '';
        el.style.transform = '';
    });

    if (STATE.setupComplete) {
        showToast('Setup complete — ready to clone', 'success', 3000);
        // Auto-run diagnostics in background so we have debug info if launch fails
        runDiagnostics(true);
    }
}

async function runDiagnostics(quiet) {
    try {
        const diag = await pywebview.api.diagnose_launch_readiness(STATE.engineDir);
        if (!diag) return;

        const lines = [];
        lines.push('─── Launch Diagnostics ───');
        lines.push('Overall: ' + diag.overall);
        if (diag.issues && diag.issues.length > 0) {
            diag.issues.forEach(function(issue) { lines.push('  ⚠ ' + issue); });
        }
        // Config
        if (diag.conf) {
            lines.push('Config: ' + (diag.conf.exists ? diag.conf.size_human + ', ' + diag.conf.line_count + ' lines' : 'MISSING'));
            if (diag.conf.has_installed_images !== undefined)
                lines.push('  installed_images: ' + (diag.conf.installed_images || 'not found'));
            if (diag.conf.instance_blocks)
                lines.push('  instance blocks: ' + diag.conf.instance_blocks.join(', '));
            if (diag.conf.has_uchg) lines.push('  ⚠ uchg flag is SET');
            if (diag.conf.format_bad_lines > 0)
                lines.push('  ⚠ ' + diag.conf.format_bad_lines + ' malformed lines');
        }
        // Initrd
        if (diag.initrd) {
            lines.push('Initrd: ' + (diag.initrd.exists ? diag.initrd.size_human + (diag.initrd.is_gzip ? ' (valid gzip)' : ' (NOT gzip!)') : 'MISSING'));
        }
        // Instances
        if (diag.instances && diag.instances.length > 0) {
            lines.push('Instances:');
            diag.instances.forEach(function(inst) {
                lines.push('  ' + inst.name + ': ' + (inst.has_data_qcow2 ? inst.data_qcow2_size_human : 'NO data.qcow2'));
            });
        }
        lines.push('──────────────────────');

        lines.forEach(function(l) { appendLog(l); });

        if (!quiet && diag.overall === 'OK') {
            showToast('Diagnostics: all checks passed', 'success', 3000);
        } else if (!quiet && diag.issues && diag.issues.length > 0) {
            showToast('Diagnostics found ' + diag.issues.length + ' issue(s) — check log', 'error', 5000);
        }
    } catch(e) {
        if (!quiet) appendLog('[Diag Error] ' + String(e));
    }
}

function enterWorkspaceMode(animate) {
    // Restore connector to normal CSS-controlled state (undo wizard overrides)
    const connector = document.querySelector('.steps-connector');
    const fillEl = document.getElementById('connectorFill');
    if (connector) connector.style.display = '';
    if (fillEl) {
        fillEl.style.transition = '';
        fillEl.style.display = '';
    }

    // Switch to Cloning tab as default workspace view
    switchTab('advanced');

    // Update all workspace UI
    updateSteps();
    updateHeroStats();
    updateHeroContext();

    // Populate randomize cards if we have data
    if (STATE.randInstances.length > 0) {
        renderRandCards();
        renderIlList();
        utRender();
        showRandCta();
    }

    if (animate) {
        document.querySelector('.tabs')?.classList.add('workspace-reveal');
        document.querySelector('.page-title-strip')?.classList.add('workspace-reveal');
        document.querySelector('.content')?.classList.add('workspace-reveal');
        document.querySelector('.divider')?.classList.add('workspace-reveal');
        document.querySelector('.footer')?.classList.add('workspace-reveal');
    }

    if (STATE.setupComplete && animate) {
        showToast('Setup complete — ready to clone', 'success', 3000);
    }

    // Auto-refresh instances and auto-select running+root ones
    autoRefreshAndSelect();
}

// ── Reset setup (for testing / re-running wizard) ──
async function resetSetup() {
    try { await pywebview.api.reset_settings(); } catch(e) {}
    STATE.engineDir = '';
    STATE.bsDir = '';
    STATE.instances = [];
    STATE.randInstances = [];
    STATE.selectedRand = new Set();
    STATE.setupMode = false;
    STATE.setupComplete = false;
    STATE.imageDownloaded = false;
    STATE.selectedSourceImage = null;
    STATE.permissionsOk = false;
    STATE.rooted = false;
    STATE.prevStep = -1;
    document.body.classList.remove('setup-done');

    // Clear step action status text
    ['step0Status','step1Status','step2Status','step3Status','step4Status'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
    });
    document.getElementById('step0Actions').style.display = 'none';
    document.getElementById('step1Actions').style.display = 'none';
    document.getElementById('step2Actions').style.display = 'none';
    document.getElementById('step3Actions').style.display = 'none';
    document.getElementById('step4Actions').style.display = 'none';
    // Reset install button state
    const installBtn = document.getElementById('step0InstallBtn');
    if (installBtn) {
        installBtn.disabled = false;
        const installLabel = installBtn.querySelector('.step-split-label');
        if (installLabel) installLabel.textContent = 'Install';
    }
    // Reset root button state
    const rootBtn = document.getElementById('step2RootBtn');
    if (rootBtn) {
        rootBtn.disabled = false;
        const rootLabel = rootBtn.querySelector('.step-split-label');
        if (rootLabel) rootLabel.textContent = 'Root Now';
    }
    // Reset permissions button state
    const permBtn = document.getElementById('step4FixBtn');
    if (permBtn) {
        permBtn.disabled = false;
        const permLabel = permBtn.querySelector('.step-split-label');
        if (permLabel) permLabel.textContent = 'Fix Permissions';
    }

    // Clear workspace UI
    document.getElementById('enginePath').textContent = 'Not detected — click Browse';
    document.getElementById('bsPath').textContent = '—';

    // Remove workspace reveal animations
    document.querySelectorAll('.workspace-reveal').forEach(el => el.classList.remove('workspace-reveal'));

    // Re-enter setup wizard (force visual playthrough)
    showToast('Setup reset — restarting wizard', 'info', 2000);
    await sleep(300);
    await initSetupWizard(true);
}

</script>
</body>
</html>
